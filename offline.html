<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ES Wake - é›¢ç·šç·¨è¼¯å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang TC', 'Microsoft JhengHei', 
                'Segoe UI', 'Roboto', 'Noto Sans TC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #213547;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .container.full-width {
            max-width: 100%;
            padding: 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .logo {
            width: 140px;
            height: 140px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .title {
            margin: 0 0 20px 0;
            font-size: 42px;
            font-weight: 800;
            color: #000;
            letter-spacing: 2px;
        }
        
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .title {
                font-size: 32px;
            }
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 35px 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid rgba(224, 224, 224, 0.5);
            text-decoration: none;
            color: #000;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #000;
        }
        
        .menu-icon {
            font-size: 42px;
            margin-bottom: 5px;
        }
        
        .menu-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #000;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .menu-title {
                font-size: 16px;
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: #666;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: center;
        }
        
        .file-input input {
            display: none;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- è³‡æ–™åº«è¼‰å…¥å™¨ -->
        <div id="db-loader" class="modal active">
            <div class="modal-content">
                <div class="modal-title">ğŸ’¾ è¼‰å…¥è³‡æ–™åº«</div>
                <div id="db-alert"></div>
                <div class="file-input-wrapper">
                    <label class="file-input" for="sql-file">
                        <input type="file" id="sql-file" accept=".sql,.txt" style="display: none;">
                        <span>ğŸ“ é»æ“Šé¸æ“‡ SQL å‚™ä»½æª”æ¡ˆ</span>
                    </label>
                    <div id="file-name" style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;"></div>
                </div>
                <button class="btn btn-secondary" onclick="createEmptyDatabase()">ğŸ†• å»ºç«‹ç©ºç™½è³‡æ–™åº«</button>
                <button class="btn btn-secondary" onclick="clearDatabaseAndReload()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
                <div id="db-loading" class="hidden">
                    <div class="spinner"></div>
                    <p style="text-align: center; margin-top: 10px;">è™•ç†ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»é é¢ -->
        <div id="main-content" class="hidden">
            <div class="header">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23000'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-weight='bold'%3EES%3C/text%3E%3C/svg%3E" 
                     alt="ES Wake Logo" class="logo" onerror="this.style.display='none'">
                <h1 class="title">ES WAKE</h1>
            </div>
            
            <div class="menu-grid" id="menu-grid">
                <!-- é¸å–®é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <div class="footer">
                <p>Â© 2025 ES Wake. All Rights Reserved.</p>
                <p style="font-size: 12px; opacity: 0.7; margin-top: 8px;">æ»‘æ°´é ç´„ç®¡ç†ç³»çµ± - é›¢ç·šæ¨¡å¼</p>
            </div>
        </div>
    </div>
    
    <script>
        // å…¨åŸŸè®Šæ•¸ - ä½¿ç”¨ IndexedDB ä½œç‚ºè³‡æ–™åº«
        let db = null;
        const DB_NAME = 'eswake-offline';
        const DB_VERSION = 1;
        
        // é¸å–®é …ç›®é…ç½®
        const menuItems = [
            { title: 'ä»Šæ—¥é ç´„', icon: 'ğŸ“…', link: '#', action: 'coach-daily' },
            { title: 'é ç´„è¡¨', icon: 'ğŸ“', link: '#', action: 'day' },
            { title: 'æ•™ç·´å›å ±', icon: 'âœ…', link: '#', action: 'my-report' },
            { title: 'é ç´„æŸ¥è©¢', icon: 'ğŸ”', link: '#', action: 'search' },
            { title: 'æ˜æ—¥æé†’', icon: 'â°', link: '#', action: 'tomorrow' },
            { title: 'ç·¨è¼¯è¨˜éŒ„', icon: 'ğŸ“‹', link: '#', action: 'audit-log' },
            { title: 'èˆ¹éš»ç®¡ç†', icon: 'ğŸš¤', link: '#', action: 'boats' },
            { title: 'BAO', icon: 'ğŸ”§', link: '#', action: 'bao' }
        ];
        
        // é¡¯ç¤ºè¨Šæ¯
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('db-alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // åˆå§‹åŒ– IndexedDB
        async function initDatabase() {
            if (db) return db;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    reject(new Error('ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«'));
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('âœ… è³‡æ–™åº«å·²é–‹å•Ÿ');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const database = event.target.result;
                    
                    // å»ºç«‹è³‡æ–™è¡¨ï¼ˆObject Storesï¼‰
                    if (!database.objectStoreNames.contains('members')) {
                        database.createObjectStore('members', { keyPath: 'id' });
                    }
                    if (!database.objectStoreNames.contains('boats')) {
                        const boatStore = database.createObjectStore('boats', { keyPath: 'id', autoIncrement: true });
                        boatStore.createIndex('name', 'name', { unique: true });
                    }
                    if (!database.objectStoreNames.contains('coaches')) {
                        database.createObjectStore('coaches', { keyPath: 'id' });
                    }
                if (!database.objectStoreNames.contains('bookings')) {
                    const bookingStore = database.createObjectStore('bookings', { keyPath: 'id', autoIncrement: true });
                    bookingStore.createIndex('start_at', 'start_at');
                }
                if (!database.objectStoreNames.contains('booking_coaches')) {
                    database.createObjectStore('booking_coaches', { keyPath: 'id', autoIncrement: true });
                }
                if (!database.objectStoreNames.contains('booking_drivers')) {
                    database.createObjectStore('booking_drivers', { keyPath: 'id', autoIncrement: true });
                }
                if (!database.objectStoreNames.contains('booking_members')) {
                    database.createObjectStore('booking_members', { keyPath: 'id', autoIncrement: true });
                }
                    if (!database.objectStoreNames.contains('daily_announcements')) {
                        database.createObjectStore('daily_announcements', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!database.objectStoreNames.contains('audit_log')) {
                        database.createObjectStore('audit_log', { keyPath: 'id', autoIncrement: true });
                    }
                    
                    console.log('âœ… è³‡æ–™è¡¨å·²å»ºç«‹');
                };
            });
        }
        
        // è§£æ SQL INSERT èªå¥ä¸¦æ’å…¥åˆ° IndexedDB
        async function insertFromSQL(tableName, values) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([tableName], 'readwrite');
                const store = transaction.objectStore(tableName);
                
                const record = {};
                values.forEach((value, index) => {
                    const column = Object.keys(values)[index] || `column${index}`;
                    record[column] = value === 'NULL' || value === null ? null : value;
                });
                
                const request = store.add(record);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        
        // æ¸…ç©ºè³‡æ–™åº«
        async function clearDatabase() {
            if (!db) await initDatabase();
            
            const storeNames = ['members', 'boats', 'coaches', 'bookings', 'booking_coaches', 'booking_drivers', 'booking_members', 'daily_announcements', 'audit_log'];
            
            for (const storeName of storeNames) {
                try {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    await new Promise((resolve, reject) => {
                        const request = store.clear();
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.warn('æ¸…ç©º ' + storeName + ' å¤±æ•—:', error);
                }
            }
            
            console.log('âœ… è³‡æ–™åº«å·²æ¸…ç©º');
        }
        
        // è¼‰å…¥ SQL æª”æ¡ˆ
        async function loadSQLFile(file) {
            console.log('é–‹å§‹è¼‰å…¥ SQL æª”æ¡ˆ:', file.name, 'å¤§å°:', file.size, 'bytes');
            
            const loadingDiv = document.getElementById('db-loading');
            if (loadingDiv) {
                loadingDiv.classList.remove('hidden');
            }
            
            try {
                await initDatabase();
                console.log('è³‡æ–™åº«å·²åˆå§‹åŒ–');
                
                // è©¢å•æ˜¯å¦è¦æ¸…ç©ºç¾æœ‰è³‡æ–™
                const shouldClear = confirm('æ˜¯å¦è¦æ¸…ç©ºç¾æœ‰è³‡æ–™åº«ä¸¦è¼‰å…¥æ–°è³‡æ–™ï¼Ÿ\n\né»æ“Šã€Œç¢ºå®šã€æ¸…ç©ºä¸¦è¼‰å…¥\né»æ“Šã€Œå–æ¶ˆã€è¿½åŠ åˆ°ç¾æœ‰è³‡æ–™');
                
                if (shouldClear) {
                    await clearDatabase();
                    console.log('å·²æ¸…ç©ºç¾æœ‰è³‡æ–™');
                }
                
                const text = await file.text();
                console.log('æª”æ¡ˆè®€å–å®Œæˆï¼Œé•·åº¦:', text.length);
                
                // æ›´å¥½çš„ SQL èªå¥åˆ†å‰²ï¼ˆè™•ç†å¤šè¡Œå’Œè¨»è§£ï¼‰
                const statements = [];
                let currentStatement = '';
                let inString = false;
                let stringChar = '';
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];
                    
                    // è™•ç†å­—ä¸²
                    if ((char === "'" || char === '"') && (i === 0 || text[i - 1] !== '\\')) {
                        if (!inString) {
                            inString = true;
                            stringChar = char;
                        } else if (char === stringChar) {
                            inString = false;
                        }
                        currentStatement += char;
                        continue;
                    }
                    
                    // è™•ç†èªå¥çµæŸ
                    if (!inString && char === ';') {
                        currentStatement += char;
                        const trimmed = currentStatement.trim();
                        if (trimmed && !trimmed.startsWith('--') && trimmed.length > 5) {
                            statements.push(trimmed);
                        }
                        currentStatement = '';
                        continue;
                    }
                    
                    // è·³éè¨»è§£
                    if (!inString && char === '-' && nextChar === '-') {
                        // è·³éåˆ°è¡Œå°¾
                        while (i < text.length && text[i] !== '\n') {
                            i++;
                        }
                        continue;
                    }
                    
                    currentStatement += char;
                }
                
                // æ·»åŠ æœ€å¾Œä¸€å€‹èªå¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                if (currentStatement.trim() && !currentStatement.trim().startsWith('--')) {
                    statements.push(currentStatement.trim());
                }
                
                console.log('è§£æå‡º', statements.length, 'å€‹ SQL èªå¥');
                
                let successCount = 0;
                let skipCount = 0;
                
                for (const statement of statements) {
                    const trimmed = statement.trim();
                    if (!trimmed) continue;
                    
                    try {
                        const upperSql = trimmed.toUpperCase();
                        
                        // è·³éä¸æ”¯æ´çš„èªå¥
                        if (upperSql.includes('CREATE TABLE') || 
                            upperSql.includes('ALTER TABLE') ||
                            upperSql.includes('CREATE INDEX')) {
                            skipCount++;
                            continue;
                        }
                        
                        // è™•ç† INSERT
                        if (upperSql.includes('INSERT INTO')) {
                            const match = trimmed.match(/INSERT\s+INTO\s+(\w+)\s*\(([^)]+)\)\s*VALUES\s*\(([^)]+)\)/i);
                            if (match) {
                                const tableName = match[1];
                                const columns = match[2].split(',').map(c => c.trim());
                                const values = match[3].split(',').map(v => {
                                    v = v.trim();
                                    if (v === 'NULL' || v === 'null') return null;
                                    if ((v.startsWith("'") && v.endsWith("'")) || (v.startsWith('"') && v.endsWith('"'))) {
                                        return v.slice(1, -1).replace(/''/g, "'").replace(/""/g, '"');
                                    }
                                    return v;
                                });
                                
                                const record = {};
                                columns.forEach((col, idx) => {
                                    record[col] = values[idx] || null;
                                });
                                
                                const transaction = db.transaction([tableName], 'readwrite');
                                const store = transaction.objectStore(tableName);
                                await new Promise((resolve, reject) => {
                                    const request = store.add(record);
                                    request.onsuccess = () => resolve();
                                    request.onerror = () => reject(request.error);
                                });
                                
                                successCount++;
                            } else {
                                skipCount++;
                            }
                        }
                    } catch (err) {
                        skipCount++;
                        console.warn('è·³éèªå¥:', trimmed.substring(0, 100), err);
                    }
                }
                
                console.log(`è¼‰å…¥å®Œæˆï¼šæˆåŠŸ ${successCount} æ¢ï¼Œè·³é ${skipCount} æ¢`);
                showAlert(`âœ… è³‡æ–™åº«è¼‰å…¥æˆåŠŸï¼æˆåŠŸ: ${successCount} æ¢ï¼Œè·³é: ${skipCount} æ¢`, 'success');
                
                // é‡ç½®æ–‡ä»¶è¼¸å…¥æ¡†ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
                const fileInput = document.getElementById('sql-file');
                if (fileInput) {
                    fileInput.value = '';
                }
                const fileNameDiv = document.getElementById('file-name');
                if (fileNameDiv) {
                    fileNameDiv.textContent = '';
                }
                
                setTimeout(() => {
                    if (loadingDiv) loadingDiv.classList.add('hidden');
                    const dbLoader = document.getElementById('db-loader');
                    if (dbLoader) dbLoader.classList.remove('active');
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.classList.remove('hidden');
                        renderMenu();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('è¼‰å…¥ SQL æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                if (loadingDiv) loadingDiv.classList.add('hidden');
                showAlert('âŒ è¼‰å…¥å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
                
                // é‡ç½®æ–‡ä»¶è¼¸å…¥æ¡†
                const fileInput = document.getElementById('sql-file');
                if (fileInput) {
                    fileInput.value = '';
                }
                const fileNameDiv = document.getElementById('file-name');
                if (fileNameDiv) {
                    fileNameDiv.textContent = '';
                }
            }
        }
        
        // æ¸…ç©ºè³‡æ–™åº«ä¸¦é‡æ–°è¼‰å…¥
        async function clearDatabaseAndReload() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            const loadingDiv = document.getElementById('db-loading');
            if (loadingDiv) {
                loadingDiv.classList.remove('hidden');
            }
            
            try {
                await initDatabase();
                await clearDatabase();
                showAlert('âœ… è³‡æ–™åº«å·²æ¸…ç©ºï¼', 'success');
                
                setTimeout(() => {
                    if (loadingDiv) loadingDiv.classList.add('hidden');
                }, 1000);
            } catch (error) {
                if (loadingDiv) loadingDiv.classList.add('hidden');
                showAlert('âŒ æ¸…ç©ºå¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // å»ºç«‹ç©ºç™½è³‡æ–™åº«
        async function createEmptyDatabase() {
            const loadingDiv = document.getElementById('db-loading');
            loadingDiv.classList.remove('hidden');
            
            try {
                await initDatabase();
                showAlert('âœ… ç©ºç™½è³‡æ–™åº«å»ºç«‹æˆåŠŸï¼', 'success');
                
                setTimeout(() => {
                    loadingDiv.classList.add('hidden');
                    document.getElementById('db-loader').classList.remove('active');
                    document.getElementById('main-content').classList.remove('hidden');
                    renderMenu();
                }, 1000);
            } catch (error) {
                loadingDiv.classList.add('hidden');
                showAlert('âŒ å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // æ¸²æŸ“é¸å–®
        function renderMenu() {
            const menuGrid = document.getElementById('menu-grid');
            menuGrid.innerHTML = menuItems.map(item => `
                <div class="menu-item" onclick="handleMenuClick('${item.action}')">
                    <div class="menu-icon">${item.icon}</div>
                    <h2 class="menu-title">${item.title}</h2>
                </div>
            `).join('');
        }
        
        // è™•ç†é¸å–®é»æ“Š
        function handleMenuClick(action) {
            if (action === 'coach-daily') {
                showCoachDailyView();
            } else {
                alert(`åŠŸèƒ½ã€Œ${action}ã€æ­£åœ¨é–‹ç™¼ä¸­\n\næ­¤ç‚ºé›¢ç·šç‰ˆæœ¬ï¼Œç›®å‰åƒ…æä¾›è³‡æ–™åº«è¼‰å…¥å’Œä»Šæ—¥é ç´„åŠŸèƒ½ã€‚\nå®Œæ•´åŠŸèƒ½è«‹ä½¿ç”¨ç·šä¸Šç‰ˆæœ¬ã€‚`);
            }
        }
        
        // é¡¯ç¤ºä»Šæ—¥é ç´„é é¢
        async function showCoachDailyView(dateParam) {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            const selectedDate = dateParam || new Date().toISOString().split('T')[0];
            
            // ç§»é™¤ container çš„å¯¬åº¦é™åˆ¶ï¼Œè®“è¡¨æ ¼å¯ä»¥å…¨å¯¬é¡¯ç¤º
            appContainer.style.maxWidth = '100%';
            appContainer.style.padding = '0';
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: #f5f5f5; padding-bottom: 80px;">
                    <!-- PageHeader (èˆ‡ç¶²é ç‰ˆå®Œå…¨ä¸€è‡´) -->
                    <div style="
                        margin-bottom: 20px;
                        background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
                        padding: 16px;
                        border-radius: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h1 style="
                                font-size: 20px;
                                font-weight: bold;
                                color: white;
                                margin: 0;
                            ">ä»Šæ—¥é ç´„</h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="showHomePage()" style="
                                    padding: 6px 12px;
                                    background: rgba(255, 255, 255, 0.15);
                                    color: white;
                                    text-decoration: none;
                                    border-radius: 4px;
                                    font-size: 13px;
                                    border: 1px solid rgba(255, 255, 255, 0.2);
                                    white-space: nowrap;
                                    display: inline-flex;
                                    align-items: center;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">â† HOME</button>
                            </div>
                        </div>
                    </div>
                    <div id="coach-daily-content" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="text-align: center; margin-top: 10px;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            `;
            
            await loadAndDisplayBookings(selectedDate);
        }
        
        // å…¨åŸŸè®Šæ•¸ï¼šç•¶å‰é¸ä¸­çš„æ—¥æœŸå’Œæ•™ç·´
        let currentDate = new Date().toISOString().split('T')[0];
        let selectedCoachId = '';
        
        // è¿”å›é¦–é 
        function showHomePage() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            // æ¢å¾© container çš„åŸå§‹æ¨£å¼
            appContainer.style.maxWidth = '600px';
            appContainer.style.padding = '40px 20px';
            
            mainContent.innerHTML = `
                <div class="header">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23000'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-weight='bold'%3EES%3C/text%3E%3C/svg%3E" 
                         alt="ES Wake Logo" class="logo" onerror="this.style.display='none'">
                    <h1 class="title">ES WAKE</h1>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <button onclick="showDatabaseLoader()" style="
                        padding: 10px 20px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                    ">ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™åº«</button>
                </div>
                <div class="menu-grid" id="menu-grid"></div>
                <div class="footer">
                    <p>Â© 2025 ES Wake. All Rights Reserved.</p>
                    <p style="font-size: 12px; opacity: 0.7; margin-top: 8px;">æ»‘æ°´é ç´„ç®¡ç†ç³»çµ± - é›¢ç·šæ¨¡å¼</p>
                </div>
            `;
            renderMenu();
        }
        
        // é¡¯ç¤ºè³‡æ–™åº«è¼‰å…¥å™¨
        function showDatabaseLoader() {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.classList.add('hidden');
            }
            const dbLoader = document.getElementById('db-loader');
            if (dbLoader) {
                dbLoader.classList.add('active');
            }
            
            // é‡ç½®æ–‡ä»¶è¼¸å…¥æ¡†
            const fileInput = document.getElementById('sql-file');
            if (fileInput) {
                fileInput.value = '';
            }
            const fileNameDiv = document.getElementById('file-name');
            if (fileNameDiv) {
                fileNameDiv.textContent = '';
            }
            
            // æ¸…é™¤æç¤ºè¨Šæ¯
            const alertDiv = document.getElementById('db-alert');
            if (alertDiv) {
                alertDiv.textContent = '';
                alertDiv.style.display = 'none';
            }
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºé ç´„
        async function loadAndDisplayBookings(dateParam) {
            try {
                if (!db) await initDatabase();
                
                const selectedDate = dateParam || currentDate;
                currentDate = selectedDate;
                
                // è¼‰å…¥èˆ¹éš»
                const boats = await getAllFromStore('boats');
                
                // è¼‰å…¥æ•™ç·´
                const coaches = await getAllFromStore('coaches');
                const activeCoaches = coaches.filter(c => c.status === 'active');
                
                // è¼‰å…¥æŒ‡å®šæ—¥æœŸçš„é ç´„
                const startOfDay = `${selectedDate}T00:00:00`;
                const endOfDay = `${selectedDate}T23:59:59`;
                
                const allBookings = await getAllFromStore('bookings');
                const dateBookings = allBookings.filter(b => {
                    if (b.status !== 'confirmed') return false;
                    const startAt = b.start_at;
                    return startAt >= startOfDay && startAt <= endOfDay;
                }).sort((a, b) => a.start_at.localeCompare(b.start_at));
                
                // è¼‰å…¥é—œè¯è³‡æ–™
                const bookingIds = dateBookings.map(b => b.id);
                const bookingCoaches = await getBookingCoaches(bookingIds);
                const bookingDrivers = await getBookingDrivers(bookingIds);
                const bookingMembers = await getBookingMembers(bookingIds);
                
                // çµ„åˆè³‡æ–™
                let bookingsWithDetails = dateBookings.map(booking => {
                    const boat = boats.find(b => b.id === booking.boat_id);
                    const coaches = bookingCoaches.filter(bc => bc.booking_id === booking.id)
                        .map(bc => activeCoaches.find(c => c.id === bc.coach_id))
                        .filter(Boolean);
                    const drivers = bookingDrivers.filter(bd => bd.booking_id === booking.id)
                        .map(bd => activeCoaches.find(c => c.id === bd.driver_id))
                        .filter(Boolean);
                    const members = bookingMembers.filter(bm => bm.booking_id === booking.id)
                        .map(bm => {
                            const member = bm.members || null;
                            return member ? { member_id: bm.member_id, members: member } : null;
                        })
                        .filter(Boolean);
                    
                    return {
                        ...booking,
                        boats: boat || null,
                        coaches: coaches,
                        drivers: drivers,
                        booking_members: members
                    };
                });
                
                // ç¯©é¸æ•™ç·´
                if (selectedCoachId) {
                    bookingsWithDetails = bookingsWithDetails.filter(booking => {
                        const isCoach = booking.coaches?.some(c => c.id === selectedCoachId);
                        const isDriver = booking.drivers?.some(d => d.id === selectedCoachId);
                        return isCoach || isDriver;
                    });
                }
                
                // æ’åºèˆ¹éš»ï¼ˆèˆ‡ç·šä¸Šç‰ˆæœ¬ä¸€è‡´ï¼‰
                const boatOrder = ['G23', 'G21', 'é»‘è±¹', 'ç²‰ç´…', '200', 'å½ˆç°§åºŠ'];
                const sortedBoats = boats.sort((a, b) => {
                    const indexA = boatOrder.indexOf(a.name);
                    const indexB = boatOrder.indexOf(b.name);
                    return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                });
                
                // ç”Ÿæˆæ™‚é–“æ§½ï¼ˆæ¯15åˆ†é˜ä¸€å€‹ï¼‰
                const timeSlots = generateTimeSlots();
                
                // éæ¿¾æ™‚é–“æ§½ï¼ˆé¡¯ç¤ºæœ‰é ç´„çš„æ™‚é–“ç¯„åœï¼‰
                const filteredTimeSlots = filterTimeSlots(timeSlots, bookingsWithDetails);
                
                // æ¸²æŸ“é é¢
                renderCoachDailyView({
                    boats: sortedBoats,
                    coaches: activeCoaches,
                    bookings: bookingsWithDetails,
                    timeSlots: filteredTimeSlots,
                    date: selectedDate
                });
                
            } catch (error) {
                console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
                document.getElementById('coach-daily-content').innerHTML = `
                    <div class="alert alert-error">
                        âŒ è¼‰å…¥å¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }
        
        // ç²å–é ç´„çš„é§•é§›
        async function getBookingDrivers(bookingIds) {
            try {
                const all = await getAllFromStore('booking_drivers');
                return all.filter(function(bd) { return bookingIds.indexOf(bd.booking_id) !== -1; });
            } catch {
                return [];
            }
        }
        
        // ç²å–é ç´„çš„æœƒå“¡
        async function getBookingMembers(bookingIds) {
            try {
                const all = await getAllFromStore('booking_members');
                const filtered = all.filter(function(bm) { return bookingIds.indexOf(bm.booking_id) !== -1; });
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const memberIds = filtered.map(function(bm) { return bm.member_id; }).filter(function(id) { return id; });
                const allMembers = await getAllFromStore('members');
                const membersMap = {};
                allMembers.forEach(function(member) {
                    membersMap[member.id] = member;
                });
                
                // çµ„åˆæœƒå“¡è³‡æ–™
                return filtered.map(function(bm) {
                    return {
                        booking_id: bm.booking_id,
                        member_id: bm.member_id,
                        members: membersMap[bm.member_id] || null
                    };
                });
            } catch {
                return [];
            }
        }
        
        // æ”¹è®Šæ—¥æœŸ
        function handleDateChange(days) {
            const currentDateObj = new Date(currentDate);
            currentDateObj.setDate(currentDateObj.getDate() + days);
            const newDate = currentDateObj.toISOString().split('T')[0];
            loadAndDisplayBookings(newDate);
        }
        
        // è·³è½‰åˆ°ä»Šå¤©
        function goToToday() {
            const today = new Date().toISOString().split('T')[0];
            loadAndDisplayBookings(today);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = days[date.getDay()];
            return { dateText: month + 'æœˆ' + day + 'æ—¥', weekday: 'æ˜ŸæœŸ' + weekday };
        }
        
        // ç²å–æœ¬åœ°æ—¥æœŸå­—ä¸²
        function getLocalDateString(date) {
            const d = date || new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // ç²å–é¡¯ç¤ºåç¨±ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
        function getDisplayContactName(booking) {
            // å¦‚æœæœ‰é—œè¯çš„æœƒå“¡ï¼Œå„ªå…ˆé¡¯ç¤ºæš±ç¨±
            if (booking.booking_members && booking.booking_members.length > 0) {
                const memberDisplayNames = booking.booking_members
                    .map(function(bm) {
                        if (!bm.members) return null;
                        return bm.members.nickname || bm.members.name;
                    })
                    .filter(function(name) { return name; });
                
                // å¦‚æœæœ‰é‡è¤‡çš„æš±ç¨±ï¼Œåªé¡¯ç¤ºä¸€å€‹
                const uniqueNames = [];
                memberDisplayNames.forEach(function(name) {
                    if (uniqueNames.indexOf(name) === -1) {
                        uniqueNames.push(name);
                    }
                });
                
                // å¦‚æœæ²’æœ‰ä»»ä½•æœ‰æ•ˆçš„æœƒå“¡åç¨±ï¼Œå›é€€åˆ° contact_name
                if (uniqueNames.length === 0) {
                    return booking.contact_name || 'æœªå‘½å';
                }
                
                // å¦‚æœåªæœ‰æœƒå“¡ï¼Œä¸”æ•¸é‡å»åˆ contact_name ä¸­çš„åå­—æ•¸é‡ï¼Œç›´æ¥è¿”å›
                const contactNameParts = booking.contact_name ? booking.contact_name.split(',').map(function(n) { return n.trim(); }).filter(function(n) { return n; }) : [];
                
                // å¦‚æœæœƒå“¡æ•¸é‡ç­‰æ–¼ contact_name ä¸­çš„åå­—æ•¸é‡ï¼Œèªªæ˜éƒ½æ˜¯æœƒå“¡
                if (uniqueNames.length === contactNameParts.length) {
                    return uniqueNames.join(', ');
                }
                
                // å¦å‰‡ï¼Œç›´æ¥è¿”å›ç¬¬ä¸€å€‹æœƒå“¡çš„æš±ç¨±/å§“å
                return uniqueNames[0] || booking.contact_name || 'æœªå‘½å';
            }
            
            // æ²’æœ‰é—œè¯æœƒå“¡ï¼Œç›´æ¥ä½¿ç”¨ contact_name
            return booking.contact_name || 'æœªå‘½å';
        }
        
        // å¾ IndexedDB ç²å–æ‰€æœ‰è³‡æ–™
        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        // ç²å–é ç´„çš„æ•™ç·´
        async function getBookingCoaches(bookingIds) {
            // ç°¡åŒ–ç‰ˆï¼šå‡è¨­ booking_coaches è¡¨å­˜åœ¨
            try {
                const all = await getAllFromStore('booking_coaches');
                return all.filter(bc => bookingIds.includes(bc.booking_id));
            } catch {
                return [];
            }
        }
        
        // ç²å–é ç´„çš„èˆ¹éš»ï¼ˆå·²åŒ…å«åœ¨ bookings ä¸­ï¼‰
        async function getBookingBoats(bookingIds) {
            return [];
        }
        
        // ç”Ÿæˆæ™‚é–“æ§½
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    slots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                }
            }
            return slots;
        }
        
        // éæ¿¾æ™‚é–“æ§½
        function filterTimeSlots(slots, bookings) {
            if (bookings.length === 0) {
                // æ²’æœ‰é ç´„æ™‚ï¼Œé¡¯ç¤º 04:30-18:00
                return slots.filter(slot => {
                    const [hour, minute] = slot.split(':').map(Number);
                    const slotMinutes = hour * 60 + minute;
                    const startMinutes = 4 * 60 + 30;
                    const endMinutes = 18 * 60;
                    return slotMinutes >= startMinutes && slotMinutes <= endMinutes;
                });
            }
            
            // æ‰¾å‡ºæœ€æ—©å’Œæœ€æ™šçš„é ç´„æ™‚é–“
            let earliestMinutes = Infinity;
            let latestMinutes = -Infinity;
            
            bookings.forEach(booking => {
                const start = new Date(booking.start_at);
                const end = new Date(start.getTime() + (booking.duration_min + 15) * 60000);
                const startMinutes = start.getHours() * 60 + start.getMinutes();
                const endMinutes = end.getHours() * 60 + end.getMinutes();
                earliestMinutes = Math.min(earliestMinutes, startMinutes);
                latestMinutes = Math.max(latestMinutes, endMinutes);
            });
            
            // å‰å¾Œå„å¤šé¡¯ç¤º 30 åˆ†é˜
            earliestMinutes = Math.max(0, earliestMinutes - 30);
            latestMinutes = Math.min(24 * 60, latestMinutes + 30);
            
            // è‡³å°‘é¡¯ç¤º 04:30-18:00
            const defaultStart = 4 * 60 + 30;
            const defaultEnd = 18 * 60;
            earliestMinutes = Math.min(earliestMinutes, defaultStart);
            latestMinutes = Math.max(latestMinutes, defaultEnd);
            
            return slots.filter(slot => {
                const [hour, minute] = slot.split(':').map(Number);
                const slotMinutes = hour * 60 + minute;
                return slotMinutes >= earliestMinutes && slotMinutes <= latestMinutes;
            });
        }
        
        // æ¸²æŸ“ä»Šæ—¥é ç´„é é¢ï¼ˆæ™‚é–“è»¸è¡¨æ ¼è¦–åœ–ï¼Œèˆ‡ç·šä¸Šç‰ˆé›»è…¦ç‰ˆä¸€è‡´ï¼‰
        function renderCoachDailyView({ boats, coaches, bookings, timeSlots, date }) {
            const content = document.getElementById('coach-daily-content');
            // å›ºå®šä½¿ç”¨æ¡Œé¢ç‰ˆæ¨£å¼ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
            const isMobile = false;
            const today = getLocalDateString();
            const dateDisplay = formatDisplayDate(date);
            
            // ç²å–æŸå€‹æ™‚é–“é»çš„é ç´„
            const getBookingForCell = (boatId, timeSlot) => {
                return bookings.find(b => {
                    if (b.boat_id !== boatId) return false;
                    const bookingStart = new Date(b.start_at);
                    const bookingStartTime = bookingStart.getHours().toString().padStart(2, '0') + ':' + bookingStart.getMinutes().toString().padStart(2, '0');
                    return bookingStartTime === timeSlot;
                }) || null;
            };
            
            // åˆ¤æ–·æ˜¯å¦åœ¨é ç´„æ™‚é–“å…§
            const isInBookingRange = (boatId, timeSlot) => {
                const parts = timeSlot.split(':');
                const hour = parseInt(parts[0]);
                const minute = parseInt(parts[1]);
                const slotTime = new Date(date);
                slotTime.setHours(hour, minute, 0, 0);
                
                return bookings.some(booking => {
                    if (booking.boat_id !== boatId) return false;
                    const start = new Date(booking.start_at);
                    const end = new Date(start.getTime() + booking.duration_min * 60000);
                    return slotTime > start && slotTime < end;
                });
            };
            
            // åˆ¤æ–·æ˜¯å¦æ˜¯é ç´„çš„é–‹å§‹æ™‚é–“æ ¼
            const isBookingStart = (boatId, timeSlot) => {
                return getBookingForCell(boatId, timeSlot) !== null;
            };
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            const tableRows = [];
            const renderedBookings = new Set();
            
            timeSlots.forEach(timeSlot => {
                const cells = [];
                
                boats.forEach(boat => {
                    const booking = getBookingForCell(boat.id, timeSlot);
                    const isStart = booking !== null && !renderedBookings.has(booking.id);
                    const isInRange = isInBookingRange(boat.id, timeSlot);
                    
                    if (isStart) {
                        renderedBookings.add(booking.id);
                        const start = new Date(booking.start_at);
                        const end = new Date(start.getTime() + booking.duration_min * 60000);
                        const startTime = start.getHours().toString().padStart(2, '0') + ':' + start.getMinutes().toString().padStart(2, '0');
                        const endTime = end.getHours().toString().padStart(2, '0') + ':' + end.getMinutes().toString().padStart(2, '0');
                        const slots = Math.ceil(booking.duration_min / 15);
                        
                        // æå–æ•™ç·´å’Œé§•é§›åç¨±ï¼ˆç¢ºä¿æ­£ç¢ºè™•ç†è³‡æ–™çµæ§‹ï¼‰
                        let coachNames = '';
                        if (booking.coaches && Array.isArray(booking.coaches) && booking.coaches.length > 0) {
                            coachNames = booking.coaches
                                .filter(function(c) { return c && c.name; })
                                .map(function(c) { return c.name; })
                                .join(', ');
                        }
                        
                        let driverNames = '';
                        if (booking.drivers && Array.isArray(booking.drivers) && booking.drivers.length > 0) {
                            driverNames = booking.drivers
                                .filter(function(d) { return d && d.name; })
                                .map(function(d) { return d.name; })
                                .join(', ');
                        }
                        
                        const boatColor = booking.boats && booking.boats.color ? booking.boats.color : '#1976d2';
                        
                        // ç²å–é¡¯ç¤ºåç¨±ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
                        const displayContactName = getDisplayContactName(booking);
                        
                        // æ§‹å»ºå¡ç‰‡ HTMLï¼ˆèˆ‡ç¶²é ç‰ˆæ¨£å¼ä¸€è‡´ï¼‰
                        const cardStyle = 'padding: 14px 12px; background: linear-gradient(135deg, ' + boatColor + '08 0%, ' + boatColor + '15 100%); border: 2px solid ' + boatColor + '; vertical-align: top; position: relative; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                        
                        const timeRangeHtml = '<div style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px; text-align: center; line-height: 1.3; letter-spacing: 0.5px;">' + startTime + ' - ' + endTime + '</div>';
                        const contactNameHtml = '<div style="font-size: 16px; font-weight: 700; margin-bottom: 6px; text-align: center; color: #1a1a1a;">' + displayContactName + '</div>';
                        const notesHtml = booking.notes ? '<div style="font-size: 12px; color: #666; margin-bottom: 4px; text-align: center; font-style: italic;">' + booking.notes + '</div>' : '';
                        const scheduleNotesHtml = booking.schedule_notes ? '<div style="font-size: 12px; color: #e65100; margin-bottom: 4px; text-align: center; font-weight: 500;">ğŸ“ ' + booking.schedule_notes + '</div>' : '';
                        
                        // æ•™ç·´å’Œé§•é§› HTMLï¼ˆç¢ºä¿æœ‰è³‡æ–™æ™‚æ‰é¡¯ç¤ºï¼‰
                        const coachHtml = coachNames ? '<div style="font-size: 12px; color: ' + boatColor + '; font-weight: 600; text-align: center; margin-top: 2px;">ğŸ“ ' + coachNames + '</div>' : '';
                        const driverHtml = driverNames ? '<div style="font-size: 12px; color: ' + boatColor + '; font-weight: 600; text-align: center; margin-top: 2px;">ğŸš¤ ' + driverNames + '</div>' : '';
                        
                        cells.push({
                            html: '<td rowspan="' + slots + '" style="' + cardStyle + '">' + timeRangeHtml + contactNameHtml + notesHtml + scheduleNotesHtml + coachHtml + driverHtml + '</td>',
                            skip: false
                        });
                    } else if (isInRange) {
                        cells.push({ html: '', skip: true });
                    } else {
                        cells.push({
                            html: '<td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; border-right: 1px solid #e9ecef; background: white;"></td>',
                            skip: false
                        });
                    }
                });
                
                const cellsHtml = cells.filter(function(cell) { return !cell.skip; }).map(function(cell) { return cell.html; }).join('');
                tableRows.push('<tr><td style="position: sticky; left: 0; z-index: 10; background: white; padding: 6px 8px; border-bottom: 1px solid #e9ecef; font-size: 13px; font-weight: 500; text-align: center; color: #666; line-height: 1.5; width: 80px;">' + timeSlot + '</td>' + cellsHtml + '</tr>');
            });
            
            content.innerHTML = `
                <!-- æ—¥æœŸå’Œæ•™ç·´ç¯©é¸ -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- æ—¥æœŸåˆ‡æ› -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 10px;">
                        <button onclick="handleDateChange(-1)" style="padding: 8px 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 16px; color: #666; font-weight: 600;">
                            â† å‰ä¸€å¤©
                        </button>
                        
                        <div style="flex: 1; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                <div style="font-size: 20px; font-weight: bold; color: #333;">
                                    ${dateDisplay.dateText}
                                </div>
                                <div style="font-size: 14px; font-weight: 600; color: #495057; background: #f8f9fa; padding: 4px 12px; border-radius: 12px; border: 1px solid #dee2e6;">
                                    ${dateDisplay.weekday}
                                </div>
                            </div>
                            ${date !== today ? '<button onclick="goToToday()" style="padding: 4px 12px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">å›åˆ°ä»Šå¤©</button>' : ''}
                        </div>
                        
                        <button onclick="handleDateChange(1)" style="padding: 8px 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 16px; color: #666; font-weight: 600;">
                            å¾Œä¸€å¤© â†’
                        </button>
                    </div>
                    
                    <!-- æ•™ç·´ç¯©é¸ -->
                    <div style="display: flex; align-items: center; gap: 12px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                        <label style="font-size: 14px; color: #666; font-weight: 600;">ç¯©é¸æ•™ç·´ï¼š</label>
                        <select id="coach-filter" onchange="handleCoachFilterChange(this.value)" style="flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                            <option value="">æ‰€æœ‰æ•™ç·´</option>
                            ${coaches.map(function(coach) {
                                return '<option value="' + coach.id + '"' + (selectedCoachId === coach.id ? ' selected' : '') + '>' + coach.name + '</option>';
                            }).join('')}
                        </select>
                    </div>
                    
                    <!-- æœ€å¾Œæ›´æ–°æ™‚é–“ -->
                    <div style="padding-top: 12px; font-size: 12px; color: #999; text-align: right;">
                        æœ€å¾Œæ›´æ–°ï¼š${new Date().getHours().toString().padStart(2, '0')}:${new Date().getMinutes().toString().padStart(2, '0')}
                    </div>
                </div>
                
                <!-- æ™‚é–“è»¸è¡¨æ ¼ -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                        <thead>
                            <tr>
                                <th style="position: sticky; top: 0; left: 0; z-index: 12; padding: 12px; border-bottom: 2px solid #dee2e6; background-color: #5a5a5a; color: white; font-size: 14px; font-weight: 600; width: 80px;">
                                    æ™‚é–“
                                </th>
                                ${boats.map(function(boat) {
                                    const count = bookings.filter(function(b) { return b.boat_id === boat.id; }).length;
                                    return '<th style="position: sticky; top: 0; z-index: 11; padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; background-color: #5a5a5a; color: white; font-size: 14px; font-weight: 600; width: 120px;"><div style="font-size: 13px;">' + boat.name + '</div><div style="font-size: 11px; font-weight: 400; margin-top: 2px; opacity: 0.8;">' + count + 'ç­†</div></th>';
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody style="position: relative;">
                            ${tableRows.join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                    å…± ${bookings.length} ç­†é ç´„
                </div>
            `;
        }
        
        // è™•ç†æ•™ç·´ç¯©é¸è®Šæ›´
        function handleCoachFilterChange(coachId) {
            selectedCoachId = coachId;
            loadAndDisplayBookings(currentDate);
        }
        
        // æª”æ¡ˆé¸æ“‡äº‹ä»¶ - ä½¿ç”¨æ¨™è¨˜é¿å…é‡è¤‡è¨­ç½®
        let fileInputSetup = false;
        function setupFileInput() {
            if (fileInputSetup) return; // é¿å…é‡è¤‡è¨­ç½®
            const fileInput = document.getElementById('sql-file');
            if (fileInput) {
                fileInputSetup = true;
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const newInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newInput, fileInput);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                newInput.addEventListener('change', function(e) {
                    const file = e.target.files?.[0];
                    const fileNameDiv = document.getElementById('file-name');
                    
                    if (file) {
                        console.log('é¸æ“‡äº†æª”æ¡ˆ:', file.name, 'å¤§å°:', file.size, 'bytes');
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `å·²é¸æ“‡: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                            fileNameDiv.style.color = '#667eea';
                        }
                        loadSQLFile(file);
                    } else {
                        console.log('æœªé¸æ“‡æª”æ¡ˆ');
                        if (fileNameDiv) {
                            fileNameDiv.textContent = '';
                        }
                    }
                });
                
                // ä¹Ÿç‚º label æ·»åŠ é»æ“Šäº‹ä»¶ï¼ˆç¢ºä¿å¯ä»¥è§¸ç™¼ï¼‰
                const label = newInput.closest('label');
                if (label) {
                    label.addEventListener('click', function(e) {
                        if (e.target === label || e.target.tagName === 'SPAN') {
                            newInput.click();
                        }
                    });
                }
                
                console.log('âœ… æª”æ¡ˆè¼¸å…¥äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®');
            } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ° sql-file å…ƒç´ ï¼Œç¨å¾Œé‡è©¦');
                setTimeout(setupFileInput, 100);
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¼‰å…¥çš„è³‡æ–™åº«
        window.addEventListener('load', async () => {
            try {
                // è¨­ç½®æª”æ¡ˆè¼¸å…¥äº‹ä»¶ç›£è½å™¨
                setupFileInput();
                
                await initDatabase();
                // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™
                const transaction = db.transaction(['members'], 'readonly');
                const store = transaction.objectStore('members');
                const countRequest = store.count();
                
                countRequest.onsuccess = () => {
                    if (countRequest.result > 0) {
                        // æœ‰è³‡æ–™ï¼Œç›´æ¥é¡¯ç¤ºä¸»é é¢
                        document.getElementById('db-loader').classList.remove('active');
                        document.getElementById('main-content').classList.remove('hidden');
                        renderMenu();
                    }
                    // æ²’æœ‰è³‡æ–™ï¼Œé¡¯ç¤ºè¼‰å…¥å™¨è®“ç”¨æˆ¶é¸æ“‡
                };
            } catch (error) {
                console.error('åˆå§‹åŒ–è³‡æ–™åº«å¤±æ•—:', error);
            }
        });
    </script>
</body>
</html>

