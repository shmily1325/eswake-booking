<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ES Wake - é›¢ç·šç·¨è¼¯å™¨</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'PingFang TC', 'Microsoft JhengHei', 
                'Segoe UI', 'Roboto', 'Noto Sans TC', 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);
            min-height: 100vh;
            color: #213547;
        }
        
        .container {
            max-width: 600px;
            width: 100%;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .container.full-width {
            max-width: 100%;
            padding: 0;
        }
        
        .header {
            text-align: center;
            margin-bottom: 50px;
        }
        
        .logo {
            width: 140px;
            height: 140px;
            object-fit: contain;
            margin-bottom: 20px;
            border-radius: 50%;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .title {
            margin: 0 0 20px 0;
            font-size: 42px;
            font-weight: 800;
            color: #000;
            letter-spacing: 2px;
        }
        
        @media (max-width: 768px) {
            .menu-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            .title {
                font-size: 32px;
            }
        }
        
        .menu-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }
        
        .menu-item {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 35px 20px;
            box-shadow: 0 2px 12px rgba(0,0,0,0.08);
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            gap: 12px;
            cursor: pointer;
            border: 1px solid rgba(224, 224, 224, 0.5);
            text-decoration: none;
            color: #000;
        }
        
        .menu-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.12);
            border-color: #000;
        }
        
        .menu-icon {
            font-size: 42px;
            margin-bottom: 5px;
        }
        
        .menu-title {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #000;
            letter-spacing: 0.5px;
        }
        
        @media (max-width: 768px) {
            .menu-title {
                font-size: 16px;
            }
        }
        
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 30px;
            border-top: 1px solid rgba(0, 0, 0, 0.1);
            color: #666;
            font-size: 14px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }
        
        .file-input {
            width: 100%;
            padding: 12px;
            border: 2px dashed #667eea;
            border-radius: 8px;
            background: #f8f9fa;
            cursor: pointer;
            text-align: center;
        }
        
        .file-input input {
            display: none;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background: #5568d3;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }
        
        .alert {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div id="app" class="container">
        <!-- è³‡æ–™åº«è¼‰å…¥å™¨ -->
        <div id="db-loader" class="modal">
            <div class="modal-content">
                <div class="modal-title">ğŸ’¾ è¼‰å…¥è³‡æ–™åº«</div>
                <div id="db-alert"></div>
                <div class="file-input-wrapper">
                    <label class="file-input" for="sql-file">
                        <input type="file" id="sql-file" accept=".sql,.txt" style="display: none;">
                        <span>ğŸ“ é»æ“Šé¸æ“‡ SQL å‚™ä»½æª”æ¡ˆ</span>
                    </label>
                    <div id="file-name" style="margin-top: 10px; font-size: 12px; color: #666; text-align: center;"></div>
                </div>
                <button class="btn btn-secondary" onclick="createEmptyDatabase()">ğŸ†• å»ºç«‹ç©ºç™½è³‡æ–™åº«</button>
                <button class="btn btn-secondary" onclick="clearDatabaseAndReload()" style="background: #dc3545;">ğŸ—‘ï¸ æ¸…ç©ºè³‡æ–™åº«</button>
                <div id="db-loading" class="hidden">
                    <div class="spinner"></div>
                    <p style="text-align: center; margin-top: 10px;">è™•ç†ä¸­...</p>
                </div>
            </div>
        </div>
        
        <!-- ä¸»é é¢ -->
        <div id="main-content">
            <div class="header">
                <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23000'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-weight='bold'%3EES%3C/text%3E%3C/svg%3E" 
                     alt="ES Wake Logo" class="logo" onerror="this.style.display='none'">
                <h1 class="title">ES WAKE</h1>
            </div>
            
            <div class="menu-grid" id="menu-grid">
                <!-- é¸å–®é …ç›®å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
            
            <div class="footer">
                <p>Â© 2025 ES Wake. All Rights Reserved.</p>
                <p style="font-size: 12px; opacity: 0.7; margin-top: 8px;">æ»‘æ°´é ç´„ç®¡ç†ç³»çµ± - é›¢ç·šæ¨¡å¼</p>
            </div>
        </div>
        
        <!-- å°è©±æ¡†å®¹å™¨ -->
        <div id="add-member-dialog" class="modal">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <div id="member-detail-dialog" class="modal">
            <div class="modal-content" style="max-width: 800px; max-height: 90vh; overflow-y: auto;">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <div id="transaction-dialog" class="modal">
            <div class="modal-content" style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
        
        <div id="board-slot-dialog" class="modal">
            <div class="modal-content" style="max-width: 500px; max-height: 90vh; overflow-y: auto;">
                <!-- å°‡ç”± JavaScript å‹•æ…‹ç”Ÿæˆ -->
            </div>
        </div>
    </div>
    
    <script>
        // å…¨åŸŸè®Šæ•¸ - ä½¿ç”¨ IndexedDB ä½œç‚ºè³‡æ–™åº«
        let db = null;
        const DB_NAME = 'eswake-offline';
        const DB_VERSION = 1;
        
        // é¸å–®é …ç›®é…ç½®
        const menuItems = [
            { title: 'ä»Šæ—¥é ç´„', icon: 'ğŸ“…', link: '#', action: 'coach-daily' },
            { title: 'é ç´„è¡¨', icon: 'ğŸ“', link: '#', action: 'day' },
            { title: 'æ•™ç·´å›å ±', icon: 'âœ…', link: '#', action: 'my-report' },
            { title: 'é ç´„æŸ¥è©¢', icon: 'ğŸ”', link: '#', action: 'search' },
            { title: 'æ˜æ—¥æé†’', icon: 'â°', link: '#', action: 'tomorrow' },
            { title: 'ç·¨è¼¯è¨˜éŒ„', icon: 'ğŸ“‹', link: '#', action: 'audit-log' },
            { title: 'èˆ¹éš»ç®¡ç†', icon: 'ğŸš¤', link: '#', action: 'boats' },
            { title: 'BAO', icon: 'ğŸ”§', link: '#', action: 'bao' }
        ];
        
        // é¡¯ç¤ºè¨Šæ¯
        function showAlert(message, type = 'success') {
            const alertDiv = document.getElementById('db-alert');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            alertDiv.style.display = 'block';
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }
        
        // å‹•æ…‹å‰µå»ºè¡¨çš„è¼”åŠ©å‡½æ•¸
        // ä½¿ç”¨ä¸€å€‹é›†åˆä¾†è¿½è¹¤éœ€è¦å‰µå»ºçš„è¡¨ï¼Œç„¶å¾Œä¸€æ¬¡æ€§å‰µå»º
        const pendingTables = new Map(); // ä½¿ç”¨ Map ä¾†å­˜å„²è¡¨é…ç½®
        let isUpgrading = false; // å‡ç´šé–å®šæ¨™è¨˜
        
        async function createTableIfNotExists(tableName, keyPath = 'id', autoIncrement = false) {
            if (db && db.objectStoreNames.contains(tableName)) {
                return; // è¡¨å·²å­˜åœ¨
            }
            
            // å°‡è¡¨æ·»åŠ åˆ°å¾…å‰µå»ºåˆ—è¡¨
            pendingTables.set(tableName, { keyPath, autoIncrement });
            
            // å¦‚æœæ­£åœ¨å‡ç´šï¼Œç­‰å¾…å®Œæˆ
            if (isUpgrading) {
                // ç­‰å¾…å‡ç´šå®Œæˆ
                while (isUpgrading) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                // æª¢æŸ¥è¡¨æ˜¯å¦å·²ç¶“è¢«å‰µå»º
                if (db && db.objectStoreNames.contains(tableName)) {
                    return;
                }
            }
            
            // èª¿ç”¨ createAllPendingTables ä¾†ä¸€æ¬¡æ€§å‰µå»ºæ‰€æœ‰è¡¨
            await createAllPendingTables();
        }
        
        // ä¸€æ¬¡æ€§å‰µå»ºæ‰€æœ‰å¾…å‰µå»ºçš„è¡¨ï¼ˆåœ¨è™•ç† SQL èªå¥ä¹‹å‰èª¿ç”¨ï¼‰
        async function createAllPendingTables() {
            if (pendingTables.size === 0) {
                return;
            }
            
            if (isUpgrading) {
                // ç­‰å¾…å‡ç´šå®Œæˆ
                while (isUpgrading) {
                    await new Promise(resolve => setTimeout(resolve, 50));
                }
                return;
            }
            
            if (!db) {
                await initDatabase();
            }
            
            // å†æ¬¡æª¢æŸ¥ï¼Œå¯èƒ½å·²ç¶“è¢«å‰µå»ºäº†
            const tablesToCreate = [];
            pendingTables.forEach((config, name) => {
                if (!db.objectStoreNames.contains(name)) {
                    tablesToCreate.push({ name, ...config });
                }
            });
            
            if (tablesToCreate.length === 0) {
                pendingTables.clear();
                return;
            }
            
            isUpgrading = true;
            const currentVersion = db.version;
            const newVersion = currentVersion + 1;
            
            // é—œé–‰ç•¶å‰é€£æ¥
            db.close();
            db = null;
            
            try {
                await new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, newVersion);
                    
                    request.onerror = (e) => {
                        isUpgrading = false;
                        console.error('è³‡æ–™åº«é–‹å•ŸéŒ¯èª¤:', e);
                        reject(new Error('ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«ä»¥å‰µå»ºè¡¨: ' + (request.error?.message || 'æœªçŸ¥éŒ¯èª¤')));
                    };
                    
                    request.onsuccess = () => {
                        db = request.result;
                        isUpgrading = false;
                        console.log(`âœ… å·²å‰µå»º ${tablesToCreate.length} å€‹è¡¨`);
                        pendingTables.clear();
                        resolve(db);
                    };
                    
                    request.onupgradeneeded = (event) => {
                        try {
                            const database = event.target.result;
                            
                            // é‡æ–°å‰µå»ºæ‰€æœ‰ç¾æœ‰è¡¨ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
                            const existingStores = {
                                'members': { keyPath: 'id', autoIncrement: false },
                                'boats': { keyPath: 'id', autoIncrement: true, index: { name: 'name', unique: true } },
                                'coaches': { keyPath: 'id', autoIncrement: false },
                                'bookings': { keyPath: 'id', autoIncrement: true, index: { name: 'start_at', unique: false } },
                                'booking_coaches': { keyPath: 'id', autoIncrement: true },
                                'booking_drivers': { keyPath: 'id', autoIncrement: true },
                                'booking_members': { keyPath: 'id', autoIncrement: true },
                                'daily_announcements': { keyPath: 'id', autoIncrement: true },
                                'audit_log': { keyPath: 'id', autoIncrement: true },
                                'transactions': { keyPath: 'id', autoIncrement: true },
                                'board_storage': { keyPath: 'id', autoIncrement: true },
                                'member_notes': { keyPath: 'id', autoIncrement: true }
                            };
                            
                            // å‰µå»ºç¾æœ‰è¡¨
                            Object.keys(existingStores).forEach(storeName => {
                                if (!database.objectStoreNames.contains(storeName)) {
                                    const config = existingStores[storeName];
                                    const store = database.createObjectStore(storeName, {
                                        keyPath: config.keyPath,
                                        autoIncrement: config.autoIncrement
                                    });
                                    if (config.index) {
                                        store.createIndex(config.index.name, config.index.name, { unique: config.index.unique });
                                    }
                                }
                            });
                            
                            // å‰µå»ºæ‰€æœ‰å¾…å‰µå»ºçš„è¡¨
                            tablesToCreate.forEach(({ name, keyPath, autoIncrement }) => {
                                if (!database.objectStoreNames.contains(name)) {
                                    const options = { keyPath: keyPath };
                                    if (autoIncrement) {
                                        options.autoIncrement = true;
                                    }
                                    database.createObjectStore(name, options);
                                    console.log(`ğŸ“‹ å‰µå»ºè¡¨: ${name}`);
                                }
                            });
                        } catch (upgradeError) {
                            console.error('å‡ç´šè³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤:', upgradeError);
                            reject(upgradeError);
                        }
                    };
                });
            } catch (error) {
                isUpgrading = false;
                // å˜—è©¦é‡æ–°æ‰“é–‹è³‡æ–™åº«
                try {
                    await initDatabase();
                } catch (reopenError) {
                    console.error('é‡æ–°æ‰“é–‹è³‡æ–™åº«å¤±æ•—:', reopenError);
                }
                throw error;
            }
        }
        
        // åˆå§‹åŒ– IndexedDB
        async function initDatabase() {
            if (db) return db;
            
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = (event) => {
                    const error = request.error || event.target?.error;
                    const errorMessage = error ? 
                        `ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«: ${error.name} - ${error.message}` : 
                        'ç„¡æ³•é–‹å•Ÿè³‡æ–™åº«: æœªçŸ¥éŒ¯èª¤';
                    console.error('è³‡æ–™åº«é–‹å•ŸéŒ¯èª¤:', errorMessage, error);
                    reject(new Error(errorMessage));
                };
                
                request.onsuccess = () => {
                    db = request.result;
                    console.log('âœ… è³‡æ–™åº«å·²é–‹å•Ÿ');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    try {
                        const database = event.target.result;
                        
                        // å»ºç«‹è³‡æ–™è¡¨ï¼ˆObject Storesï¼‰
                        if (!database.objectStoreNames.contains('members')) {
                            database.createObjectStore('members', { keyPath: 'id' });
                        }
                        if (!database.objectStoreNames.contains('boats')) {
                            const boatStore = database.createObjectStore('boats', { keyPath: 'id', autoIncrement: true });
                            boatStore.createIndex('name', 'name', { unique: true });
                        }
                        if (!database.objectStoreNames.contains('coaches')) {
                            database.createObjectStore('coaches', { keyPath: 'id' });
                        }
                    if (!database.objectStoreNames.contains('bookings')) {
                        const bookingStore = database.createObjectStore('bookings', { keyPath: 'id', autoIncrement: true });
                        bookingStore.createIndex('start_at', 'start_at');
                    }
                    if (!database.objectStoreNames.contains('booking_coaches')) {
                        database.createObjectStore('booking_coaches', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!database.objectStoreNames.contains('booking_drivers')) {
                        database.createObjectStore('booking_drivers', { keyPath: 'id', autoIncrement: true });
                    }
                    if (!database.objectStoreNames.contains('booking_members')) {
                        database.createObjectStore('booking_members', { keyPath: 'id', autoIncrement: true });
                    }
                        if (!database.objectStoreNames.contains('daily_announcements')) {
                            database.createObjectStore('daily_announcements', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!database.objectStoreNames.contains('audit_log')) {
                            database.createObjectStore('audit_log', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!database.objectStoreNames.contains('transactions')) {
                            database.createObjectStore('transactions', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!database.objectStoreNames.contains('board_storage')) {
                            database.createObjectStore('board_storage', { keyPath: 'id', autoIncrement: true });
                        }
                        if (!database.objectStoreNames.contains('member_notes')) {
                            database.createObjectStore('member_notes', { keyPath: 'id', autoIncrement: true });
                        }
                        
                        console.log('âœ… è³‡æ–™è¡¨å·²å»ºç«‹');
                    } catch (upgradeError) {
                        console.error('å‡ç´šè³‡æ–™åº«æ™‚ç™¼ç”ŸéŒ¯èª¤:', upgradeError);
                        reject(new Error(`å‡ç´šè³‡æ–™åº«å¤±æ•—: ${upgradeError.message}`));
                    }
                };
                
                request.onblocked = () => {
                    console.warn('è³‡æ–™åº«å‡ç´šè¢«é˜»æ­¢ï¼Œè«‹é—œé–‰å…¶ä»–æ¨™ç±¤é ');
                    reject(new Error('è³‡æ–™åº«å‡ç´šè¢«é˜»æ­¢ï¼Œè«‹é—œé–‰å…¶ä»–ä½¿ç”¨æ­¤è³‡æ–™åº«çš„æ¨™ç±¤é '));
                };
            });
        }
        
        // åˆªé™¤ä¸¦é‡æ–°å‰µå»ºè³‡æ–™åº«ï¼ˆç”¨æ–¼ä¿®å¾©æå£çš„è³‡æ–™åº«ï¼‰
        async function resetDatabase() {
            return new Promise((resolve, reject) => {
                // é—œé–‰ç•¶å‰é€£æ¥
                if (db) {
                    db.close();
                    db = null;
                }
                
                // åˆªé™¤è³‡æ–™åº«
                const deleteRequest = indexedDB.deleteDatabase(DB_NAME);
                
                deleteRequest.onerror = () => {
                    reject(new Error('ç„¡æ³•åˆªé™¤è³‡æ–™åº«: ' + (deleteRequest.error?.message || 'æœªçŸ¥éŒ¯èª¤')));
                };
                
                deleteRequest.onsuccess = () => {
                    console.log('âœ… èˆŠè³‡æ–™åº«å·²åˆªé™¤');
                    // é‡æ–°åˆå§‹åŒ–
                    initDatabase()
                        .then(() => {
                            console.log('âœ… è³‡æ–™åº«å·²é‡æ–°å‰µå»º');
                            resolve(db);
                        })
                        .catch(reject);
                };
            });
        }
        
        // è§£æ SQL INSERT èªå¥ä¸¦æ’å…¥åˆ° IndexedDB
        async function insertFromSQL(tableName, values) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([tableName], 'readwrite');
                const store = transaction.objectStore(tableName);
                
                const record = {};
                values.forEach((value, index) => {
                    const column = Object.keys(values)[index] || `column${index}`;
                    record[column] = value === 'NULL' || value === null ? null : value;
                });
                
                const request = store.add(record);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }
        
        
        // æ¸…ç©ºè³‡æ–™åº«
        async function clearDatabase() {
            if (!db) await initDatabase();
            
            const storeNames = ['members', 'boats', 'coaches', 'bookings', 'booking_coaches', 'booking_drivers', 'booking_members', 'daily_announcements', 'audit_log', 'transactions', 'board_storage', 'member_notes'];
            
            for (const storeName of storeNames) {
                try {
                    const transaction = db.transaction([storeName], 'readwrite');
                    const store = transaction.objectStore(storeName);
                    await new Promise((resolve, reject) => {
                        const request = store.clear();
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (error) {
                    console.warn('æ¸…ç©º ' + storeName + ' å¤±æ•—:', error);
                }
            }
            
            console.log('âœ… è³‡æ–™åº«å·²æ¸…ç©º');
        }
        
        // è¼‰å…¥ SQL æª”æ¡ˆ
        async function loadSQLFile(file) {
            // åœ¨å‡½æ•¸é–‹å§‹æ™‚å°±è¨­ç½®è¼‰å…¥æ¨™è¨˜ï¼Œé˜²æ­¢é‡è¤‡è§¸ç™¼
            if (isFileLoading) {
                console.log('æª”æ¡ˆæ­£åœ¨è¼‰å…¥ä¸­ï¼Œå¿½ç•¥é‡è¤‡èª¿ç”¨');
                return;
            }
            isFileLoading = true;
            
            console.log('é–‹å§‹è¼‰å…¥ SQL æª”æ¡ˆ:', file.name, 'å¤§å°:', file.size, 'bytes');
            
            const loadingDiv = document.getElementById('db-loading');
            if (loadingDiv) {
                loadingDiv.classList.remove('hidden');
            }
            
            // ç¦ç”¨ input å’Œ labelï¼Œé˜²æ­¢é‡è¤‡é»æ“Š
            const fileInput = document.getElementById('sql-file');
            const label = fileInput?.closest('label');
            if (fileInput) fileInput.disabled = true;
            if (label) label.style.pointerEvents = 'none';
            
            try {
                // å˜—è©¦åˆå§‹åŒ–è³‡æ–™åº«ï¼Œå¦‚æœå¤±æ•—å‰‡å˜—è©¦é‡ç½®
                try {
                    await initDatabase();
                    console.log('è³‡æ–™åº«å·²åˆå§‹åŒ–');
                } catch (initError) {
                    console.warn('è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ï¼Œå˜—è©¦é‡ç½®è³‡æ–™åº«...', initError);
                    const shouldReset = confirm('è³‡æ–™åº«åˆå§‹åŒ–å¤±æ•—ï¼Œæ˜¯å¦è¦é‡ç½®è³‡æ–™åº«ï¼Ÿ\n\né€™å°‡åˆªé™¤æ‰€æœ‰ç¾æœ‰è³‡æ–™ä¸¦é‡æ–°å‰µå»ºè³‡æ–™åº«ã€‚\n\né»æ“Šã€Œç¢ºå®šã€é‡ç½®\né»æ“Šã€Œå–æ¶ˆã€å–æ¶ˆè¼‰å…¥');
                    if (shouldReset) {
                        try {
                            await resetDatabase();
                            console.log('è³‡æ–™åº«å·²é‡ç½®ä¸¦é‡æ–°åˆå§‹åŒ–');
                        } catch (resetError) {
                            console.error('é‡ç½®è³‡æ–™åº«å¤±æ•—:', resetError);
                            throw new Error(`ç„¡æ³•åˆå§‹åŒ–è³‡æ–™åº«: ${initError.message}ã€‚é‡ç½®ä¹Ÿå¤±æ•—: ${resetError.message}`);
                        }
                    } else {
                        throw new Error('ç”¨æˆ¶å–æ¶ˆé‡ç½®è³‡æ–™åº«');
                    }
                }
                
                // è©¢å•æ˜¯å¦è¦æ¸…ç©ºç¾æœ‰è³‡æ–™
                const shouldClear = confirm('æ˜¯å¦è¦æ¸…ç©ºç¾æœ‰è³‡æ–™åº«ä¸¦è¼‰å…¥æ–°è³‡æ–™ï¼Ÿ\n\né»æ“Šã€Œç¢ºå®šã€æ¸…ç©ºä¸¦è¼‰å…¥\né»æ“Šã€Œå–æ¶ˆã€è¿½åŠ åˆ°ç¾æœ‰è³‡æ–™');
                
                if (shouldClear) {
                    await clearDatabase();
                    console.log('å·²æ¸…ç©ºç¾æœ‰è³‡æ–™');
                }
                
                const text = await file.text();
                console.log('æª”æ¡ˆè®€å–å®Œæˆï¼Œé•·åº¦:', text.length);
                
                // å…ˆæƒææ‰€æœ‰ CREATE TABLE èªå¥ï¼Œæ”¶é›†éœ€è¦å‰µå»ºçš„è¡¨
                console.log('ğŸ“‹ æƒæ CREATE TABLE èªå¥...');
                const createTableMatches = text.match(/CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?(\w+)/gi);
                if (createTableMatches) {
                    createTableMatches.forEach(match => {
                        const tableName = match.match(/CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?(\w+)/i)[1];
                        if (!db.objectStoreNames.contains(tableName)) {
                            // æª¢æŸ¥æ˜¯å¦æœ‰ id SERIAL/BIGSERIAL
                            const tableDef = text.match(new RegExp(`CREATE\\s+TABLE\\s+(?:IF\\s+NOT\\s+EXISTS\\s+)?${tableName}[\\s\\S]*?(?=CREATE|$)`, 'i'));
                            let keyPath = 'id';
                            let autoIncrement = false;
                            if (tableDef) {
                                autoIncrement = /id\s+(?:SERIAL|BIGSERIAL)/i.test(tableDef[0]);
                            }
                            pendingTables.set(tableName, { keyPath, autoIncrement });
                            console.log(`ğŸ“‹ ç™¼ç¾éœ€è¦å‰µå»ºçš„è¡¨: ${tableName}`);
                        }
                    });
                }
                
                // ä¸€æ¬¡æ€§å‰µå»ºæ‰€æœ‰éœ€è¦çš„è¡¨
                if (pendingTables.size > 0) {
                    console.log(`ğŸ“‹ æº–å‚™å‰µå»º ${pendingTables.size} å€‹è¡¨...`);
                    await createAllPendingTables();
                }
                
                // æ›´å¥½çš„ SQL èªå¥åˆ†å‰²ï¼ˆè™•ç†å¤šè¡Œå’Œè¨»è§£ï¼‰
                const statements = [];
                let currentStatement = '';
                let inString = false;
                let stringChar = '';
                
                for (let i = 0; i < text.length; i++) {
                    const char = text[i];
                    const nextChar = text[i + 1];
                    
                    // è™•ç†å­—ä¸²
                    if ((char === "'" || char === '"') && (i === 0 || text[i - 1] !== '\\')) {
                        if (!inString) {
                            inString = true;
                            stringChar = char;
                        } else if (char === stringChar) {
                            inString = false;
                        }
                        currentStatement += char;
                        continue;
                    }
                    
                    // è™•ç†èªå¥çµæŸ
                    if (!inString && char === ';') {
                        currentStatement += char;
                        const trimmed = currentStatement.trim();
                        if (trimmed && !trimmed.startsWith('--') && trimmed.length > 5) {
                            statements.push(trimmed);
                        }
                        currentStatement = '';
                        continue;
                    }
                    
                    // è·³éè¨»è§£
                    if (!inString && char === '-' && nextChar === '-') {
                        // è·³éåˆ°è¡Œå°¾
                        while (i < text.length && text[i] !== '\n') {
                            i++;
                        }
                        continue;
                    }
                    
                    currentStatement += char;
                }
                
                // æ·»åŠ æœ€å¾Œä¸€å€‹èªå¥ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                if (currentStatement.trim() && !currentStatement.trim().startsWith('--')) {
                    statements.push(currentStatement.trim());
                }
                
                console.log('è§£æå‡º', statements.length, 'å€‹ SQL èªå¥');
                
                let successCount = 0;
                let skipCount = 0;
                const skippedReasons = {
                    'CREATE TABLE': 0,
                    'ALTER TABLE': 0,
                    'CREATE INDEX': 0,
                    'INSERT æ ¼å¼ä¸ç¬¦': 0,
                    'åŸ·è¡ŒéŒ¯èª¤': 0,
                    'å…¶ä»–': 0
                };
                // è©³ç´°è¨˜éŒ„æ¯å€‹è·³éçš„èªå¥ï¼ˆç”¨æ–¼èª¿è©¦ï¼‰
                const skippedStatements = {
                    'CREATE TABLE': [],
                    'ALTER TABLE': [],
                    'CREATE INDEX': [],
                    'INSERT æ ¼å¼ä¸ç¬¦': [],
                    'åŸ·è¡ŒéŒ¯èª¤': [],
                    'å…¶ä»–': []
                };
                
                console.log('ğŸ“Š é–‹å§‹è™•ç† SQL èªå¥ï¼Œç¸½æ•¸:', statements.length);
                
                for (let idx = 0; idx < statements.length; idx++) {
                    const statement = statements[idx];
                    const trimmed = statement.trim();
                    if (!trimmed) continue;
                    
                    try {
                        const upperSql = trimmed.toUpperCase();
                        
                        // è™•ç† CREATE TABLE èªå¥ - å‹•æ…‹å‰µå»ºè¡¨
                        if (upperSql.includes('CREATE TABLE')) {
                            try {
                                const createTableMatch = trimmed.match(/CREATE\s+TABLE\s+(?:IF\s+NOT\s+EXISTS\s+)?(\w+)/i);
                                if (createTableMatch) {
                                    const tableName = createTableMatch[1];
                                    
                                    // æª¢æŸ¥è¡¨æ˜¯å¦å·²å­˜åœ¨
                                    if (!db.objectStoreNames.contains(tableName)) {
                                        // å˜—è©¦å¾ CREATE TABLE èªå¥ä¸­æå–ä¸»éµ
                                        let keyPath = 'id'; // é è¨­ä¸»éµ
                                        let autoIncrement = false;
                                        
                                        // æª¢æŸ¥æ˜¯å¦æœ‰ id æ¬„ä½ä¸”æ˜¯ä¸»éµæˆ– SERIAL/BIGSERIAL
                                        if (trimmed.match(/id\s+(?:SERIAL|BIGSERIAL|INTEGER|INT|BIGINT)/i)) {
                                            keyPath = 'id';
                                            autoIncrement = trimmed.match(/id\s+(?:SERIAL|BIGSERIAL)/i) !== null;
                                        }
                                        
                                        // åœ¨ IndexedDB ä¸­å‰µå»ºè¡¨
                                        // æ³¨æ„ï¼šIndexedDB éœ€è¦åœ¨ upgrade äº‹ä»¶ä¸­å‰µå»ºï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦é‡æ–°æ‰“é–‹è³‡æ–™åº«
                                        // ä½†ç‚ºäº†ç°¡åŒ–ï¼Œæˆ‘å€‘å…ˆè¨˜éŒ„è¡¨åï¼Œç¨å¾Œçµ±ä¸€è™•ç†
                                        console.log(`ğŸ“‹ [${idx + 1}/${statements.length}] ç™¼ç¾ CREATE TABLE: ${tableName}`);
                                        
                                        // ä½¿ç”¨ä¸€å€‹è¼”åŠ©å‡½æ•¸ä¾†å‰µå»ºè¡¨
                                        await createTableIfNotExists(tableName, keyPath, autoIncrement);
                                        
                                        console.log(`âœ… [${idx + 1}/${statements.length}] è¡¨å·²å‰µå»º: ${tableName}`);
                                    } else {
                                        console.log(`â„¹ï¸  [${idx + 1}/${statements.length}] è¡¨å·²å­˜åœ¨: ${tableName}`);
                                    }
                                } else {
                                    skipCount++;
                                    skippedReasons['CREATE TABLE']++;
                                    const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                    skippedStatements['CREATE TABLE'].push({ index: idx + 1, preview });
                                    console.warn(`â­ï¸  [${idx + 1}/${statements.length}] CREATE TABLE æ ¼å¼ä¸ç¬¦:`, preview);
                                }
                            } catch (createError) {
                                skipCount++;
                                skippedReasons['åŸ·è¡ŒéŒ¯èª¤']++;
                                const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                skippedStatements['åŸ·è¡ŒéŒ¯èª¤'].push({ 
                                    index: idx + 1, 
                                    preview, 
                                    error: `CREATE TABLE å¤±æ•—: ${createError.message}` 
                                });
                                console.error(`âŒ [${idx + 1}/${statements.length}] CREATE TABLE å¤±æ•—:`, createError.message);
                            }
                            continue;
                        }
                        
                        // è·³é ALTER TABLEï¼ˆIndexedDB ä¸æ”¯æ´ï¼‰
                        if (upperSql.includes('ALTER TABLE')) {
                            skipCount++;
                            skippedReasons['ALTER TABLE']++;
                            const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                            skippedStatements['ALTER TABLE'].push({ index: idx + 1, preview });
                            console.log(`â­ï¸  [${idx + 1}/${statements.length}] è·³é ALTER TABLE:`, preview);
                            continue;
                        }
                        
                        // è·³é CREATE INDEXï¼ˆIndexedDB ç´¢å¼•éœ€è¦åœ¨å‰µå»ºè¡¨æ™‚å®šç¾©ï¼‰
                        if (upperSql.includes('CREATE INDEX')) {
                            skipCount++;
                            skippedReasons['CREATE INDEX']++;
                            const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                            skippedStatements['CREATE INDEX'].push({ index: idx + 1, preview });
                            console.log(`â­ï¸  [${idx + 1}/${statements.length}] è·³é CREATE INDEX:`, preview);
                            continue;
                        }
                        
                        // è™•ç† DELETE FROM èªå¥
                        if (upperSql.includes('DELETE FROM')) {
                            try {
                                const deleteMatch = trimmed.match(/DELETE\s+FROM\s+(\w+)/i);
                                if (deleteMatch) {
                                    const tableName = deleteMatch[1];
                                    
                                    // ç¢ºä¿è¡¨å­˜åœ¨
                                    await createTableIfNotExists(tableName, 'id', false);
                                    
                                    // åŸ·è¡Œ DELETEï¼ˆæ¸…ç©ºè¡¨ï¼‰
                                    const transaction = db.transaction([tableName], 'readwrite');
                                    const store = transaction.objectStore(tableName);
                                    await new Promise((resolve, reject) => {
                                        const request = store.clear();
                                        request.onsuccess = () => resolve();
                                        request.onerror = () => reject(request.error);
                                    });
                                    
                                    console.log(`ğŸ—‘ï¸  [${idx + 1}/${statements.length}] DELETE FROM ${tableName} - è¡¨å·²æ¸…ç©º`);
                                } else {
                                    skipCount++;
                                    skippedReasons['å…¶ä»–']++;
                                    const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                    skippedStatements['å…¶ä»–'].push({ index: idx + 1, preview });
                                    console.warn(`â­ï¸  [${idx + 1}/${statements.length}] DELETE FROM æ ¼å¼ä¸ç¬¦:`, preview);
                                }
                            } catch (deleteError) {
                                skipCount++;
                                skippedReasons['åŸ·è¡ŒéŒ¯èª¤']++;
                                const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                skippedStatements['åŸ·è¡ŒéŒ¯èª¤'].push({ 
                                    index: idx + 1, 
                                    preview, 
                                    error: `DELETE FROM å¤±æ•—: ${deleteError.message}` 
                                });
                                console.error(`âŒ [${idx + 1}/${statements.length}] DELETE FROM å¤±æ•—:`, deleteError.message);
                            }
                            continue;
                        }
                        
                        // è™•ç† INSERT
                        if (upperSql.includes('INSERT INTO')) {
                            // æ”¹é€²çš„æ­£å‰‡è¡¨é”å¼ï¼Œæ”¯æ´æ›´è¤‡é›œçš„æ ¼å¼ï¼ˆåŒ…æ‹¬å¤šè¡Œ VALUESï¼‰
                            const insertMatch = trimmed.match(/INSERT\s+INTO\s+(\w+)\s*\(([^)]+)\)\s*VALUES\s*(.+)/is);
                            if (insertMatch) {
                                const tableName = insertMatch[1];
                                const columnsStr = insertMatch[2];
                                const allValuesStr = insertMatch[3];
                                
                                // æª¢æŸ¥è¡¨æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨å‰‡è‡ªå‹•å‰µå»º
                                if (!db.objectStoreNames.contains(tableName)) {
                                    console.log(`âš ï¸  è¡¨ "${tableName}" ä¸å­˜åœ¨ï¼Œå˜—è©¦è‡ªå‹•å‰µå»º...`);
                                    try {
                                        await createTableIfNotExists(tableName, 'id', false);
                                        console.log(`âœ… è¡¨ "${tableName}" å·²è‡ªå‹•å‰µå»º`);
                                    } catch (createError) {
                                        skipCount++;
                                        skippedReasons['åŸ·è¡ŒéŒ¯èª¤']++;
                                        const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                        skippedStatements['åŸ·è¡ŒéŒ¯èª¤'].push({ 
                                            index: idx + 1, 
                                            preview, 
                                            error: `è¡¨ "${tableName}" ä¸å­˜åœ¨ä¸”ç„¡æ³•å‰µå»º: ${createError.message}` 
                                        });
                                        console.warn(`â­ï¸  [${idx + 1}/${statements.length}] è¡¨ä¸å­˜åœ¨ä¸”ç„¡æ³•å‰µå»º: ${tableName}`);
                                        continue;
                                    }
                                }
                                
                                // è§£ææ¬„ä½åç¨±
                                const columns = columnsStr.split(',').map(c => c.trim().replace(/["']/g, ''));
                                
                                // è§£æå¤šå€‹ VALUES å­å¥ï¼ˆè™•ç† VALUES (...), (...), (...) çš„æƒ…æ³ï¼‰
                                function parseMultipleValues(allValuesStr) {
                                    const valueGroups = [];
                                    let current = '';
                                    let parenDepth = 0;
                                    let inString = false;
                                    let stringChar = '';
                                    
                                    for (let i = 0; i < allValuesStr.length; i++) {
                                        const char = allValuesStr[i];
                                        const nextChar = allValuesStr[i + 1];
                                        
                                        if (!inString && (char === "'" || char === '"')) {
                                            inString = true;
                                            stringChar = char;
                                            current += char;
                                        } else if (inString && char === stringChar) {
                                            if (nextChar === stringChar) {
                                                current += char + nextChar;
                                                i++;
                                            } else {
                                                inString = false;
                                                stringChar = '';
                                                current += char;
                                            }
                                        } else if (!inString && char === '(') {
                                            if (parenDepth === 0) {
                                                current = ''; // é–‹å§‹æ–°çš„å€¼çµ„
                                            }
                                            parenDepth++;
                                            current += char;
                                        } else if (!inString && char === ')') {
                                            parenDepth--;
                                            current += char;
                                            if (parenDepth === 0) {
                                                // å®Œæˆä¸€å€‹å€¼çµ„
                                                valueGroups.push(current.trim());
                                                current = '';
                                            }
                                        } else {
                                            current += char;
                                        }
                                    }
                                    
                                    return valueGroups;
                                }
                                
                                // è§£ææ‰€æœ‰ VALUES å­å¥
                                const valueGroups = parseMultipleValues(allValuesStr);
                                
                                if (valueGroups.length === 0) {
                                    skipCount++;
                                    skippedReasons['INSERT æ ¼å¼ä¸ç¬¦']++;
                                    const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                    skippedStatements['INSERT æ ¼å¼ä¸ç¬¦'].push({ index: idx + 1, preview });
                                    console.warn(`â­ï¸  [${idx + 1}/${statements.length}] ç„¡æ³•è§£æ VALUES:`, preview);
                                    continue;
                                }
                                
                                // è™•ç†æ¯å€‹ VALUES çµ„
                                let groupSuccessCount = 0;
                                let groupErrorCount = 0;
                                
                                for (const valuesStr of valueGroups) {
                                    // ç§»é™¤å¤–å±¤æ‹¬è™Ÿ
                                    const cleanValuesStr = valuesStr.trim().replace(/^\(|\)$/g, '');
                                
                                // æ”¹é€²çš„å€¼è§£æå‡½æ•¸ï¼Œè™•ç†åŒ…å«é€—è™Ÿçš„å­—ä¸²
                                function parseValues(valuesStr) {
                                    const values = [];
                                    let current = '';
                                    let inString = false;
                                    let stringChar = '';
                                    let parenDepth = 0;
                                    
                                    for (let i = 0; i < valuesStr.length; i++) {
                                        const char = valuesStr[i];
                                        const nextChar = valuesStr[i + 1];
                                        
                                        if (!inString && (char === "'" || char === '"')) {
                                            inString = true;
                                            stringChar = char;
                                            current += char;
                                        } else if (inString && char === stringChar) {
                                            if (nextChar === stringChar) {
                                                // è½‰ç¾©çš„å¼•è™Ÿ
                                                current += char + nextChar;
                                                i++; // è·³éä¸‹ä¸€å€‹å­—å…ƒ
                                            } else {
                                                // å­—ä¸²çµæŸ
                                                inString = false;
                                                stringChar = '';
                                                current += char;
                                            }
                                        } else if (!inString && char === '(') {
                                            parenDepth++;
                                            current += char;
                                        } else if (!inString && char === ')') {
                                            parenDepth--;
                                            current += char;
                                        } else if (!inString && parenDepth === 0 && char === ',') {
                                            // å€¼åˆ†éš”ç¬¦
                                            values.push(current.trim());
                                            current = '';
                                        } else {
                                            current += char;
                                        }
                                    }
                                    
                                    // æ·»åŠ æœ€å¾Œä¸€å€‹å€¼
                                    if (current.trim()) {
                                        values.push(current.trim());
                                    }
                                    
                                    return values;
                                }
                                
                                    // è§£æå€¼
                                    const rawValues = parseValues(cleanValuesStr);
                                    
                                    // è™•ç†æ¯å€‹å€¼
                                    const values = rawValues.map(v => {
                                        v = v.trim();
                                        if (!v || v === 'NULL' || v === 'null') return null;
                                        
                                        // è™•ç†å­—ä¸²å€¼
                                        if ((v.startsWith("'") && v.endsWith("'")) || (v.startsWith('"') && v.endsWith('"'))) {
                                            return v.slice(1, -1)
                                                .replace(/''/g, "'")
                                                .replace(/""/g, '"')
                                                .replace(/\\'/g, "'")
                                                .replace(/\\"/g, '"')
                                                .replace(/\\n/g, '\n')
                                                .replace(/\\t/g, '\t')
                                                .replace(/\\\\/g, '\\');
                                        }
                                        
                                        // è™•ç†å¸ƒæ—å€¼
                                        if (v.toUpperCase() === 'TRUE' || v.toUpperCase() === 'FALSE') {
                                            return v.toUpperCase() === 'TRUE';
                                        }
                                        
                                        // è™•ç†æ•¸å­—
                                        if (/^-?\d+$/.test(v)) {
                                            return parseInt(v, 10);
                                        }
                                        if (/^-?\d*\.\d+$/.test(v)) {
                                            return parseFloat(v);
                                        }
                                        
                                        // è™•ç† JSON/é™£åˆ—ï¼ˆå¦‚ PostgreSQL çš„ ARRAYï¼‰
                                        if (v.startsWith('{') && v.endsWith('}')) {
                                            try {
                                                return JSON.parse(v);
                                            } catch (e) {
                                                return v; // å¦‚æœç„¡æ³•è§£æï¼Œè¿”å›åŸå§‹å€¼
                                            }
                                        }
                                        
                                        // å…¶ä»–æƒ…æ³è¿”å›åŸå§‹å€¼
                                        return v;
                                    });
                                    
                                    // å»ºç«‹è¨˜éŒ„ç‰©ä»¶
                                    const record = {};
                                    columns.forEach((col, colIdx) => {
                                        if (colIdx < values.length) {
                                            record[col] = values[colIdx];
                                        } else {
                                            record[col] = null;
                                        }
                                    });
                                    
                                    // å˜—è©¦æ’å…¥è¨˜éŒ„ï¼ˆä½¿ç”¨ put è€Œä¸æ˜¯ addï¼Œä»¥è™•ç†ä¸»éµè¡çªï¼‰
                                    try {
                                        const transaction = db.transaction([tableName], 'readwrite');
                                        const store = transaction.objectStore(tableName);
                                        
                                        // å…ˆæª¢æŸ¥æ˜¯å¦æœ‰ä¸»éµ
                                        const keyPath = store.keyPath;
                                        let shouldUsePut = false;
                                        
                                        if (keyPath && record[keyPath] !== undefined) {
                                            // æœ‰ä¸»éµï¼Œä½¿ç”¨ putï¼ˆæœƒè¦†è“‹å·²å­˜åœ¨çš„è¨˜éŒ„ï¼‰
                                            shouldUsePut = true;
                                        }
                                        
                                        await new Promise((resolve, reject) => {
                                            const request = shouldUsePut ? store.put(record) : store.add(record);
                                            request.onsuccess = () => resolve();
                                            request.onerror = (e) => {
                                                const error = request.error;
                                                // å¦‚æœæ˜¯ä¸»éµè¡çªä¸”ä½¿ç”¨ addï¼Œå˜—è©¦æ”¹ç”¨ put
                                                if (!shouldUsePut && error.name === 'ConstraintError') {
                                                    const putRequest = store.put(record);
                                                    putRequest.onsuccess = () => resolve();
                                                    putRequest.onerror = () => reject(putRequest.error);
                                                } else {
                                                    reject(error);
                                                }
                                            };
                                        });
                                        
                                        groupSuccessCount++;
                                        successCount++;
                                        if (successCount % 100 === 0) {
                                            console.log(`âœ… å·²è™•ç† ${successCount} æ¢è¨˜éŒ„...`);
                                        }
                                    } catch (insertError) {
                                        groupErrorCount++;
                                        // æ’å…¥å¤±æ•—ï¼Œè¨˜éŒ„éŒ¯èª¤ä½†ç¹¼çºŒè™•ç†ä¸‹ä¸€æ¢
                                        skipCount++;
                                        skippedReasons['åŸ·è¡ŒéŒ¯èª¤']++;
                                        const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                        skippedStatements['åŸ·è¡ŒéŒ¯èª¤'].push({ 
                                            index: idx + 1, 
                                            preview, 
                                            error: `${insertError.name}: ${insertError.message}` 
                                        });
                                        console.warn(`âš ï¸  [${idx + 1}/${statements.length}] æ’å…¥å¤±æ•— (${tableName}):`, insertError.message);
                                    }
                                }
                                
                                // å¦‚æœæœ‰å¤šå€‹å€¼çµ„ï¼Œè¨˜éŒ„è™•ç†çµæœ
                                if (valueGroups.length > 1 && groupErrorCount > 0) {
                                    console.log(`   â†’ æ­¤èªå¥åŒ…å« ${valueGroups.length} å€‹å€¼çµ„ï¼ŒæˆåŠŸ ${groupSuccessCount} å€‹ï¼Œå¤±æ•— ${groupErrorCount} å€‹`);
                                }
                            } else {
                                skipCount++;
                                skippedReasons['INSERT æ ¼å¼ä¸ç¬¦']++;
                                const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                                skippedStatements['INSERT æ ¼å¼ä¸ç¬¦'].push({ index: idx + 1, preview });
                                console.warn(`â­ï¸  [${idx + 1}/${statements.length}] INSERT èªå¥æ ¼å¼ä¸ç¬¦ï¼Œå·²è·³é:`, preview);
                            }
                        } else {
                            // ä¸æ˜¯ INSERT èªå¥ï¼Œè·³é
                            skipCount++;
                            skippedReasons['å…¶ä»–']++;
                            const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                            skippedStatements['å…¶ä»–'].push({ index: idx + 1, preview });
                            console.log(`â­ï¸  [${idx + 1}/${statements.length}] è·³éé INSERT èªå¥:`, preview);
                        }
                    } catch (err) {
                        skipCount++;
                        skippedReasons['åŸ·è¡ŒéŒ¯èª¤']++;
                        const preview = trimmed.substring(0, 200).replace(/\s+/g, ' ');
                        skippedStatements['åŸ·è¡ŒéŒ¯èª¤'].push({ index: idx + 1, preview, error: err.message });
                        console.error(`âŒ [${idx + 1}/${statements.length}] åŸ·è¡Œèªå¥æ™‚å‡ºéŒ¯ï¼Œå·²è·³é:`, preview, 'éŒ¯èª¤:', err.message);
                    }
                }
                
                // ç”Ÿæˆè·³éåŸå› æ‘˜è¦
                const skipDetails = Object.entries(skippedReasons)
                    .filter(([_, count]) => count > 0)
                    .map(([reason, count]) => `${reason}: ${count}`)
                    .join(', ');
                
                console.log(`\nğŸ“Š ========== è¼‰å…¥å®Œæˆçµ±è¨ˆ ==========`);
                console.log(`âœ… æˆåŠŸ: ${successCount} æ¢`);
                console.log(`â­ï¸  è·³é: ${skipCount} æ¢`);
                console.log(`ğŸ“ˆ ç¸½è¨ˆ: ${statements.length} æ¢ SQL èªå¥`);
                console.log(`ğŸ“‰ æˆåŠŸç‡: ${((successCount / statements.length) * 100).toFixed(2)}%`);
                
                if (skipCount > 0) {
                    console.log(`\nğŸ“‹ è·³éåŸå› çµ±è¨ˆ:`);
                    Object.entries(skippedReasons)
                        .filter(([_, count]) => count > 0)
                        .forEach(([reason, count]) => {
                            console.log(`   ${reason}: ${count} æ¢`);
                        });
                    
                    console.log(`\nğŸ” è©³ç´°è·³éè³‡è¨Šï¼ˆå±•é–‹æŸ¥çœ‹ï¼‰:`);
                    Object.entries(skippedStatements)
                        .filter(([_, items]) => items.length > 0)
                        .forEach(([reason, items]) => {
                            console.group(`â­ï¸  ${reason} (${items.length} æ¢)`);
                            items.forEach((item, i) => {
                                console.log(`   [${item.index}] ${item.preview}${item.error ? ` | éŒ¯èª¤: ${item.error}` : ''}`);
                            });
                            console.groupEnd();
                        });
                }
                console.log(`========================================\n`);
                
                let alertMessage = `âœ… è³‡æ–™åº«è¼‰å…¥æˆåŠŸï¼\næˆåŠŸ: ${successCount} æ¢`;
                if (skipCount > 0) {
                    alertMessage += `\nè·³é: ${skipCount} æ¢\n\nè·³éåŸå› ï¼š\n${Object.entries(skippedReasons).filter(([_, count]) => count > 0).map(([reason, count]) => `  â€¢ ${reason}: ${count}`).join('\n')}`;
                }
                showAlert(alertMessage, 'success');
                
                // é‡ç½®æ–‡ä»¶è¼¸å…¥æ¡†ï¼Œä»¥ä¾¿å¯ä»¥å†æ¬¡é¸æ“‡åŒä¸€å€‹æ–‡ä»¶
                const fileInput = document.getElementById('sql-file');
                if (fileInput) {
                    fileInput.value = '';
                }
                const fileNameDiv = document.getElementById('file-name');
                if (fileNameDiv) {
                    fileNameDiv.textContent = '';
                }
                
                setTimeout(() => {
                    if (loadingDiv) loadingDiv.classList.add('hidden');
                    const dbLoader = document.getElementById('db-loader');
                    if (dbLoader) dbLoader.classList.remove('active');
                    const mainContent = document.getElementById('main-content');
                    if (mainContent) {
                        mainContent.classList.remove('hidden');
                        // é¡¯ç¤ºä¸»é é¢ï¼ˆåŒ…å«ã€Œé‡æ–°è¼‰å…¥è³‡æ–™åº«ã€æŒ‰éˆ•ï¼‰
                        showHomePage();
                    }
                }, 1000);
                
            } catch (error) {
                console.error('è¼‰å…¥ SQL æª”æ¡ˆæ™‚ç™¼ç”ŸéŒ¯èª¤:', error);
                if (loadingDiv) loadingDiv.classList.add('hidden');
                showAlert('âŒ è¼‰å…¥å¤±æ•—: ' + (error.message || 'æœªçŸ¥éŒ¯èª¤'), 'error');
            } finally {
                // é‡ç½®è¼‰å…¥æ¨™è¨˜å’Œå•Ÿç”¨ input/label
                isFileLoading = false;
                const fileInput = document.getElementById('sql-file');
                const label = fileInput?.closest('label');
                if (fileInput) {
                    fileInput.disabled = false;
                    fileInput.value = ''; // æ¸…ç©ºé¸æ“‡ï¼Œå…è¨±é‡æ–°é¸æ“‡åŒä¸€å€‹æª”æ¡ˆ
                }
                if (label) label.style.pointerEvents = 'auto';
                const fileNameDiv = document.getElementById('file-name');
                if (fileNameDiv) {
                    fileNameDiv.textContent = '';
                }
            }
        }
        
        // æ¸…ç©ºè³‡æ–™åº«ä¸¦é‡æ–°è¼‰å…¥
        async function clearDatabaseAndReload() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) {
                return;
            }
            
            const loadingDiv = document.getElementById('db-loading');
            if (loadingDiv) {
                loadingDiv.classList.remove('hidden');
            }
            
            try {
                await initDatabase();
                await clearDatabase();
                showAlert('âœ… è³‡æ–™åº«å·²æ¸…ç©ºï¼', 'success');
                
                setTimeout(() => {
                    if (loadingDiv) loadingDiv.classList.add('hidden');
                }, 1000);
            } catch (error) {
                if (loadingDiv) loadingDiv.classList.add('hidden');
                showAlert('âŒ æ¸…ç©ºå¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // å»ºç«‹ç©ºç™½è³‡æ–™åº«
        async function createEmptyDatabase() {
            const loadingDiv = document.getElementById('db-loading');
            loadingDiv.classList.remove('hidden');
            
            try {
                await initDatabase();
                showAlert('âœ… ç©ºç™½è³‡æ–™åº«å»ºç«‹æˆåŠŸï¼', 'success');
                
                setTimeout(() => {
                    loadingDiv.classList.add('hidden');
                    document.getElementById('db-loader').classList.remove('active');
                    document.getElementById('main-content').classList.remove('hidden');
                    // é¡¯ç¤ºä¸»é é¢ï¼ˆåŒ…å«ã€Œé‡æ–°è¼‰å…¥è³‡æ–™åº«ã€æŒ‰éˆ•ï¼‰
                    showHomePage();
                }, 1000);
            } catch (error) {
                loadingDiv.classList.add('hidden');
                showAlert('âŒ å»ºç«‹å¤±æ•—: ' + error.message, 'error');
            }
        }
        
        // æ¸²æŸ“é¸å–®
        function renderMenu() {
            const menuGrid = document.getElementById('menu-grid');
            menuGrid.innerHTML = menuItems.map(item => `
                <div class="menu-item" onclick="handleMenuClick('${item.action}')">
                    <div class="menu-icon">${item.icon}</div>
                    <h2 class="menu-title">${item.title}</h2>
                </div>
            `).join('');
        }
        
        // è™•ç†é¸å–®é»æ“Š
        function handleMenuClick(action) {
            if (action === 'coach-daily') {
                showCoachDailyView();
            } else if (action === 'bao') {
                showBaoHub();
            } else if (action === 'day') {
                showDayView();
            } else {
                alert(`åŠŸèƒ½ã€Œ${action}ã€æ­£åœ¨é–‹ç™¼ä¸­\n\næ­¤ç‚ºé›¢ç·šç‰ˆæœ¬ï¼Œç›®å‰åƒ…æä¾›è³‡æ–™åº«è¼‰å…¥å’Œä»Šæ—¥é ç´„åŠŸèƒ½ã€‚\nå®Œæ•´åŠŸèƒ½è«‹ä½¿ç”¨ç·šä¸Šç‰ˆæœ¬ã€‚`);
            }
        }
        
        // é¡¯ç¤ºä»Šæ—¥é ç´„é é¢
        async function showCoachDailyView(dateParam) {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            const selectedDate = dateParam || new Date().toISOString().split('T')[0];
            
            // ç§»é™¤ container çš„å¯¬åº¦é™åˆ¶ï¼Œè®“è¡¨æ ¼å¯ä»¥å…¨å¯¬é¡¯ç¤º
            appContainer.style.maxWidth = '100%';
            appContainer.style.padding = '0';
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: #f5f5f5; padding-bottom: 80px;">
                    <!-- PageHeader (èˆ‡ç¶²é ç‰ˆå®Œå…¨ä¸€è‡´) -->
                    <div style="
                        margin-bottom: 20px;
                        background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%);
                        padding: 16px;
                        border-radius: 8px;
                        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
                    ">
                        <div style="
                            display: flex;
                            justify-content: space-between;
                            align-items: center;
                        ">
                            <h1 style="
                                font-size: 20px;
                                font-weight: bold;
                                color: white;
                                margin: 0;
                            ">ä»Šæ—¥é ç´„</h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="showHomePage()" style="
                                    padding: 6px 12px;
                                    background: rgba(255, 255, 255, 0.15);
                                    color: white;
                                    text-decoration: none;
                                    border-radius: 4px;
                                    font-size: 13px;
                                    border: 1px solid rgba(255, 255, 255, 0.2);
                                    white-space: nowrap;
                                    display: inline-flex;
                                    align-items: center;
                                    cursor: pointer;
                                    font-weight: 500;
                                ">â† HOME</button>
                            </div>
                        </div>
                    </div>
                    <div id="coach-daily-content" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="text-align: center; margin-top: 10px;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            `;
            
            await loadAndDisplayBookings(selectedDate);
        }
        
        // å…¨åŸŸè®Šæ•¸ï¼šç•¶å‰é¸ä¸­çš„æ—¥æœŸå’Œæ•™ç·´
        let currentDate = new Date().toISOString().split('T')[0];
        let selectedCoachId = '';
        
        // è¿”å›é¦–é 
        function showHomePage() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            // æ¢å¾© container çš„åŸå§‹æ¨£å¼
            appContainer.style.maxWidth = '600px';
            appContainer.style.padding = '40px 20px';
            appContainer.classList.remove('full-width');
            
            mainContent.innerHTML = `
                <div class="header">
                    <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ccircle cx='50' cy='50' r='45' fill='%23000'/%3E%3Ctext x='50' y='65' font-size='40' fill='white' text-anchor='middle' font-weight='bold'%3EES%3C/text%3E%3C/svg%3E" 
                         alt="ES Wake Logo" class="logo" onerror="this.style.display='none'">
                    <h1 class="title">ES WAKE</h1>
                </div>
                <div style="text-align: center; margin-bottom: 20px;">
                    <button onclick="showDatabaseLoader()" style="
                        padding: 10px 20px;
                        background: #667eea;
                        color: white;
                        border: none;
                        border-radius: 8px;
                        cursor: pointer;
                        font-size: 14px;
                        font-weight: 600;
                    ">ğŸ”„ é‡æ–°è¼‰å…¥è³‡æ–™åº«</button>
                </div>
                <div class="menu-grid" id="menu-grid"></div>
                <div class="footer">
                    <p>Â© 2025 ES Wake. All Rights Reserved.</p>
                    <p style="font-size: 12px; opacity: 0.7; margin-top: 8px;">æ»‘æ°´é ç´„ç®¡ç†ç³»çµ± - é›¢ç·šæ¨¡å¼</p>
                </div>
            `;
            renderMenu();
        }
        
        // é¡¯ç¤º BAO Hub é é¢
        function showBaoHub() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            // æ¢å¾© container çš„åŸå§‹æ¨£å¼
            appContainer.style.maxWidth = '750px';
            appContainer.style.padding = '40px 20px';
            appContainer.classList.remove('full-width');
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: linear-gradient(to bottom, #f8f9fa 0%, #e9ecef 100%);">
                    <!-- Header -->
                    <div style="text-align: center; margin-bottom: 50px;">
                        <div style="font-size: 100px; margin-bottom: 20px;">ğŸ”§</div>
                        <h1 style="margin: 0 0 10px 0; font-size: 42px; font-weight: 800; color: #000; letter-spacing: 2px;">
                            BAO
                        </h1>
                        <p style="margin: 0 0 20px 0; font-size: 16px; color: #666; font-weight: 500;">
                            ç®¡ç†è€…å°ˆç”¨å¾Œå°
                        </p>
                        <div style="display: flex; justify-content: center; gap: 10px; margin-top: 20px;">
                            <button onclick="showHomePage()" style="
                                padding: 10px 20px;
                                background: rgba(255, 255, 255, 0.7);
                                color: #333;
                                text-decoration: none;
                                border-radius: 8px;
                                font-size: 14px;
                                border: 1px solid rgba(224, 224, 224, 0.5);
                                font-weight: 500;
                                cursor: pointer;
                            ">â† HOME</button>
                        </div>
                    </div>
                    
                    <!-- æœƒå“¡ç›¸é—œå€å¡Š -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 700; color: #333; padding-bottom: 12px; border-bottom: 2px solid rgba(0, 0, 0, 0.1); letter-spacing: 0.5px;">
                            ğŸ‘¥ æœƒå“¡ç›¸é—œ
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
                            <div class="menu-item" onclick="showMemberManagement()">
                                <div class="menu-icon">ğŸ‘¥</div>
                                <h2 class="menu-title">æœƒå“¡ç®¡ç†</h2>
                            </div>
                            <div class="menu-item" onclick="showMemberTransaction()">
                                <div class="menu-icon">ğŸ’°</div>
                                <h2 class="menu-title">æœƒå“¡å„²å€¼</h2>
                            </div>
                            <div class="menu-item" onclick="showBoardManagement()">
                                <div class="menu-icon">ğŸ„</div>
                                <h2 class="menu-title">ç½®æ¿ç®¡ç†</h2>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Footer -->
                    <div class="footer">
                        <p>Â© 2025 ES Wake. All Rights Reserved.</p>
                    </div>
                </div>
            `;
        }
        
        // é¡¯ç¤ºè³‡æ–™åº«è¼‰å…¥å™¨
        function showDatabaseLoader() {
            const mainContent = document.getElementById('main-content');
            if (mainContent) {
                mainContent.classList.add('hidden');
            }
            const dbLoader = document.getElementById('db-loader');
            if (dbLoader) {
                dbLoader.classList.add('active');
            }
            
            // é‡ç½®æ–‡ä»¶è¼¸å…¥æ¡†
            const fileInput = document.getElementById('sql-file');
            if (fileInput) {
                fileInput.value = '';
            }
            const fileNameDiv = document.getElementById('file-name');
            if (fileNameDiv) {
                fileNameDiv.textContent = '';
            }
            
            // æ¸…é™¤æç¤ºè¨Šæ¯
            const alertDiv = document.getElementById('db-alert');
            if (alertDiv) {
                alertDiv.textContent = '';
                alertDiv.style.display = 'none';
            }
        }
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºé ç´„
        async function loadAndDisplayBookings(dateParam) {
            try {
                if (!db) await initDatabase();
                
                const selectedDate = dateParam || currentDate;
                currentDate = selectedDate;
                
                // è¼‰å…¥èˆ¹éš»
                const boats = await getAllFromStore('boats');
                
                // è¼‰å…¥æ•™ç·´
                const coaches = await getAllFromStore('coaches');
                const activeCoaches = coaches.filter(c => c.status === 'active');
                
                // è¼‰å…¥æŒ‡å®šæ—¥æœŸçš„é ç´„
                const startOfDay = `${selectedDate}T00:00:00`;
                const endOfDay = `${selectedDate}T23:59:59`;
                
                const allBookings = await getAllFromStore('bookings');
                const dateBookings = allBookings.filter(b => {
                    if (b.status !== 'confirmed') return false;
                    const startAt = b.start_at;
                    return startAt >= startOfDay && startAt <= endOfDay;
                }).sort((a, b) => a.start_at.localeCompare(b.start_at));
                
                // è¼‰å…¥é—œè¯è³‡æ–™
                const bookingIds = dateBookings.map(b => b.id);
                const bookingCoaches = await getBookingCoaches(bookingIds);
                const bookingDrivers = await getBookingDrivers(bookingIds);
                const bookingMembers = await getBookingMembers(bookingIds);
                
                // çµ„åˆè³‡æ–™
                let bookingsWithDetails = dateBookings.map(booking => {
                    const boat = boats.find(b => b.id === booking.boat_id);
                    const coaches = bookingCoaches.filter(bc => bc.booking_id === booking.id)
                        .map(bc => activeCoaches.find(c => c.id === bc.coach_id))
                        .filter(Boolean);
                    const drivers = bookingDrivers.filter(bd => bd.booking_id === booking.id)
                        .map(bd => activeCoaches.find(c => c.id === bd.driver_id))
                        .filter(Boolean);
                    const members = bookingMembers.filter(bm => bm.booking_id === booking.id)
                        .map(bm => {
                            const member = bm.members || null;
                            return member ? { member_id: bm.member_id, members: member } : null;
                        })
                        .filter(Boolean);
                    
                    return {
                        ...booking,
                        boats: boat || null,
                        coaches: coaches,
                        drivers: drivers,
                        booking_members: members
                    };
                });
                
                // ç¯©é¸æ•™ç·´
                if (selectedCoachId) {
                    bookingsWithDetails = bookingsWithDetails.filter(booking => {
                        const isCoach = booking.coaches?.some(c => c.id === selectedCoachId);
                        const isDriver = booking.drivers?.some(d => d.id === selectedCoachId);
                        return isCoach || isDriver;
                    });
                }
                
                // æ’åºèˆ¹éš»ï¼ˆèˆ‡ç·šä¸Šç‰ˆæœ¬ä¸€è‡´ï¼‰
                const boatOrder = ['G23', 'G21', 'é»‘è±¹', 'ç²‰ç´…', '200', 'å½ˆç°§åºŠ'];
                const sortedBoats = boats.sort((a, b) => {
                    const indexA = boatOrder.indexOf(a.name);
                    const indexB = boatOrder.indexOf(b.name);
                    return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
                });
                
                // ç”Ÿæˆæ™‚é–“æ§½ï¼ˆæ¯15åˆ†é˜ä¸€å€‹ï¼‰
                const timeSlots = generateTimeSlots();
                
                // éæ¿¾æ™‚é–“æ§½ï¼ˆé¡¯ç¤ºæœ‰é ç´„çš„æ™‚é–“ç¯„åœï¼‰
                const filteredTimeSlots = filterTimeSlots(timeSlots, bookingsWithDetails);
                
                // æ¸²æŸ“é é¢
                renderCoachDailyView({
                    boats: sortedBoats,
                    coaches: activeCoaches,
                    bookings: bookingsWithDetails,
                    timeSlots: filteredTimeSlots,
                    date: selectedDate
                });
                
            } catch (error) {
                console.error('è¼‰å…¥é ç´„å¤±æ•—:', error);
                document.getElementById('coach-daily-content').innerHTML = `
                    <div class="alert alert-error">
                        âŒ è¼‰å…¥å¤±æ•—: ${error.message}
                    </div>
                `;
            }
        }
        
        // ç²å–é ç´„çš„é§•é§›
        async function getBookingDrivers(bookingIds) {
            try {
                const all = await getAllFromStore('booking_drivers');
                return all.filter(function(bd) { return bookingIds.indexOf(bd.booking_id) !== -1; });
            } catch {
                return [];
            }
        }
        
        // ç²å–é ç´„çš„æœƒå“¡
        async function getBookingMembers(bookingIds) {
            try {
                const all = await getAllFromStore('booking_members');
                const filtered = all.filter(function(bm) { return bookingIds.indexOf(bm.booking_id) !== -1; });
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const memberIds = filtered.map(function(bm) { return bm.member_id; }).filter(function(id) { return id; });
                const allMembers = await getAllFromStore('members');
                const membersMap = {};
                allMembers.forEach(function(member) {
                    membersMap[member.id] = member;
                });
                
                // çµ„åˆæœƒå“¡è³‡æ–™
                return filtered.map(function(bm) {
                    return {
                        booking_id: bm.booking_id,
                        member_id: bm.member_id,
                        members: membersMap[bm.member_id] || null
                    };
                });
            } catch {
                return [];
            }
        }
        
        // æ”¹è®Šæ—¥æœŸ
        function handleDateChange(days) {
            const currentDateObj = new Date(currentDate);
            currentDateObj.setDate(currentDateObj.getDate() + days);
            const newDate = currentDateObj.toISOString().split('T')[0];
            loadAndDisplayBookings(newDate);
        }
        
        // è·³è½‰åˆ°ä»Šå¤©
        function goToToday() {
            const today = new Date().toISOString().split('T')[0];
            loadAndDisplayBookings(today);
        }
        
        // æ ¼å¼åŒ–æ—¥æœŸé¡¯ç¤º
        function formatDisplayDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
            const month = date.getMonth() + 1;
            const day = date.getDate();
            const weekday = days[date.getDay()];
            return { dateText: month + 'æœˆ' + day + 'æ—¥', weekday: 'æ˜ŸæœŸ' + weekday };
        }
        
        // ç²å–æœ¬åœ°æ—¥æœŸå­—ä¸²
        function getLocalDateString(date) {
            const d = date || new Date();
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return year + '-' + month + '-' + day;
        }
        
        // ç²å–é¡¯ç¤ºåç¨±ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
        function getDisplayContactName(booking) {
            // å¦‚æœæœ‰é—œè¯çš„æœƒå“¡ï¼Œå„ªå…ˆé¡¯ç¤ºæš±ç¨±
            if (booking.booking_members && booking.booking_members.length > 0) {
                const memberDisplayNames = booking.booking_members
                    .map(function(bm) {
                        if (!bm.members) return null;
                        return bm.members.nickname || bm.members.name;
                    })
                    .filter(function(name) { return name; });
                
                // å¦‚æœæœ‰é‡è¤‡çš„æš±ç¨±ï¼Œåªé¡¯ç¤ºä¸€å€‹
                const uniqueNames = [];
                memberDisplayNames.forEach(function(name) {
                    if (uniqueNames.indexOf(name) === -1) {
                        uniqueNames.push(name);
                    }
                });
                
                // å¦‚æœæ²’æœ‰ä»»ä½•æœ‰æ•ˆçš„æœƒå“¡åç¨±ï¼Œå›é€€åˆ° contact_name
                if (uniqueNames.length === 0) {
                    return booking.contact_name || 'æœªå‘½å';
                }
                
                // å¦‚æœåªæœ‰æœƒå“¡ï¼Œä¸”æ•¸é‡å»åˆ contact_name ä¸­çš„åå­—æ•¸é‡ï¼Œç›´æ¥è¿”å›
                const contactNameParts = booking.contact_name ? booking.contact_name.split(',').map(function(n) { return n.trim(); }).filter(function(n) { return n; }) : [];
                
                // å¦‚æœæœƒå“¡æ•¸é‡ç­‰æ–¼ contact_name ä¸­çš„åå­—æ•¸é‡ï¼Œèªªæ˜éƒ½æ˜¯æœƒå“¡
                if (uniqueNames.length === contactNameParts.length) {
                    return uniqueNames.join(', ');
                }
                
                // å¦å‰‡ï¼Œç›´æ¥è¿”å›ç¬¬ä¸€å€‹æœƒå“¡çš„æš±ç¨±/å§“å
                return uniqueNames[0] || booking.contact_name || 'æœªå‘½å';
            }
            
            // æ²’æœ‰é—œè¯æœƒå“¡ï¼Œç›´æ¥ä½¿ç”¨ contact_name
            return booking.contact_name || 'æœªå‘½å';
        }
        
        // å¾ IndexedDB ç²å–æ‰€æœ‰è³‡æ–™
        function getAllFromStore(storeName) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction([storeName], 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        // ç²å–é ç´„çš„æ•™ç·´
        async function getBookingCoaches(bookingIds) {
            // ç°¡åŒ–ç‰ˆï¼šå‡è¨­ booking_coaches è¡¨å­˜åœ¨
            try {
                const all = await getAllFromStore('booking_coaches');
                return all.filter(bc => bookingIds.includes(bc.booking_id));
            } catch {
                return [];
            }
        }
        
        // ç²å–é ç´„çš„èˆ¹éš»ï¼ˆå·²åŒ…å«åœ¨ bookings ä¸­ï¼‰
        async function getBookingBoats(bookingIds) {
            return [];
        }
        
        // ç”Ÿæˆæ™‚é–“æ§½
        function generateTimeSlots() {
            const slots = [];
            for (let hour = 0; hour < 24; hour++) {
                for (let minute = 0; minute < 60; minute += 15) {
                    slots.push(`${hour.toString().padStart(2, '0')}:${minute.toString().padStart(2, '0')}`);
                }
            }
            return slots;
        }
        
        // éæ¿¾æ™‚é–“æ§½
        function filterTimeSlots(slots, bookings) {
            if (bookings.length === 0) {
                // æ²’æœ‰é ç´„æ™‚ï¼Œé¡¯ç¤º 04:30-18:00
                return slots.filter(slot => {
                    const [hour, minute] = slot.split(':').map(Number);
                    const slotMinutes = hour * 60 + minute;
                    const startMinutes = 4 * 60 + 30;
                    const endMinutes = 18 * 60;
                    return slotMinutes >= startMinutes && slotMinutes <= endMinutes;
                });
            }
            
            // æ‰¾å‡ºæœ€æ—©å’Œæœ€æ™šçš„é ç´„æ™‚é–“
            let earliestMinutes = Infinity;
            let latestMinutes = -Infinity;
            
            bookings.forEach(booking => {
                const start = new Date(booking.start_at);
                const end = new Date(start.getTime() + (booking.duration_min + 15) * 60000);
                const startMinutes = start.getHours() * 60 + start.getMinutes();
                const endMinutes = end.getHours() * 60 + end.getMinutes();
                earliestMinutes = Math.min(earliestMinutes, startMinutes);
                latestMinutes = Math.max(latestMinutes, endMinutes);
            });
            
            // å‰å¾Œå„å¤šé¡¯ç¤º 30 åˆ†é˜
            earliestMinutes = Math.max(0, earliestMinutes - 30);
            latestMinutes = Math.min(24 * 60, latestMinutes + 30);
            
            // è‡³å°‘é¡¯ç¤º 04:30-18:00
            const defaultStart = 4 * 60 + 30;
            const defaultEnd = 18 * 60;
            earliestMinutes = Math.min(earliestMinutes, defaultStart);
            latestMinutes = Math.max(latestMinutes, defaultEnd);
            
            return slots.filter(slot => {
                const [hour, minute] = slot.split(':').map(Number);
                const slotMinutes = hour * 60 + minute;
                return slotMinutes >= earliestMinutes && slotMinutes <= latestMinutes;
            });
        }
        
        // æ¸²æŸ“ä»Šæ—¥é ç´„é é¢ï¼ˆæ™‚é–“è»¸è¡¨æ ¼è¦–åœ–ï¼Œèˆ‡ç·šä¸Šç‰ˆé›»è…¦ç‰ˆä¸€è‡´ï¼‰
        function renderCoachDailyView({ boats, coaches, bookings, timeSlots, date }) {
            const content = document.getElementById('coach-daily-content');
            // å›ºå®šä½¿ç”¨æ¡Œé¢ç‰ˆæ¨£å¼ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
            const isMobile = false;
            const today = getLocalDateString();
            const dateDisplay = formatDisplayDate(date);
            
            // ç²å–æŸå€‹æ™‚é–“é»çš„é ç´„
            const getBookingForCell = (boatId, timeSlot) => {
                return bookings.find(b => {
                    if (b.boat_id !== boatId) return false;
                    const bookingStart = new Date(b.start_at);
                    const bookingStartTime = bookingStart.getHours().toString().padStart(2, '0') + ':' + bookingStart.getMinutes().toString().padStart(2, '0');
                    return bookingStartTime === timeSlot;
                }) || null;
            };
            
            // åˆ¤æ–·æ˜¯å¦åœ¨é ç´„æ™‚é–“å…§
            const isInBookingRange = (boatId, timeSlot) => {
                const parts = timeSlot.split(':');
                const hour = parseInt(parts[0]);
                const minute = parseInt(parts[1]);
                const slotTime = new Date(date);
                slotTime.setHours(hour, minute, 0, 0);
                
                return bookings.some(booking => {
                    if (booking.boat_id !== boatId) return false;
                    const start = new Date(booking.start_at);
                    const end = new Date(start.getTime() + booking.duration_min * 60000);
                    return slotTime > start && slotTime < end;
                });
            };
            
            // åˆ¤æ–·æ˜¯å¦æ˜¯é ç´„çš„é–‹å§‹æ™‚é–“æ ¼
            const isBookingStart = (boatId, timeSlot) => {
                return getBookingForCell(boatId, timeSlot) !== null;
            };
            
            // ç”Ÿæˆè¡¨æ ¼è¡Œ
            const tableRows = [];
            const renderedBookings = new Set();
            
            timeSlots.forEach(timeSlot => {
                const cells = [];
                
                boats.forEach(boat => {
                    const booking = getBookingForCell(boat.id, timeSlot);
                    const isStart = booking !== null && !renderedBookings.has(booking.id);
                    const isInRange = isInBookingRange(boat.id, timeSlot);
                    
                    if (isStart) {
                        renderedBookings.add(booking.id);
                        const start = new Date(booking.start_at);
                        const end = new Date(start.getTime() + booking.duration_min * 60000);
                        const startTime = start.getHours().toString().padStart(2, '0') + ':' + start.getMinutes().toString().padStart(2, '0');
                        const endTime = end.getHours().toString().padStart(2, '0') + ':' + end.getMinutes().toString().padStart(2, '0');
                        const slots = Math.ceil(booking.duration_min / 15);
                        
                        // æå–æ•™ç·´å’Œé§•é§›åç¨±ï¼ˆç¢ºä¿æ­£ç¢ºè™•ç†è³‡æ–™çµæ§‹ï¼‰
                        let coachNames = '';
                        if (booking.coaches && Array.isArray(booking.coaches) && booking.coaches.length > 0) {
                            coachNames = booking.coaches
                                .filter(function(c) { return c && c.name; })
                                .map(function(c) { return c.name; })
                                .join(', ');
                        }
                        
                        let driverNames = '';
                        if (booking.drivers && Array.isArray(booking.drivers) && booking.drivers.length > 0) {
                            driverNames = booking.drivers
                                .filter(function(d) { return d && d.name; })
                                .map(function(d) { return d.name; })
                                .join(', ');
                        }
                        
                        const boatColor = booking.boats && booking.boats.color ? booking.boats.color : '#1976d2';
                        
                        // ç²å–é¡¯ç¤ºåç¨±ï¼ˆèˆ‡ç¶²é ç‰ˆä¸€è‡´ï¼‰
                        const displayContactName = getDisplayContactName(booking);
                        
                        // æ§‹å»ºå¡ç‰‡ HTMLï¼ˆèˆ‡ç¶²é ç‰ˆæ¨£å¼ä¸€è‡´ï¼‰
                        const cardStyle = 'padding: 14px 12px; background: linear-gradient(135deg, ' + boatColor + '08 0%, ' + boatColor + '15 100%); border: 2px solid ' + boatColor + '; vertical-align: top; position: relative; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);';
                        
                        // æ•™ç·´ç·´ç¿’æ¨™ç±¤ï¼ˆå¦‚æœæœ‰ï¼‰
                        const coachPracticeHtml = booking.is_coach_practice ? '<div style="display: inline-block; font-size: 11px; font-weight: 600; padding: 3px 8px; background: #fff3e0; color: #e65100; border-radius: 4px; margin-bottom: 6px; border: 1px solid #ff9800;">ğŸ„ æ•™ç·´ç·´ç¿’</div>' : '';
                        
                        const timeRangeHtml = '<div style="font-size: 16px; font-weight: 700; color: #1a1a1a; margin-bottom: 4px; text-align: center; line-height: 1.3; letter-spacing: 0.5px;">' + startTime + ' - ' + endTime + '</div>';
                        const contactNameHtml = '<div style="font-size: 16px; font-weight: 700; margin-bottom: 6px; text-align: center; color: #1a1a1a;">' + displayContactName + '</div>';
                        const notesHtml = booking.notes ? '<div style="font-size: 12px; color: #666; margin-bottom: 4px; text-align: center; font-style: italic;">' + booking.notes + '</div>' : '';
                        const scheduleNotesHtml = booking.schedule_notes ? '<div style="font-size: 12px; color: #e65100; margin-bottom: 4px; text-align: center; font-weight: 500;">ğŸ“ ' + booking.schedule_notes + '</div>' : '';
                        
                        // æ•™ç·´å’Œé§•é§› HTMLï¼ˆç¢ºä¿æœ‰è³‡æ–™æ™‚æ‰é¡¯ç¤ºï¼‰
                        const coachHtml = coachNames ? '<div style="font-size: 12px; color: ' + boatColor + '; font-weight: 600; text-align: center; margin-top: 2px;">ğŸ“ ' + coachNames + '</div>' : '';
                        const driverHtml = driverNames ? '<div style="font-size: 12px; color: ' + boatColor + '; font-weight: 600; text-align: center; margin-top: 2px;">ğŸš¤ ' + driverNames + '</div>' : '';
                        
                        cells.push({
                            html: '<td rowspan="' + slots + '" style="' + cardStyle + '">' + coachPracticeHtml + timeRangeHtml + contactNameHtml + notesHtml + scheduleNotesHtml + coachHtml + driverHtml + '</td>',
                            skip: false
                        });
                    } else if (isInRange) {
                        cells.push({ html: '', skip: true });
                    } else {
                        cells.push({
                            html: '<td style="padding: 10px 8px; border-bottom: 1px solid #e9ecef; border-right: 1px solid #e9ecef; background: white;"></td>',
                            skip: false
                        });
                    }
                });
                
                const cellsHtml = cells.filter(function(cell) { return !cell.skip; }).map(function(cell) { return cell.html; }).join('');
                tableRows.push('<tr><td style="position: sticky; left: 0; z-index: 10; background: white; padding: 6px 8px; border-bottom: 1px solid #e9ecef; font-size: 13px; font-weight: 500; text-align: center; color: #666; line-height: 1.5; width: 80px;">' + timeSlot + '</td>' + cellsHtml + '</tr>');
            });
            
            content.innerHTML = `
                <!-- æ—¥æœŸå’Œæ•™ç·´ç¯©é¸ -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <!-- æ—¥æœŸåˆ‡æ› -->
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; gap: 10px;">
                        <button onclick="handleDateChange(-1)" style="padding: 8px 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 16px; color: #666; font-weight: 600;">
                            â† å‰ä¸€å¤©
                        </button>
                        
                        <div style="flex: 1; text-align: center;">
                            <div style="display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 4px; flex-wrap: wrap;">
                                <div style="font-size: 20px; font-weight: bold; color: #333;">
                                    ${dateDisplay.dateText}
                                </div>
                                <div style="font-size: 14px; font-weight: 600; color: #495057; background: #f8f9fa; padding: 4px 12px; border-radius: 12px; border: 1px solid #dee2e6;">
                                    ${dateDisplay.weekday}
                                </div>
                            </div>
                            ${date !== today ? '<button onclick="goToToday()" style="padding: 4px 12px; background: #2196f3; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">å›åˆ°ä»Šå¤©</button>' : ''}
                        </div>
                        
                        <button onclick="handleDateChange(1)" style="padding: 8px 16px; background: white; border: 2px solid #e0e0e0; border-radius: 8px; cursor: pointer; font-size: 16px; color: #666; font-weight: 600;">
                            å¾Œä¸€å¤© â†’
                        </button>
                    </div>
                    
                    <!-- æ•™ç·´ç¯©é¸ -->
                    <div style="display: flex; align-items: center; gap: 12px; padding-top: 16px; border-top: 1px solid #e0e0e0;">
                        <label style="font-size: 14px; color: #666; font-weight: 600;">ç¯©é¸æ•™ç·´ï¼š</label>
                        <select id="coach-filter" onchange="handleCoachFilterChange(this.value)" style="flex: 1; padding: 8px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background: white; cursor: pointer;">
                            <option value="">æ‰€æœ‰æ•™ç·´</option>
                            ${coaches.map(function(coach) {
                                return '<option value="' + coach.id + '"' + (selectedCoachId === coach.id ? ' selected' : '') + '>' + coach.name + '</option>';
                            }).join('')}
                        </select>
                    </div>
                    
                    <!-- æœ€å¾Œæ›´æ–°æ™‚é–“ -->
                    <div style="padding-top: 12px; font-size: 12px; color: #999; text-align: right;">
                        æœ€å¾Œæ›´æ–°ï¼š${new Date().getHours().toString().padStart(2, '0')}:${new Date().getMinutes().toString().padStart(2, '0')}
                    </div>
                </div>
                
                <!-- æ™‚é–“è»¸è¡¨æ ¼ -->
                <div style="overflow-x: auto; -webkit-overflow-scrolling: touch; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <table style="width: 100%; border-collapse: separate; border-spacing: 0;">
                        <thead>
                            <tr>
                                <th style="position: sticky; top: 0; left: 0; z-index: 12; padding: 12px; border-bottom: 2px solid #dee2e6; background-color: #5a5a5a; color: white; font-size: 14px; font-weight: 600; width: 80px;">
                                    æ™‚é–“
                                </th>
                                ${boats.map(function(boat) {
                                    const count = bookings.filter(function(b) { return b.boat_id === boat.id; }).length;
                                    return '<th style="position: sticky; top: 0; z-index: 11; padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; background-color: #5a5a5a; color: white; font-size: 14px; font-weight: 600; width: 120px;"><div style="font-size: 13px;">' + boat.name + '</div><div style="font-size: 11px; font-weight: 400; margin-top: 2px; opacity: 0.8;">' + count + 'ç­†</div></th>';
                                }).join('')}
                            </tr>
                        </thead>
                        <tbody style="position: relative;">
                            ${tableRows.join('')}
                        </tbody>
                    </table>
                </div>
                
                <div style="margin-top: 20px; text-align: center; color: #666; font-size: 12px;">
                    å…± ${bookings.length} ç­†é ç´„
                </div>
            `;
        }
        
        // è™•ç†æ•™ç·´ç¯©é¸è®Šæ›´
        function handleCoachFilterChange(coachId) {
            selectedCoachId = coachId;
            loadAndDisplayBookings(currentDate);
        }
        
        // ==================== BAO Hub åŠŸèƒ½é é¢ ====================
        
        // é¡¯ç¤ºæœƒå“¡ç®¡ç†é é¢
        async function showMemberManagement() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            appContainer.style.maxWidth = '100%';
            appContainer.style.padding = '0';
            appContainer.classList.add('full-width');
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: #f5f5f5; padding-bottom: 80px;">
                    <!-- PageHeader -->
                    <div style="position: sticky; top: 0; z-index: 100; background: #f5f5f5; margin: 0; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
                            <h1 style="font-size: 20px; font-weight: bold; color: #333; margin: 0;">ğŸ‘¥ æœƒå“¡ç®¡ç†</h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="showMemberTransaction()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">ğŸ’° æœƒå“¡å„²å€¼</button>
                                <button onclick="showBaoHub()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">â† BAO</button>
                                <button onclick="showHomePage()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">HOME</button>
                            </div>
                        </div>
                    </div>
                    <div id="member-management-content" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="text-align: center; margin-top: 10px;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            `;
            
            await loadAndDisplayMembers();
        }
        
        // é¡¯ç¤ºæœƒå“¡å„²å€¼é é¢
        async function showMemberTransaction() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            appContainer.style.maxWidth = '100%';
            appContainer.style.padding = '0';
            appContainer.classList.add('full-width');
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: #f5f5f5; padding-bottom: 80px;">
                    <!-- PageHeader -->
                    <div style="position: sticky; top: 0; z-index: 100; background: #f5f5f5; margin: 0; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1200px; margin: 0 auto;">
                            <h1 style="font-size: 20px; font-weight: bold; color: #333; margin: 0;">ğŸ’° æœƒå“¡å„²å€¼</h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="showMemberManagement()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">ğŸ‘¥ æœƒå“¡ç®¡ç†</button>
                                <button onclick="showBaoHub()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">â† BAO</button>
                                <button onclick="showHomePage()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">HOME</button>
                            </div>
                        </div>
                    </div>
                    <div id="member-transaction-content" style="max-width: 1200px; margin: 0 auto; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="text-align: center; margin-top: 10px;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            `;
            
            await loadAndDisplayMemberTransactions();
        }
        
        // é¡¯ç¤ºç½®æ¿ç®¡ç†é é¢
        async function showBoardManagement() {
            const mainContent = document.getElementById('main-content');
            const appContainer = document.getElementById('app');
            
            appContainer.style.maxWidth = '100%';
            appContainer.style.padding = '0';
            appContainer.classList.add('full-width');
            
            mainContent.innerHTML = `
                <div style="min-height: 100vh; background: #f5f5f5; padding-bottom: 80px;">
                    <!-- PageHeader -->
                    <div style="position: sticky; top: 0; z-index: 100; background: #f5f5f5; margin: 0; padding: 20px; border-bottom: 1px solid #e0e0e0;">
                        <div style="display: flex; justify-content: space-between; align-items: center; max-width: 1400px; margin: 0 auto;">
                            <h1 style="font-size: 20px; font-weight: bold; color: #333; margin: 0;">ğŸ„ ç½®æ¿å€ç®¡ç†</h1>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <button onclick="showBaoHub()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">â† BAO</button>
                                <button onclick="showHomePage()" style="padding: 6px 12px; background: rgba(255, 255, 255, 0.8); color: #333; border: 1px solid #ddd; border-radius: 4px; font-size: 13px; cursor: pointer; font-weight: 500;">HOME</button>
                            </div>
                        </div>
                    </div>
                    <div id="board-management-content" style="max-width: 1400px; margin: 0 auto; padding: 20px;">
                        <div class="spinner"></div>
                        <p style="text-align: center; margin-top: 10px;">è¼‰å…¥ä¸­...</p>
                    </div>
                </div>
            `;
            
            await loadAndDisplayBoards();
        }
        
        // æª”æ¡ˆé¸æ“‡äº‹ä»¶ - ä½¿ç”¨æ¨™è¨˜é¿å…é‡è¤‡è¨­ç½®
        let fileInputSetup = false;
        let isFileLoading = false; // é˜²æ­¢é‡è¤‡è¼‰å…¥
        function setupFileInput() {
            if (fileInputSetup) return; // é¿å…é‡è¤‡è¨­ç½®
            const fileInput = document.getElementById('sql-file');
            if (fileInput) {
                fileInputSetup = true;
                // ç§»é™¤èˆŠçš„äº‹ä»¶ç›£è½å™¨ï¼ˆå¦‚æœæœ‰çš„è©±ï¼‰
                const newInput = fileInput.cloneNode(true);
                fileInput.parentNode.replaceChild(newInput, fileInput);
                
                // æ·»åŠ æ–°çš„äº‹ä»¶ç›£è½å™¨
                newInput.addEventListener('change', function(e) {
                    // é˜²æ­¢é‡è¤‡è§¸ç™¼
                    if (isFileLoading) {
                        console.log('æª”æ¡ˆæ­£åœ¨è¼‰å…¥ä¸­ï¼Œå¿½ç•¥é‡è¤‡è§¸ç™¼');
                        e.target.value = ''; // æ¸…ç©ºé¸æ“‡ï¼Œé¿å…é‡è¤‡è§¸ç™¼
                        return;
                    }
                    
                    const file = e.target.files?.[0];
                    const fileNameDiv = document.getElementById('file-name');
                    
                    if (file) {
                        console.log('é¸æ“‡äº†æª”æ¡ˆ:', file.name, 'å¤§å°:', file.size, 'bytes');
                        if (fileNameDiv) {
                            fileNameDiv.textContent = `å·²é¸æ“‡: ${file.name} (${(file.size / 1024).toFixed(2)} KB)`;
                            fileNameDiv.style.color = '#667eea';
                        }
                        // loadSQLFile å‡½æ•¸å…§éƒ¨æœƒè¨­ç½® isFileLoading æ¨™è¨˜ä¸¦ç¦ç”¨ input
                        loadSQLFile(file);
                    } else {
                        console.log('æœªé¸æ“‡æª”æ¡ˆ');
                        if (fileNameDiv) {
                            fileNameDiv.textContent = '';
                        }
                    }
                });
                
                // label çš„ for å±¬æ€§å·²ç¶“è¶³å¤ è§¸ç™¼ inputï¼Œä¸éœ€è¦é¡å¤–çš„é»æ“Šäº‹ä»¶
                // ä½†æˆ‘å€‘éœ€è¦åœ¨è¼‰å…¥éç¨‹ä¸­ç¦ç”¨ label çš„é»æ“Š
                const label = newInput.closest('label');
                if (label) {
                    // ç›£è½ label é»æ“Šï¼Œåœ¨è¼‰å…¥éç¨‹ä¸­é˜»æ­¢
                    label.addEventListener('click', function(e) {
                        if (isFileLoading || newInput.disabled) {
                            e.preventDefault();
                            e.stopPropagation();
                            e.stopImmediatePropagation();
                            console.log('æª”æ¡ˆæ­£åœ¨è¼‰å…¥ä¸­ï¼Œå¿½ç•¥ label é»æ“Š');
                            return false;
                        }
                    }, true); // ä½¿ç”¨ capture phase ç¢ºä¿å„ªå…ˆè™•ç†
                }
                
                console.log('âœ… æª”æ¡ˆè¼¸å…¥äº‹ä»¶ç›£è½å™¨å·²è¨­ç½®');
            } else {
                console.warn('âš ï¸ æ‰¾ä¸åˆ° sql-file å…ƒç´ ï¼Œç¨å¾Œé‡è©¦');
                setTimeout(setupFileInput, 100);
            }
        }
        
        // ==================== æœƒå“¡ç®¡ç†åŠŸèƒ½ ====================
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºæœƒå“¡åˆ—è¡¨
        async function loadAndDisplayMembers() {
            try {
                if (!db) await initDatabase();
                
                const content = document.getElementById('member-management-content');
                if (!content) return;
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const activeMembers = members.filter(m => m.status === 'active');
                
                // è¼‰å…¥ç½®æ¿è³‡æ–™
                let boardStorage = [];
                try {
                    boardStorage = await getAllFromStore('board_storage');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥ç½®æ¿è³‡æ–™:', e);
                }
                
                // è¼‰å…¥å‚™å¿˜éŒ„
                let memberNotes = [];
                try {
                    memberNotes = await getAllFromStore('member_notes');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥å‚™å¿˜éŒ„:', e);
                }
                
                // çµ„åˆè³‡æ–™
                const membersWithBoards = activeMembers.map(member => {
                    const boards = boardStorage.filter(b => b.member_id === member.id && b.status === 'active');
                    const notes = memberNotes.filter(n => n.member_id === member.id);
                    return {
                        ...member,
                        board_slots: boards.map(b => ({
                            slot_number: b.slot_number,
                            start_date: b.start_date,
                            expires_at: b.expires_at
                        })),
                        board_count: boards.length,
                        member_notes: notes
                    };
                });
                
                renderMemberList(membersWithBoards);
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡å¤±æ•—:', error);
                const content = document.getElementById('member-management-content');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥è³‡æ–™åº«</div>';
                }
            }
        }
        
        // æ¸²æŸ“æœƒå“¡åˆ—è¡¨
        function renderMemberList(members) {
            const content = document.getElementById('member-management-content');
            if (!content) return;
            
            // æ’åºï¼šæŒ‰æš±ç¨±æ’åº
            const sortedMembers = [...members].sort((a, b) => {
                const nameA = (a.nickname || a.name || '').toLowerCase();
                const nameB = (b.nickname || b.name || '').toLowerCase();
                return nameA.localeCompare(nameB, 'zh-TW');
            });
            
            content.innerHTML = `
                <!-- æœå°‹å’Œæ–°å¢ -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <div style="display: flex; gap: 12px; margin-bottom: 12px;">
                        <input type="text" id="member-search" placeholder="ğŸ” æœå°‹æœƒå“¡ï¼ˆå§“åã€æš±ç¨±ï¼‰" style="
                            flex: 1;
                            padding: 12px 16px;
                            border: 1px solid #dee2e6;
                            border-radius: 8px;
                            font-size: 15px;
                            outline: none;
                            background: white;
                            box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                        " oninput="filterMembers()">
                        <button onclick="openAddMemberDialog()" style="
                            padding: 12px 20px;
                            background: #5a5a5a;
                            color: white;
                            border: none;
                            border-radius: 8px;
                            font-size: 14px;
                            font-weight: 600;
                            cursor: pointer;
                            white-space: nowrap;
                        ">+ æ–°å¢æœƒå“¡</button>
                    </div>
                    <div style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button onclick="exportMembers()" style="
                            padding: 10px 20px;
                            background: white;
                            color: #666;
                            border: 1px solid #ddd;
                            border-radius: 6px;
                            font-size: 13px;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            gap: 6px;
                        ">ğŸ“¤ åŒ¯å‡ºæœƒå“¡è³‡æ–™</button>
                    </div>
                </div>
                
                <!-- æœƒå“¡åˆ—è¡¨ -->
                <div id="member-list" style="display: grid; gap: 15px;">
                    ${sortedMembers.map(member => renderMemberCard(member)).join('')}
                </div>
            `;
            
            // å„²å­˜æœƒå“¡åˆ—è¡¨ä¾›æœå°‹ä½¿ç”¨
            window.currentMembers = sortedMembers;
        }
        
        // æ¸²æŸ“å–®å€‹æœƒå“¡å¡ç‰‡
        function renderMemberCard(member) {
            const displayName = (member.nickname && member.nickname.trim()) ? member.nickname : member.name;
            const membershipTypeLabel = member.membership_type === 'dual' ? 'é›™äººæœƒå“¡' : 
                                       member.membership_type === 'guest' ? 'éæœƒå“¡' : 
                                       member.membership_type === 'es' ? 'ES' : 'æœƒå“¡';
            
            const formatDate = (dateStr) => {
                if (!dateStr) return '';
                return dateStr.split('T')[0];
            };
            
            const isExpired = (dateStr) => {
                if (!dateStr) return false;
                return new Date(dateStr) < new Date();
            };
            
            return `
                <div onclick="openMemberDetailDialog('${member.id}')" style="
                    background: white;
                    padding: 20px;
                    border-radius: 12px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    border: 2px solid transparent;
                    position: relative;
                " onmouseenter="this.style.borderColor='#5a5a5a'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(90, 90, 90, 0.2)'" 
                   onmouseleave="this.style.borderColor='transparent'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <!-- éš±è—/æ¢å¾©æŒ‰éˆ• -->
                    <button onclick="event.stopPropagation(); ${member.status === 'inactive' ? `restoreMember('${member.id}')` : `hideMember('${member.id}')`}" style="
                        position: absolute;
                        top: 12px;
                        right: 12px;
                        background: ${member.status === 'inactive' ? '#4caf50' : '#f5f5f5'};
                        color: ${member.status === 'inactive' ? 'white' : '#999'};
                        border: none;
                        border-radius: 6px;
                        padding: 6px 12px;
                        font-size: 12px;
                        cursor: pointer;
                        z-index: 10;
                    ">${member.status === 'inactive' ? 'ğŸ”„ æ¢å¾©' : 'ğŸ‘ï¸ éš±è—'}</button>
                    <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;">
                            <h3 style="margin: 0; font-size: 18px; font-weight: bold;">${displayName}</h3>
                            ${member.nickname && member.nickname.trim() ? `<span style="font-size: 13px; color: #999;">(${member.name})</span>` : ''}
                            <span style="background: ${member.membership_type === 'guest' ? '#fff9e6' : '#e3f2fd'}; color: ${member.membership_type === 'guest' ? '#856404' : '#1976d2'}; padding: 3px 10px; border-radius: 12px; font-weight: bold; font-size: 12px;">
                                ${member.membership_type === 'guest' ? 'ğŸ« éæœƒå“¡' : 'ğŸ‘¤ ' + membershipTypeLabel}
                            </span>
                        </div>
                        <div style="display: flex; gap: 16px; flex-wrap: wrap; font-size: 13px; color: #666;">
                            ${member.phone ? `<div>ğŸ“± ${member.phone}</div>` : ''}
                            ${member.birthday ? `<div>ğŸ‚ ${formatDate(member.birthday)}</div>` : ''}
                        </div>
                        ${member.membership_start_date || member.membership_end_date ? `
                            <div style="color: ${isExpired(member.membership_end_date) ? '#f44336' : '#666'}; margin-top: 8px; font-size: 13px;">
                                ğŸ« æœƒç±ï¼š${member.membership_start_date ? formatDate(member.membership_start_date) : '?'} â†’ ${member.membership_end_date ? formatDate(member.membership_end_date) : '?'}
                                ${isExpired(member.membership_end_date) ? ' (å·²éæœŸ)' : ''}
                            </div>
                        ` : ''}
                        ${member.board_slots && member.board_slots.length > 0 ? `
                            <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-top: 8px;">
                                ${member.board_slots.map(slot => `
                                    <div style="color: ${isExpired(slot.expires_at) ? '#f44336' : '#2e7d32'}; font-size: 13px;">
                                        ğŸ„ ç½®æ¿ #${slot.slot_number}ï¼š${slot.start_date ? formatDate(slot.start_date) : '?'} â†’ ${slot.expires_at ? formatDate(slot.expires_at) : '?'}
                                        ${isExpired(slot.expires_at) ? ' (å·²éæœŸ)' : ''}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                    ${member.member_notes && member.member_notes.length > 0 ? `
                        <div style="background: #fff; padding: 12px; border-radius: 6px; border: 1px solid #e0e0e0; margin-top: 10px;">
                            <div style="font-size: 13px; color: #555; margin-bottom: 10px; font-weight: 600;">ğŸ“ å‚™å¿˜éŒ„ (${member.member_notes.length})</div>
                            <div style="display: flex; flex-direction: column; gap: 4px;">
                                ${member.member_notes.slice(-5).map(note => `
                                    <div style="font-size: 13px; padding: 6px 10px; border-left: 3px solid #607d8b; color: #333;">
                                        ${note.event_date ? `<span style="color: #888; margin-right: 8px;">${note.event_date}</span>` : ''}
                                        ${note.description}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        
        // æœå°‹æœƒå“¡
        function filterMembers() {
            const searchTerm = document.getElementById('member-search')?.value.toLowerCase() || '';
            const memberList = document.getElementById('member-list');
            if (!memberList || !window.currentMembers) return;
            
            const filtered = window.currentMembers.filter(member => {
                const name = (member.name || '').toLowerCase();
                const nickname = (member.nickname || '').toLowerCase();
                return name.includes(searchTerm) || nickname.includes(searchTerm);
            });
            
            memberList.innerHTML = filtered.map(member => renderMemberCard(member)).join('');
        }
        
        // é–‹å•Ÿæ–°å¢æœƒå“¡å°è©±æ¡†
        function openAddMemberDialog() {
            // å¯¦ç¾æ–°å¢æœƒå“¡å°è©±æ¡†
            showAddMemberDialog();
        }
        
        // é–‹å•Ÿæœƒå“¡è©³æƒ…å°è©±æ¡†
        function openMemberDetailDialog(memberId) {
            // å¯¦ç¾æœƒå“¡è©³æƒ…å°è©±æ¡†
            showMemberDetailDialog(memberId);
        }
        
        // ==================== æœƒå“¡å„²å€¼åŠŸèƒ½ ====================
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºæœƒå“¡å„²å€¼é é¢
        async function loadAndDisplayMemberTransactions() {
            try {
                if (!db) await initDatabase();
                
                const content = document.getElementById('member-transaction-content');
                if (!content) return;
                
                // è¼‰å…¥æœƒå“¡å’Œäº¤æ˜“è¨˜éŒ„
                const members = await getAllFromStore('members');
                const activeMembers = members.filter(m => m.status === 'active');
                
                let transactions = [];
                try {
                    transactions = await getAllFromStore('transactions');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥äº¤æ˜“è¨˜éŒ„:', e);
                }
                
                // è¨ˆç®—æ¯å€‹æœƒå“¡çš„æœ€å¾Œäº¤æ˜“æ—¥æœŸ
                const lastTransactionMap = {};
                transactions.forEach(tx => {
                    if (tx.member_id && !lastTransactionMap[tx.member_id]) {
                        lastTransactionMap[tx.member_id] = {
                            date: tx.transaction_date,
                            createdAt: tx.created_at || tx.transaction_date
                        };
                    }
                });
                
                const membersWithLastTx = activeMembers.map(m => ({
                    ...m,
                    lastTransactionDate: lastTransactionMap[m.id]?.date || null,
                    lastTransactionCreatedAt: lastTransactionMap[m.id]?.createdAt || null
                }));
                
                renderMemberTransactionList(membersWithLastTx);
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡å„²å€¼å¤±æ•—:', error);
                const content = document.getElementById('member-transaction-content');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥è³‡æ–™åº«</div>';
                }
            }
        }
        
        // æ¸²æŸ“æœƒå“¡å„²å€¼åˆ—è¡¨
        function renderMemberTransactionList(members) {
            const content = document.getElementById('member-transaction-content');
            if (!content) return;
            
            // è¨ˆç®—çµ±è¨ˆ
            const stats = {
                totalBalance: members.reduce((sum, m) => sum + (m.balance || 0), 0),
                totalVipVoucher: members.reduce((sum, m) => sum + (m.vip_voucher_amount || 0), 0),
                totalG23: members.reduce((sum, m) => sum + (m.boat_voucher_g23_minutes || 0), 0),
                totalG21: members.reduce((sum, m) => sum + (m.boat_voucher_g21_panther_minutes || 0), 0)
            };
            
            // æ’åºï¼šæŒ‰æ›´æ–°æ—¥æœŸé™åº
            const sortedMembers = [...members].sort((a, b) => {
                const dateA = a.lastTransactionCreatedAt || '';
                const dateB = b.lastTransactionCreatedAt || '';
                if (!dateA && !dateB) return 0;
                if (!dateA) return 1;
                if (!dateB) return -1;
                return dateB.localeCompare(dateA);
            });
            
            content.innerHTML = `
                <!-- æ•¸æ“šç¸½è¦½ -->
                <div style="background: white; border-radius: 12px; padding: 20px; margin-bottom: 16px; border: 1px solid #e0e0e0; box-shadow: 0 2px 8px rgba(0,0,0,0.06);">
                    <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; text-align: center;">
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ğŸ’° ç¸½å„²å€¼</div>
                            <div style="font-size: 22px; font-weight: bold; color: #333;">$${stats.totalBalance.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ğŸ’ ç¸½VIPç¥¨åˆ¸</div>
                            <div style="font-size: 22px; font-weight: bold; color: #333;">$${stats.totalVipVoucher.toLocaleString()}</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">ğŸš¤ ç¸½G23èˆ¹åˆ¸</div>
                            <div style="font-size: 22px; font-weight: bold; color: #333;">${stats.totalG23.toLocaleString()}åˆ†</div>
                        </div>
                        <div>
                            <div style="font-size: 12px; color: #999; margin-bottom: 4px;">â›µ ç¸½G21/é»‘è±¹</div>
                            <div style="font-size: 22px; font-weight: bold; color: #333;">${stats.totalG21.toLocaleString()}åˆ†</div>
                        </div>
                    </div>
                </div>
                
                <!-- æœå°‹æ¬„ -->
                <div style="background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                    <input type="text" id="transaction-search" placeholder="ğŸ” æœå°‹æœƒå“¡ï¼ˆå§“åã€æš±ç¨±ï¼‰" style="
                        width: 100%;
                        padding: 12px 16px;
                        border: 1px solid #dee2e6;
                        border-radius: 8px;
                        font-size: 15px;
                        outline: none;
                        background: white;
                        box-shadow: 0 2px 6px rgba(0,0,0,0.08);
                    " oninput="filterMemberTransactions()">
                </div>
                
                <!-- æœƒå“¡åˆ—è¡¨ -->
                <div id="member-transaction-list" style="display: grid; gap: 15px;">
                    ${sortedMembers.map(member => renderMemberTransactionCard(member)).join('')}
                </div>
            `;
            
            window.currentTransactionMembers = sortedMembers;
        }
        
        // æ¸²æŸ“æœƒå“¡å„²å€¼å¡ç‰‡
        function renderMemberTransactionCard(member) {
            const displayName = member.nickname || member.name;
            
            return `
                <div onclick="openTransactionDialog('${member.id}')" style="
                    background: white;
                    border-radius: 12px;
                    margin-bottom: 15px;
                    padding: 20px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
                    cursor: pointer;
                    transition: all 0.2s;
                    border: 2px solid transparent;
                " onmouseenter="this.style.borderColor='#667eea'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 16px rgba(102, 126, 234, 0.2)'" 
                   onmouseleave="this.style.borderColor='transparent'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.1)'">
                    <div style="background: #f8f9fa; padding: 14px 16px; border-radius: 8px; margin-bottom: 12px;">
                        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 8px;">
                            <h3 style="margin: 0; font-size: 18px; font-weight: bold; color: #333;">${displayName}</h3>
                            ${member.nickname ? `<span style="font-size: 13px; color: #999;">(${member.name})</span>` : ''}
                        </div>
                        ${member.lastTransactionDate ? `
                            <div style="font-size: 12px; color: #999; margin-top: 4px;">
                                ğŸ“… äº¤æ˜“ï¼š${member.lastTransactionDate.split('T')[0]}
                            </div>
                        ` : ''}
                    </div>
                    <div style="background: #fff; padding: 10px 12px; border-radius: 6px; border: 1px solid #e0e0e0">
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center; font-size: 13px;">
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">ğŸ’° å„²å€¼é¤˜é¡</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">$${(member.balance || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">ğŸ’ VIPç¥¨åˆ¸</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">$${(member.vip_voucher_amount || 0).toLocaleString()}</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">ğŸ“š æŒ‡å®šèª²</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">${(member.designated_lesson_minutes || 0).toLocaleString()}åˆ†</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">ğŸš¤ G23èˆ¹åˆ¸</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">${(member.boat_voucher_g23_minutes || 0).toLocaleString()}åˆ†</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">â›µ é»‘è±¹/G21</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">${(member.boat_voucher_g21_panther_minutes || 0).toLocaleString()}åˆ†</div>
                            </div>
                            <div>
                                <div style="font-size: 11px; color: #999; margin-bottom: 4px;">ğŸ è´ˆé€å¤§èˆ¹</div>
                                <div style="font-size: 16px; font-weight: bold; color: #333;">${(member.gift_boat_hours || 0).toLocaleString()}åˆ†</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æœå°‹æœƒå“¡å„²å€¼
        function filterMemberTransactions() {
            const searchTerm = document.getElementById('transaction-search')?.value.toLowerCase() || '';
            const memberList = document.getElementById('member-transaction-list');
            if (!memberList || !window.currentTransactionMembers) return;
            
            const filtered = window.currentTransactionMembers.filter(member => {
                const name = (member.name || '').toLowerCase();
                const nickname = (member.nickname || '').toLowerCase();
                const phone = (member.phone || '').toLowerCase();
                return name.includes(searchTerm) || nickname.includes(searchTerm) || phone.includes(searchTerm);
            });
            
            memberList.innerHTML = filtered.map(member => renderMemberTransactionCard(member)).join('');
        }
        
        // é–‹å•Ÿäº¤æ˜“å°è©±æ¡†
        function openTransactionDialog(memberId) {
            showTransactionDialog(memberId);
        }
        
        // ==================== ç½®æ¿ç®¡ç†åŠŸèƒ½ ====================
        
        // è¼‰å…¥ä¸¦é¡¯ç¤ºç½®æ¿ç®¡ç†é é¢
        async function loadAndDisplayBoards() {
            try {
                if (!db) await initDatabase();
                
                const content = document.getElementById('board-management-content');
                if (!content) return;
                
                // è¼‰å…¥ç½®æ¿è³‡æ–™
                let boardStorage = [];
                try {
                    boardStorage = await getAllFromStore('board_storage');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥ç½®æ¿è³‡æ–™:', e);
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">ç½®æ¿è³‡æ–™è¡¨ä¸å­˜åœ¨ï¼Œè«‹å…ˆè¼‰å…¥åŒ…å« board_storage è¡¨çš„ SQL æª”æ¡ˆ</div>';
                    return;
                }
                
                const activeBoards = boardStorage.filter(b => b.status === 'active');
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const membersMap = {};
                members.forEach(m => {
                    membersMap[m.id] = m;
                });
                
                // çµ„åˆè³‡æ–™
                const boardsWithMembers = activeBoards.map(board => ({
                    ...board,
                    member_name: membersMap[board.member_id]?.name,
                    member_nickname: membersMap[board.member_id]?.nickname
                }));
                
                renderBoardManagement(boardsWithMembers);
            } catch (error) {
                console.error('è¼‰å…¥ç½®æ¿ç®¡ç†å¤±æ•—:', error);
                const content = document.getElementById('board-management-content');
                if (content) {
                    content.innerHTML = '<div style="text-align: center; padding: 40px; color: #999;">è¼‰å…¥å¤±æ•—ï¼Œè«‹é‡æ–°è¼‰å…¥è³‡æ–™åº«</div>';
                }
            }
        }
        
        // æ¸²æŸ“ç½®æ¿ç®¡ç†é é¢
        function renderBoardManagement(boards) {
            const content = document.getElementById('board-management-content');
            if (!content) return;
            
            // ç½®æ¿å€é…ç½®
            const BOARD_SECTIONS = [
                { name: 'ç¬¬1æ’', start: 1, end: 30 },
                { name: 'ç¬¬2æ’', start: 31, end: 62 },
                { name: 'ç¬¬3æ’', start: 63, end: 94 },
                { name: 'ç¬¬4æ’', start: 95, end: 134 },
                { name: 'ç¬¬5æ’', start: 135, end: 145, upperOnly: true }
            ];
            
            // å»ºç«‹æ ¼ä½æ˜ å°„
            const slotMap = {};
            boards.forEach(board => {
                slotMap[board.slot_number] = board;
            });
            
            // çµ±è¨ˆè³‡è¨Š
            const totalSlots = 145;
            const usedSlots = boards.length;
            const emptySlots = totalSlots - usedSlots;
            
            content.innerHTML = `
                <!-- æ“ä½œæŒ‰éˆ• -->
                <div style="display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;">
                    <button onclick="importBoards()" style="
                        padding: 8px 14px;
                        background: white;
                        color: #666;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 13px;
                        cursor: pointer;
                    ">ğŸ“¥ åŒ¯å…¥</button>
                    <button onclick="exportBoards()" style="
                        padding: 8px 14px;
                        background: white;
                        color: #666;
                        border: 1px solid #ddd;
                        border-radius: 6px;
                        font-size: 13px;
                        cursor: pointer;
                    ">ğŸ“¤ åŒ¯å‡º</button>
                </div>
                
                <!-- çµ±è¨ˆè³‡è¨Š -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px;">
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">ç¸½æ ¼ä½æ•¸</div>
                        <div style="font-size: 32px; font-weight: bold; color: #667eea;">145</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">å·²ä½¿ç”¨</div>
                        <div style="font-size: 32px; font-weight: bold; color: #4caf50;">${usedSlots}</div>
                    </div>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center;">
                        <div style="font-size: 14px; color: #666; margin-bottom: 8px;">ç©ºä½</div>
                        <div style="font-size: 32px; font-weight: bold; color: #ff9800;">${emptySlots}</div>
                    </div>
                </div>
                
                <!-- ç½®æ¿å€åŸŸ -->
                ${BOARD_SECTIONS.map(section => renderBoardSection(section, slotMap)).join('')}
            `;
            
            window.currentBoards = boards;
        }
        
        // æ¸²æŸ“ç½®æ¿å€å¡Š
        function renderBoardSection(section, slotMap) {
            const slotPairs = [];
            
            if (section.upperOnly) {
                for (let i = section.start; i <= section.end; i++) {
                    slotPairs.push({ upper: i, lower: null });
                }
            } else {
                for (let i = section.start; i <= section.end; i += 2) {
                    const lower = i;
                    const upper = i + 1;
                    slotPairs.push({
                        upper: upper <= section.end ? upper : null,
                        lower: lower <= section.end ? lower : null
                    });
                }
            }
            
            return `
                <div style="margin-bottom: 30px;">
                    <h3 style="margin: 0 0 15px 0; font-size: 18px; font-weight: bold; color: white; background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%); padding: 12px; border-radius: 8px;">
                        ${section.name} (${section.start}-${section.end})
                    </h3>
                    <div style="background: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                        <div style="display: grid; grid-template-columns: repeat(9, 1fr); gap: 10px;">
                            ${slotPairs.map(pair => `
                                <div style="display: flex; flex-direction: column; gap: 6px;">
                                    ${pair.upper ? renderBoardSlot(pair.upper, slotMap[pair.upper]) : '<div></div>'}
                                    ${pair.lower ? renderBoardSlot(pair.lower, slotMap[pair.lower]) : '<div></div>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }
        
        // æ¸²æŸ“å–®å€‹ç½®æ¿æ ¼ä½
        function renderBoardSlot(slotNumber, board) {
            const isOccupied = !!board;
            
            // è¨ˆç®—åˆ°æœŸç‹€æ…‹
            let expiryStatus = 'empty';
            if (isOccupied && board.expires_at) {
                const today = new Date();
                const expiryDate = new Date(board.expires_at);
                const daysUntilExpiry = Math.ceil((expiryDate.getTime() - today.getTime()) / (1000 * 60 * 60 * 24));
                if (daysUntilExpiry < 0) expiryStatus = 'expired';
                else if (daysUntilExpiry <= 30) expiryStatus = 'expiring';
                else expiryStatus = 'normal';
            }
            
            // æ ¹æ“šç‹€æ…‹è¨­å®šé¡è‰²
            let slotStyles = {
                background: '#f5f5f5',
                color: '#999',
                border: '2px solid #e0e0e0'
            };
            
            if (expiryStatus === 'expired') {
                slotStyles = {
                    background: 'linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%)',
                    color: '#c62828',
                    border: '2px solid #ef9a9a'
                };
            } else if (expiryStatus === 'expiring') {
                slotStyles = {
                    background: 'linear-gradient(135deg, #fff8e1 0%, #ffecb3 100%)',
                    color: '#e65100',
                    border: '2px solid #ffcc80'
                };
            } else if (expiryStatus === 'normal') {
                slotStyles = {
                    background: 'linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%)',
                    color: '#2e7d32',
                    border: '2px solid #a5d6a7'
                };
            }
            
            return `
                <div onclick="openBoardSlotDialog(${slotNumber})" style="
                    padding: 8px;
                    background: ${slotStyles.background};
                    color: ${slotStyles.color};
                    border-radius: 6px;
                    cursor: pointer;
                    border: ${slotStyles.border};
                    transition: all 0.2s;
                    height: 90px;
                    display: flex;
                    flex-direction: column;
                    justify-content: flex-start;
                    position: relative;
                    overflow: hidden;
                " onmouseenter="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)'" 
                   onmouseleave="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                    <div style="font-size: 11px; font-weight: bold; opacity: 0.7; margin-bottom: 3px;">#${slotNumber}</div>
                    ${isOccupied ? `
                        <div style="font-size: 13px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; line-height: 1.3;">
                            ${board.member_nickname || board.member_name || 'æœªçŸ¥'}
                        </div>
                        ${board.expires_at ? `
                            <div style="font-size: 10px; opacity: 0.85; margin-top: 3px; line-height: 1.2;">
                                ğŸ“… ${board.expires_at.split('T')[0]}
                            </div>
                        ` : ''}
                        ${board.notes ? `
                            <div style="font-size: 9px; opacity: 0.9; margin-top: 2px; line-height: 1.2; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${board.notes}">
                                ğŸ“ ${board.notes.length > 8 ? board.notes.substring(0, 8) + '...' : board.notes}
                            </div>
                        ` : ''}
                    ` : `
                        <div style="font-size: 12px; text-align: center; margin-top: 6px;">ç©ºä½</div>
                    `}
                </div>
            `;
        }
        
        // é–‹å•Ÿç½®æ¿æ ¼ä½å°è©±æ¡†
        function openBoardSlotDialog(slotNumber) {
            showBoardSlotDialog(slotNumber);
        }
        
        // åŒ¯å…¥ç½®æ¿
        function importBoards() {
            alert('åŒ¯å…¥åŠŸèƒ½é–‹ç™¼ä¸­');
        }
        
        // åŒ¯å‡ºç½®æ¿
        async function exportBoards() {
            try {
                if (!db) await initDatabase();
                
                const boards = await getAllFromStore('board_storage');
                const activeBoards = boards.filter(b => b.status === 'active');
                
                const members = await getAllFromStore('members');
                const membersMap = {};
                members.forEach(m => {
                    membersMap[m.id] = m;
                });
                
                const headers = ['å§“å', 'æš±ç¨±', 'æ ¼ä½è™Ÿç¢¼', 'åˆ°æœŸæ—¥', 'å‚™è¨»'];
                const rows = activeBoards.map(board => {
                    const member = membersMap[board.member_id];
                    return [
                        member?.name || '',
                        member?.nickname || '',
                        board.slot_number,
                        board.expires_at || '',
                        board.notes || ''
                    ];
                });
                
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('"') || cellStr.includes('\n')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');
                
                const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                const today = new Date().toISOString().split('T')[0];
                link.download = `ç½®æ¿è³‡æ–™_${today}.csv`;
                link.click();
            } catch (error) {
                console.error('åŒ¯å‡ºå¤±æ•—:', error);
                alert('åŒ¯å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }
        
        // ==================== å°è©±æ¡†å‡½æ•¸ ====================
        
        // é¡¯ç¤ºæ–°å¢æœƒå“¡å°è©±æ¡†
        function showAddMemberDialog() {
            const dialog = document.getElementById('add-member-dialog');
            if (!dialog) return;
            
            dialog.innerHTML = `
                <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="margin: 0; font-size: 20px; font-weight: bold;">â• æ–°å¢æœƒå“¡</h2>
                    <button onclick="closeAddMemberDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                </div>
                <form id="add-member-form" style="padding: 20px;" onsubmit="handleAddMember(event)">
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">å§“å <span style="color: red;">*</span></label>
                        <input type="text" id="member-name" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æš±ç¨± <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                        <input type="text" id="member-nickname" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">é›»è©± <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                        <input type="tel" id="member-phone" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">ç”Ÿæ—¥ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                        <input type="date" id="member-birthday" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                    </div>
                    <div style="margin-bottom: 16px;">
                        <label style="display: block; margin-bottom: 8px; font-weight: 500;">æœƒç±é¡å‹ <span style="color: red;">*</span></label>
                        <select id="member-type" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                            <option value="general">æœƒå“¡</option>
                            <option value="dual">é›™äººæœƒå“¡</option>
                            <option value="guest">éæœƒå“¡</option>
                            <option value="es">ES</option>
                        </select>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æœƒå“¡é–‹å§‹æ—¥æœŸ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input type="date" id="member-start-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æœƒå“¡æˆªæ­¢æ—¥æœŸ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input type="date" id="member-end-date" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                    </div>
                    <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <button type="button" onclick="closeAddMemberDialog()" style="flex: 1; padding: 12px 24px; border: 1px solid #ccc; border-radius: 8px; background: white; color: #333; font-size: 15px; font-weight: 500; cursor: pointer;">å–æ¶ˆ</button>
                        <button type="submit" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;">âœ… ç¢ºèªæ–°å¢</button>
                    </div>
                </form>
            `;
            dialog.classList.add('active');
        }
        
        // é—œé–‰æ–°å¢æœƒå“¡å°è©±æ¡†
        function closeAddMemberDialog() {
            const dialog = document.getElementById('add-member-dialog');
            if (dialog) {
                dialog.classList.remove('active');
            }
        }
        
        // è™•ç†æ–°å¢æœƒå“¡
        async function handleAddMember(event) {
            event.preventDefault();
            
            try {
                if (!db) await initDatabase();
                
                const name = document.getElementById('member-name').value.trim();
                const nickname = document.getElementById('member-nickname').value.trim();
                const phone = document.getElementById('member-phone').value.trim();
                const birthday = document.getElementById('member-birthday').value;
                const membershipType = document.getElementById('member-type').value;
                const membershipStartDate = document.getElementById('member-start-date').value;
                const membershipEndDate = document.getElementById('member-end-date').value;
                
                if (!name) {
                    alert('è«‹è¼¸å…¥å§“å');
                    return;
                }
                
                // é©—è­‰é›»è©±æ ¼å¼
                if (phone && !/^09\d{8}$/.test(phone)) {
                    alert('é›»è©±éœ€ç‚º 09 é–‹é ­çš„ 10 ä½æ•¸å­—');
                    return;
                }
                
                // ç”Ÿæˆæœƒå“¡ IDï¼ˆä½¿ç”¨ UUID æˆ–æ™‚é–“æˆ³ï¼‰
                const memberId = 'member_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                const memberData = {
                    id: memberId,
                    name: name,
                    nickname: nickname || null,
                    phone: phone || null,
                    birthday: birthday || null,
                    membership_type: membershipType,
                    membership_start_date: membershipStartDate || null,
                    membership_end_date: membershipEndDate || null,
                    balance: 0,
                    vip_voucher_amount: 0,
                    designated_lesson_minutes: 0,
                    boat_voucher_g23_minutes: 0,
                    boat_voucher_g21_panther_minutes: 0,
                    gift_boat_hours: 0,
                    status: 'active',
                    created_at: new Date().toISOString(),
                    updated_at: null
                };
                
                // æ’å…¥åˆ° IndexedDB
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                await new Promise((resolve, reject) => {
                    const request = store.add(memberData);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // å¦‚æœæœ‰æœƒå“¡é–‹å§‹æ—¥æœŸï¼Œæ–°å¢å‚™å¿˜éŒ„
                if (membershipStartDate && membershipType !== 'guest') {
                    try {
                        await createTableIfNotExists('member_notes', 'id', true);
                        const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                        const notesStore = notesTransaction.objectStore('member_notes');
                        await new Promise((resolve, reject) => {
                            const request = notesStore.add({
                                member_id: memberId,
                                event_date: membershipStartDate,
                                event_type: 'å…¥æœƒ',
                                description: 'å…¥æœƒ'
                            });
                            request.onsuccess = () => resolve();
                            request.onerror = () => reject(request.error);
                        });
                    } catch (e) {
                        console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                    }
                }
                
                alert('æœƒå“¡æ–°å¢æˆåŠŸï¼');
                closeAddMemberDialog();
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('æ–°å¢æœƒå“¡å¤±æ•—:', error);
                alert('æ–°å¢æœƒå“¡å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é¡¯ç¤ºæœƒå“¡è©³æƒ…å°è©±æ¡†
        async function showMemberDetailDialog(memberId) {
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // è¼‰å…¥ç½®æ¿è³‡æ–™
                let boardStorage = [];
                try {
                    boardStorage = await getAllFromStore('board_storage');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥ç½®æ¿è³‡æ–™:', e);
                }
                
                const memberBoards = boardStorage.filter(b => b.member_id === memberId && b.status === 'active');
                
                // è¼‰å…¥å‚™å¿˜éŒ„
                let memberNotes = [];
                try {
                    memberNotes = await getAllFromStore('member_notes');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥å‚™å¿˜éŒ„:', e);
                }
                
                const notes = memberNotes.filter(n => n.member_id === memberId);
                
                // è¼‰å…¥äº¤æ˜“è¨˜éŒ„
                let transactions = [];
                try {
                    transactions = await getAllFromStore('transactions');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥äº¤æ˜“è¨˜éŒ„:', e);
                }
                
                const memberTransactions = transactions.filter(t => t.member_id === memberId);
                
                const dialog = document.getElementById('member-detail-dialog');
                if (!dialog) return;
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '';
                    return dateStr.split('T')[0];
                };
                
                const isExpired = (dateStr) => {
                    if (!dateStr) return false;
                    return new Date(dateStr) < new Date();
                };
                
                const membershipTypeLabel = member.membership_type === 'dual' ? 'é›™äººæœƒå“¡' : 
                                           member.membership_type === 'guest' ? 'éæœƒå“¡' : 
                                           member.membership_type === 'es' ? 'ES' : 'æœƒå“¡';
                
                dialog.innerHTML = `
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; background: white; z-index: 1;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold;">æœƒå“¡è©³æƒ…</h2>
                        <button onclick="closeMemberDetailDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                    </div>
                    <div style="padding: 20px; max-height: calc(90vh - 80px); overflow-y: auto;">
                        <!-- åŸºæœ¬è³‡æ–™ -->
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">ğŸ‘¤ åŸºæœ¬è³‡æ–™</h3>
                                <button onclick="openEditMemberDialog('${member.id}')" style="padding: 4px 12px; background: #f5f5f5; color: #666; border: 1px solid #ddd; border-radius: 4px; font-size: 12px; cursor: pointer;">âœï¸ ç·¨è¼¯</button>
                            </div>
                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px 16px;">
                                <div style="display: flex; flex-wrap: wrap; gap: 16px; font-size: 14px;">
                                    <div><span style="color: #666;">å§“åï¼š</span>${member.name}</div>
                                    ${member.nickname ? `<div><span style="color: #666;">æš±ç¨±ï¼š</span>${member.nickname}</div>` : ''}
                                    <div><span style="color: #666;">æ‰‹æ©Ÿï¼š</span>${member.phone || '<span style="color: #999;">æœªå¡«å¯«</span>'}</div>
                                    ${member.birthday ? `<div><span style="color: #666;">ç”Ÿæ—¥ï¼š</span>${formatDate(member.birthday)}</div>` : ''}
                                    <div>
                                        <span style="background: ${member.membership_type === 'guest' ? '#fff9e6' : '#e3f2fd'}; color: ${member.membership_type === 'guest' ? '#856404' : '#1976d2'}; padding: 2px 8px; border-radius: 4px; font-size: 12px; font-weight: 600;">
                                            ${member.membership_type === 'guest' ? 'ğŸ« éæœƒå“¡' : 'ğŸ‘¤ ' + membershipTypeLabel}
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- æœƒç± -->
                        ${(member.membership_type === 'general' || member.membership_type === 'dual') ? `
                            <div style="margin-bottom: 24px;">
                                <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333; font-weight: 600;">ğŸ« æœƒç±</h3>
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 12px 16px;">
                                    <div style="font-size: 14px; margin-bottom: 12px; color: ${isExpired(member.membership_end_date) ? '#f44336' : '#333'};">
                                        ${formatDate(member.membership_start_date) || '?'} â†’ ${formatDate(member.membership_end_date) || '?'}
                                        ${isExpired(member.membership_end_date) ? ' <span style="font-weight: 600;">(å·²éæœŸ)</span>' : ''}
                                    </div>
                                    <button onclick="renewMembership('${member.id}')" style="padding: 6px 14px; background: #4caf50; color: white; border: none; border-radius: 4px; font-size: 13px; font-weight: 500; cursor: pointer;">ğŸ”„ çºŒç´„</button>
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- ç½®æ¿ -->
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">ğŸ„ ç½®æ¿</h3>
                                <button onclick="openAddBoardDialog('${member.id}')" style="padding: 4px 12px; background: #5a5a5a; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ æ–°å¢</button>
                            </div>
                            ${memberBoards.length === 0 ? `
                                <div style="background: #f8f9fa; border-radius: 8px; padding: 16px; text-align: center; color: #999; font-size: 13px;">å°šç„¡ç½®æ¿</div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    ${memberBoards.map(board => `
                                        <div onclick="openEditBoardDialog('${board.id}', ${board.slot_number})" style="
                                            background: #f8f9fa;
                                            border-radius: 6px;
                                            padding: 10px 14px;
                                            display: flex;
                                            justify-content: space-between;
                                            align-items: center;
                                            font-size: 13px;
                                            cursor: pointer;
                                            transition: all 0.2s;
                                            border: 1px solid transparent;
                                        " onmouseenter="this.style.background='#e8f4fd'; this.style.borderColor='#90caf9'" 
                                           onmouseleave="this.style.background='#f8f9fa'; this.style.borderColor='transparent'">
                                            <div>
                                                <span style="font-weight: 600;">#${board.slot_number}</span>
                                                ${board.start_date ? `<span style="color: #666; margin-left: 8px;">${formatDate(board.start_date)}</span>` : ''}
                                                ${board.expires_at ? `<span style="color: #666;"> â†’ ${formatDate(board.expires_at)}</span>` : ''}
                                                ${isExpired(board.expires_at) ? ' <span style="color: #f44336;">(å·²éæœŸ)</span>' : ''}
                                                ${board.notes ? `<span style="color: #999; margin-left: 8px; font-size: 12px;">ğŸ“ ${board.notes.length > 10 ? board.notes.substring(0, 10) + '...' : board.notes}</span>` : ''}
                                            </div>
                                            <button onclick="event.stopPropagation(); renewBoard('${board.id}', ${board.slot_number}, '${board.expires_at || ''}')" style="
                                                padding: 4px 10px;
                                                background: #4caf50;
                                                color: white;
                                                border: none;
                                                border-radius: 4px;
                                                font-size: 12px;
                                                cursor: pointer;
                                            ">+1å¹´</button>
                                        </div>
                                    `).join('')}
                                </div>
                            `}
                        </div>
                        
                        <!-- å‚™å¿˜éŒ„ -->
                        <div style="margin-bottom: 24px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                                <h3 style="margin: 0; font-size: 16px; color: #333; font-weight: 600;">
                                    ğŸ“ å‚™å¿˜éŒ„ ${notes.length > 0 ? `<span style="color: #999; font-weight: normal;">(${notes.length})</span>` : ''}
                                </h3>
                                <button onclick="openAddNoteDialog('${member.id}')" style="padding: 4px 12px; background: #5a5a5a; color: white; border: none; border-radius: 4px; font-size: 12px; cursor: pointer;">+ æ–°å¢</button>
                            </div>
                            ${notes.length === 0 ? `
                                <div style="text-align: center; padding: 30px 20px; color: #999; background: #f8f9fa; border-radius: 8px; border: 1px solid #e0e0e0;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">ğŸ“</div>
                                    <div style="font-size: 14px;">å°šç„¡å‚™å¿˜éŒ„</div>
                                </div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 10px; max-height: 500px; overflow-y: auto;">
                                    ${notes.map(note => {
                                        const eventColors = {
                                            'çºŒç´„': '#4caf50',
                                            'è³¼è²·': '#2196f3',
                                            'è´ˆé€': '#9c27b0',
                                            'ä½¿ç”¨': '#ff9800',
                                            'å…¥æœƒ': '#e91e63',
                                            'å‚™è¨»': '#607d8b'
                                        };
                                        const color = eventColors[note.event_type] || '#607d8b';
                                        return `
                                            <div style="background: #f8f9fa; border-radius: 8px; padding: 12px; border-left: 4px solid ${color};">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                                    <div style="flex: 1;">
                                                        <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                                            <span style="background: ${color}; color: white; padding: 2px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">${note.event_type}</span>
                                                            <span style="color: #666; font-size: 12px;">${note.event_date || ''}</span>
                                                        </div>
                                                        <div style="font-size: 13px; color: #333; line-height: 1.4;">${note.description}</div>
                                                    </div>
                                                    <div style="display: flex; gap: 4px; margin-left: 8px;">
                                                        <button onclick="editNote(${note.id})" style="padding: 4px 8px; background: #e3f2fd; color: #1976d2; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">âœï¸</button>
                                                        <button onclick="deleteNote(${note.id}, '${member.id}')" style="padding: 4px 8px; background: #ffebee; color: #d32f2f; border: none; border-radius: 4px; font-size: 11px; cursor: pointer;">ğŸ—‘ï¸</button>
                                                    </div>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                        
                        <!-- é‡‘æµè³‡è¨Š -->
                        <div style="margin-bottom: 24px;">
                            <h3 style="margin: 0 0 12px 0; font-size: 16px; color: #333; font-weight: 600;">ğŸ’° é‡‘æµ</h3>
                            <div onclick="openTransactionDialog('${member.id}')" style="
                                background: #f8f9fa;
                                border-radius: 8px;
                                padding: 12px 16px;
                                cursor: pointer;
                                transition: all 0.2s;
                                border: 2px solid transparent;
                            " onmouseenter="this.style.background='#e8f4e8'; this.style.borderColor='#4caf50'" 
                               onmouseleave="this.style.background='#f8f9fa'; this.style.borderColor='transparent'">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; padding-bottom: 8px; border-bottom: 1px solid #e0e0e0;">
                                    <span style="font-size: 12px; color: #4caf50; font-weight: 500;">é»æ“Šè¨˜å¸³ â†’</span>
                                </div>
                                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; font-size: 13px;">
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">å„²å€¼</span><span style="font-weight: 500;">$${(member.balance || 0).toFixed(0)}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">VIPç¥¨åˆ¸</span><span style="font-weight: 500;">$${(member.vip_voucher_amount || 0).toFixed(0)}</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">G23èˆ¹åˆ¸</span><span style="font-weight: 500;">${member.boat_voucher_g23_minutes || 0}åˆ†</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">G21/é»‘è±¹</span><span style="font-weight: 500;">${member.boat_voucher_g21_panther_minutes || 0}åˆ†</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">è´ˆé€å¤§èˆ¹</span><span style="font-weight: 500;">${member.gift_boat_hours || 0}åˆ†</span></div>
                                    <div style="display: flex; justify-content: space-between;"><span style="color: #666;">æŒ‡å®šèª²</span><span style="font-weight: 500;">${member.designated_lesson_minutes || 0}åˆ†</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                dialog.classList.add('active');
                window.currentMemberDetail = member;
            } catch (error) {
                console.error('è¼‰å…¥æœƒå“¡è©³æƒ…å¤±æ•—:', error);
                alert('è¼‰å…¥æœƒå“¡è©³æƒ…å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é—œé–‰æœƒå“¡è©³æƒ…å°è©±æ¡†
        function closeMemberDetailDialog() {
            const dialog = document.getElementById('member-detail-dialog');
            if (dialog) {
                dialog.classList.remove('active');
            }
        }
        
        // é–‹å•Ÿç·¨è¼¯æœƒå“¡å°è©±æ¡†
        async function openEditMemberDialog(memberId) {
            await showEditMemberDialog(memberId);
        }
        
        // é¡¯ç¤ºç·¨è¼¯æœƒå“¡å°è©±æ¡†
        async function showEditMemberDialog(memberId) {
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                const dialog = document.getElementById('add-member-dialog');
                if (!dialog) return;
                
                const formatDateForInput = (dateStr) => {
                    if (!dateStr) return '';
                    return dateStr.split('T')[0];
                };
                
                dialog.innerHTML = `
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold;">âœï¸ ç·¨è¼¯æœƒå“¡</h2>
                        <button onclick="closeAddMemberDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                    </div>
                    <form id="edit-member-form" style="padding: 20px;" onsubmit="handleEditMember(event, '${memberId}')">
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">å§“å <span style="color: red;">*</span></label>
                            <input type="text" id="edit-member-name" value="${member.name || ''}" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æš±ç¨± <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input type="text" id="edit-member-nickname" value="${member.nickname || ''}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">é›»è©± <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input type="tel" id="edit-member-phone" value="${member.phone || ''}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">ç”Ÿæ—¥ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                            <input type="date" id="edit-member-birthday" value="${formatDateForInput(member.birthday)}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                        </div>
                        <div style="margin-bottom: 16px;">
                            <label style="display: block; margin-bottom: 8px; font-weight: 500;">æœƒç±é¡å‹ <span style="color: red;">*</span></label>
                            <select id="edit-member-type" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                                <option value="general" ${member.membership_type === 'general' ? 'selected' : ''}>æœƒå“¡</option>
                                <option value="dual" ${member.membership_type === 'dual' ? 'selected' : ''}>é›™äººæœƒå“¡</option>
                                <option value="guest" ${member.membership_type === 'guest' ? 'selected' : ''}>éæœƒå“¡</option>
                                <option value="es" ${member.membership_type === 'es' ? 'selected' : ''}>ES</option>
                            </select>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 16px;">
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æœƒå“¡é–‹å§‹æ—¥æœŸ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                                <input type="date" id="edit-member-start-date" value="${formatDateForInput(member.membership_start_date)}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 8px; font-weight: 500; color: #666;">æœƒå“¡æˆªæ­¢æ—¥æœŸ <span style="font-size: 13px;">ï¼ˆé¸å¡«ï¼‰</span></label>
                                <input type="date" id="edit-member-end-date" value="${formatDateForInput(member.membership_end_date)}" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                            </div>
                        </div>
                        <div style="display: flex; gap: 12px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                            <button type="button" onclick="closeAddMemberDialog()" style="flex: 1; padding: 12px 24px; border: 1px solid #ccc; border-radius: 8px; background: white; color: #333; font-size: 15px; font-weight: 500; cursor: pointer;">å–æ¶ˆ</button>
                            <button type="submit" style="flex: 1; padding: 12px 24px; border: none; border-radius: 8px; background: linear-gradient(135deg, #5a5a5a 0%, #4a4a4a 100%); color: white; font-size: 15px; font-weight: 600; cursor: pointer;">âœ… ç¢ºèªä¿®æ”¹</button>
                        </div>
                    </form>
                `;
                dialog.classList.add('active');
            } catch (error) {
                console.error('è¼‰å…¥ç·¨è¼¯æœƒå“¡è¡¨å–®å¤±æ•—:', error);
                alert('è¼‰å…¥ç·¨è¼¯æœƒå“¡è¡¨å–®å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // è™•ç†ç·¨è¼¯æœƒå“¡
        async function handleEditMember(event, memberId) {
            event.preventDefault();
            
            try {
                if (!db) await initDatabase();
                
                const name = document.getElementById('edit-member-name').value.trim();
                const nickname = document.getElementById('edit-member-nickname').value.trim();
                const phone = document.getElementById('edit-member-phone').value.trim();
                const birthday = document.getElementById('edit-member-birthday').value;
                const membershipType = document.getElementById('edit-member-type').value;
                const membershipStartDate = document.getElementById('edit-member-start-date').value;
                const membershipEndDate = document.getElementById('edit-member-end-date').value;
                
                if (!name) {
                    alert('è«‹è¼¸å…¥å§“å');
                    return;
                }
                
                // é©—è­‰é›»è©±æ ¼å¼
                if (phone && !/^09\d{8}$/.test(phone)) {
                    alert('é›»è©±éœ€ç‚º 09 é–‹é ­çš„ 10 ä½æ•¸å­—');
                    return;
                }
                
                // è¼‰å…¥ç¾æœ‰æœƒå“¡è³‡æ–™ä»¥ä¿ç•™å…¶ä»–æ¬„ä½
                const members = await getAllFromStore('members');
                const existingMember = members.find(m => m.id === memberId);
                
                if (!existingMember) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // æ›´æ–°æœƒå“¡è³‡æ–™
                const updatedMemberData = {
                    ...existingMember,
                    name: name,
                    nickname: nickname || null,
                    phone: phone || null,
                    birthday: birthday || null,
                    membership_type: membershipType,
                    membership_start_date: membershipStartDate || null,
                    membership_end_date: membershipEndDate || null,
                    updated_at: new Date().toISOString()
                };
                
                // æ›´æ–°åˆ° IndexedDB
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                await new Promise((resolve, reject) => {
                    const request = store.put(updatedMemberData);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                alert('æœƒå“¡è³‡æ–™æ›´æ–°æˆåŠŸï¼');
                closeAddMemberDialog();
                
                // å¦‚æœæœƒå“¡è©³æƒ…å°è©±æ¡†æ˜¯é–‹å•Ÿçš„ï¼Œé‡æ–°è¼‰å…¥
                const detailDialog = document.getElementById('member-detail-dialog');
                if (detailDialog && detailDialog.classList.contains('active')) {
                    await showMemberDetailDialog(memberId);
                }
                
                // é‡æ–°è¼‰å…¥æœƒå“¡åˆ—è¡¨
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('æ›´æ–°æœƒå“¡å¤±æ•—:', error);
                alert('æ›´æ–°æœƒå“¡å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // éš±è—æœƒå“¡
        async function hideMember(memberId) {
            if (!confirm('ç¢ºå®šè¦éš±è—æ­¤æœƒå“¡å—ï¼Ÿ')) return;
            
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // æ›´æ–°ç‹€æ…‹ç‚º inactive
                const updatedMember = {
                    ...member,
                    status: 'inactive',
                    membership_partner_id: null, // æ¸…é™¤é…å°é—œä¿‚
                    updated_at: new Date().toISOString()
                };
                
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                await new Promise((resolve, reject) => {
                    const request = store.put(updatedMember);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                const today = new Date().toISOString().split('T')[0];
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: memberId,
                            event_date: today,
                            event_type: 'å‚™è¨»',
                            description: 'æœƒå“¡éš±è—'
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert('å·²éš±è—æœƒå“¡');
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('éš±è—æœƒå“¡å¤±æ•—:', error);
                alert('éš±è—æœƒå“¡å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // æ¢å¾©æœƒå“¡
        async function restoreMember(memberId) {
            if (!confirm('ç¢ºå®šè¦æ¢å¾©æ­¤æœƒå“¡å—ï¼Ÿ')) return;
            
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // æ›´æ–°ç‹€æ…‹ç‚º active
                const updatedMember = {
                    ...member,
                    status: 'active',
                    updated_at: new Date().toISOString()
                };
                
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                await new Promise((resolve, reject) => {
                    const request = store.put(updatedMember);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                const today = new Date().toISOString().split('T')[0];
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: memberId,
                            event_date: today,
                            event_type: 'å‚™è¨»',
                            description: 'æœƒå“¡æ¢å¾©'
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert('å·²æ¢å¾©æœƒå“¡');
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('æ¢å¾©æœƒå“¡å¤±æ•—:', error);
                alert('æ¢å¾©æœƒå“¡å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // åŒ¯å‡ºæœƒå“¡è³‡æ–™
        async function exportMembers() {
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æ‰€æœ‰æœƒå“¡è³‡æ–™å’Œå‚™å¿˜éŒ„
                const [allMembers, memberNotes] = await Promise.all([
                    getAllFromStore('members'),
                    getAllFromStore('member_notes').catch(() => [])
                ]);
                
                if (allMembers.length === 0) {
                    alert('æ²’æœ‰æœƒå“¡è³‡æ–™å¯ä»¥å°å‡º');
                    return;
                }
                
                // æ•´ç†å‚™å¿˜éŒ„è³‡æ–™
                const memberNotesMap = {};
                memberNotes.forEach(note => {
                    if (!memberNotesMap[note.member_id]) {
                        memberNotesMap[note.member_id] = [];
                    }
                    const noteStr = note.event_date 
                        ? `${note.event_date} ${note.description}`
                        : note.description;
                    memberNotesMap[note.member_id].push(noteStr);
                });
                
                // æº–å‚™ CSV å…§å®¹
                const headers = [
                    'å§“å', 'æš±ç¨±', 'æœƒç±é¡å‹', 'é…å°æœƒå“¡', 
                    'æœƒå“¡é–‹å§‹æ—¥æœŸ', 'æœƒå“¡æˆªæ­¢æ—¥', 'é›»è©±', 'ç”Ÿæ—¥', 'å‚™å¿˜éŒ„', 'ç‹€æ…‹'
                ];
                
                const rows = allMembers.map(member => {
                    // æœƒç±é¡å‹
                    let membershipTypeLabel = 'ä¸€èˆ¬æœƒå“¡';
                    if (member.membership_type === 'dual') {
                        membershipTypeLabel = 'é›™äººæœƒå“¡';
                    } else if (member.membership_type === 'guest') {
                        membershipTypeLabel = 'éæœƒå“¡';
                    } else if (member.membership_type === 'es') {
                        membershipTypeLabel = 'ES';
                    }
                    
                    // é…å°æœƒå“¡ï¼ˆç›®å‰é›¢ç·šç‰ˆä¸æ”¯æ´ï¼Œç•™ç©ºï¼‰
                    const partnerName = '';
                    
                    // å‚™å¿˜éŒ„ï¼ˆç”¨åˆ†è™Ÿåˆ†éš”ï¼‰
                    const notesStr = memberNotesMap[member.id]?.join(' ; ') || '';
                    
                    // æ ¼å¼åŒ–æ—¥æœŸ
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '';
                        return dateStr.split('T')[0];
                    };
                    
                    return [
                        member.name || '',
                        member.nickname || '',
                        membershipTypeLabel,
                        partnerName,
                        formatDate(member.membership_start_date),
                        formatDate(member.membership_end_date),
                        member.phone || '',
                        formatDate(member.birthday),
                        notesStr,
                        member.status === 'active' ? 'å•Ÿç”¨' : 'éš±è—'
                    ];
                });
                
                // ç”Ÿæˆ CSV å…§å®¹
                const csvContent = [
                    headers.join(','),
                    ...rows.map(row => row.map(cell => {
                        // è™•ç†åŒ…å«é€—è™Ÿã€æ›è¡Œç¬¦æˆ–é›™å¼•è™Ÿçš„å…§å®¹
                        const cellStr = String(cell);
                        if (cellStr.includes(',') || cellStr.includes('\n') || cellStr.includes('"')) {
                            return `"${cellStr.replace(/"/g, '""')}"`;
                        }
                        return cellStr;
                    }).join(','))
                ].join('\n');
                
                // ä¸‹è¼‰æª”æ¡ˆ
                const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                
                const today = new Date();
                const dateStr = `${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}`;
                link.setAttribute('download', `æœƒå“¡è³‡æ–™_${dateStr}.csv`);
                
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                alert(`æˆåŠŸå°å‡º ${allMembers.length} ä½æœƒå“¡è³‡æ–™`);
            } catch (error) {
                console.error('å°å‡ºå¤±æ•—:', error);
                alert('å°å‡ºå¤±æ•—ï¼š' + error.message);
            }
        }
        
        // çºŒç´„æœƒç±
        async function renewMembership(memberId) {
            const newEndDate = prompt('è«‹è¼¸å…¥æ–°çš„åˆ°æœŸæ—¥ï¼ˆYYYY-MM-DDï¼‰ï¼š');
            if (!newEndDate) return;
            
            try {
                if (!db) await initDatabase();
                
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                const getRequest = store.get(memberId);
                
                await new Promise((resolve, reject) => {
                    getRequest.onsuccess = () => {
                        const member = getRequest.result;
                        if (!member) {
                            reject(new Error('æ‰¾ä¸åˆ°æœƒå“¡'));
                            return;
                        }
                        
                        member.membership_end_date = newEndDate;
                        member.updated_at = new Date().toISOString();
                        
                        const updateRequest = store.put(member);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = () => reject(updateRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: memberId,
                            event_date: new Date().toISOString().split('T')[0],
                            event_type: 'çºŒç´„',
                            description: `çºŒç´„è‡³ ${newEndDate}`
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert('çºŒç´„æˆåŠŸï¼');
                await showMemberDetailDialog(memberId);
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('çºŒç´„å¤±æ•—:', error);
                alert('çºŒç´„å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é–‹å•Ÿæ–°å¢ç½®æ¿å°è©±æ¡†
        function openAddBoardDialog(memberId) {
            const slotNumber = prompt('è«‹è¼¸å…¥æ ¼ä½ç·¨è™Ÿï¼ˆ1-145ï¼‰ï¼š');
            if (!slotNumber) return;
            
            const slotNum = parseInt(slotNumber);
            if (isNaN(slotNum) || slotNum < 1 || slotNum > 145) {
                alert('æ ¼ä½ç·¨è™Ÿå¿…é ˆæ˜¯ 1-145 ä¹‹é–“çš„æ•¸å­—');
                return;
            }
            
            const startDate = prompt('è«‹è¼¸å…¥é–‹å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
            const expiresAt = prompt('è«‹è¼¸å…¥åˆ°æœŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
            const notes = prompt('è«‹è¼¸å…¥å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š') || null;
            
            addBoard(memberId, slotNum, startDate, expiresAt, notes);
        }
        
        // æ–°å¢ç½®æ¿
        async function addBoard(memberId, slotNumber, startDate, expiresAt, notes) {
            try {
                if (!db) await initDatabase();
                
                // æª¢æŸ¥æ ¼ä½æ˜¯å¦å·²è¢«ä½¿ç”¨
                try {
                    const boards = await getAllFromStore('board_storage');
                    const existing = boards.find(b => b.slot_number === slotNumber && b.status === 'active');
                    if (existing) {
                        alert(`æ ¼ä½ ${slotNumber} å·²è¢«ä½¿ç”¨ï¼Œè«‹é¸æ“‡å…¶ä»–æ ¼ä½`);
                        return;
                    }
                } catch (e) {
                    console.warn('ç„¡æ³•æª¢æŸ¥æ ¼ä½:', e);
                }
                
                await createTableIfNotExists('board_storage', 'id', true);
                const transaction = db.transaction(['board_storage'], 'readwrite');
                const store = transaction.objectStore('board_storage');
                
                await new Promise((resolve, reject) => {
                    const request = store.add({
                        member_id: memberId,
                        slot_number: slotNumber,
                        start_date: startDate,
                        expires_at: expiresAt,
                        notes: notes,
                        status: 'active'
                    });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: memberId,
                            event_date: startDate || new Date().toISOString().split('T')[0],
                            event_type: 'å‚™è¨»',
                            description: `ç½®æ¿é–‹å§‹ #${slotNumber}${expiresAt ? 'ï¼Œè‡³ ' + expiresAt : ''}`
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert(`å·²æ–°å¢æ ¼ä½ #${slotNumber}`);
                if (window.currentMemberDetail) {
                    await showMemberDetailDialog(memberId);
                }
                await loadAndDisplayMembers();
                await loadAndDisplayBoards();
            } catch (error) {
                console.error('æ–°å¢ç½®æ¿å¤±æ•—:', error);
                alert('æ–°å¢ç½®æ¿å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é–‹å•Ÿç·¨è¼¯ç½®æ¿å°è©±æ¡†
        function openEditBoardDialog(boardId, slotNumber) {
            // å¯¦ç¾ç·¨è¼¯ç½®æ¿åŠŸèƒ½
            alert('ç·¨è¼¯ç½®æ¿åŠŸèƒ½é–‹ç™¼ä¸­');
        }
        
        // çºŒç´„ç½®æ¿
        async function renewBoard(boardId, slotNumber, currentExpiry) {
            const newEndDate = prompt('è«‹è¼¸å…¥æ–°çš„åˆ°æœŸæ—¥ï¼ˆYYYY-MM-DDï¼‰ï¼š', currentExpiry ? new Date(new Date(currentExpiry).setFullYear(new Date(currentExpiry).getFullYear() + 1)).toISOString().split('T')[0] : '');
            if (!newEndDate) return;
            
            try {
                if (!db) await initDatabase();
                
                const transaction = db.transaction(['board_storage'], 'readwrite');
                const store = transaction.objectStore('board_storage');
                const getRequest = store.get(boardId);
                
                await new Promise((resolve, reject) => {
                    getRequest.onsuccess = () => {
                        const board = getRequest.result;
                        if (!board) {
                            reject(new Error('æ‰¾ä¸åˆ°ç½®æ¿è³‡æ–™'));
                            return;
                        }
                        
                        board.expires_at = newEndDate;
                        
                        const updateRequest = store.put(board);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = () => reject(updateRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: board.member_id,
                            event_date: new Date().toISOString().split('T')[0],
                            event_type: 'çºŒç´„ç½®æ¿',
                            description: `ç½®æ¿çºŒç´„ #${slotNumber}ï¼Œè‡³ ${newEndDate}`
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert(`æ ¼ä½ #${slotNumber} å·²å»¶é•·è‡³ ${newEndDate}`);
                if (window.currentMemberDetail) {
                    await showMemberDetailDialog(board.member_id);
                }
                await loadAndDisplayMembers();
                await loadAndDisplayBoards();
            } catch (error) {
                console.error('ç½®æ¿çºŒç´„å¤±æ•—:', error);
                alert('ç½®æ¿çºŒç´„å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é–‹å•Ÿæ–°å¢å‚™å¿˜éŒ„å°è©±æ¡†
        function openAddNoteDialog(memberId) {
            const eventDate = prompt('è«‹è¼¸å…¥äº‹ä»¶æ—¥æœŸï¼ˆYYYY-MM-DDï¼‰ï¼š', new Date().toISOString().split('T')[0]);
            if (!eventDate) return;
            
            const eventType = prompt('è«‹è¼¸å…¥äº‹ä»¶é¡å‹ï¼ˆçºŒç´„/è³¼è²·/è´ˆé€/ä½¿ç”¨/å…¥æœƒ/å‚™è¨»ï¼‰ï¼š', 'å‚™è¨»');
            if (!eventType) return;
            
            const description = prompt('è«‹è¼¸å…¥èªªæ˜ï¼š');
            if (!description) return;
            
            addNote(memberId, eventDate, eventType, description);
        }
        
        // æ–°å¢å‚™å¿˜éŒ„
        async function addNote(memberId, eventDate, eventType, description) {
            try {
                if (!db) await initDatabase();
                
                await createTableIfNotExists('member_notes', 'id', true);
                const transaction = db.transaction(['member_notes'], 'readwrite');
                const store = transaction.objectStore('member_notes');
                
                await new Promise((resolve, reject) => {
                    const request = store.add({
                        member_id: memberId,
                        event_date: eventDate,
                        event_type: eventType,
                        description: description
                    });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                alert('å‚™å¿˜éŒ„å·²æ–°å¢');
                if (window.currentMemberDetail) {
                    await showMemberDetailDialog(memberId);
                }
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('æ–°å¢å‚™å¿˜éŒ„å¤±æ•—:', error);
                alert('æ–°å¢å‚™å¿˜éŒ„å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // ç·¨è¼¯å‚™å¿˜éŒ„
        function editNote(noteId) {
            alert('ç·¨è¼¯å‚™å¿˜éŒ„åŠŸèƒ½é–‹ç™¼ä¸­');
        }
        
        // åˆªé™¤å‚™å¿˜éŒ„
        async function deleteNote(noteId, memberId) {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤é€™å‰‡å‚™å¿˜éŒ„å—ï¼Ÿ')) return;
            
            try {
                if (!db) await initDatabase();
                
                const transaction = db.transaction(['member_notes'], 'readwrite');
                const store = transaction.objectStore('member_notes');
                
                await new Promise((resolve, reject) => {
                    const request = store.delete(noteId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                alert('å‚™å¿˜éŒ„å·²åˆªé™¤');
                await showMemberDetailDialog(memberId);
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('åˆªé™¤å‚™å¿˜éŒ„å¤±æ•—:', error);
                alert('åˆªé™¤å‚™å¿˜éŒ„å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é¡¯ç¤ºäº¤æ˜“å°è©±æ¡†
        async function showTransactionDialog(memberId) {
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // è¼‰å…¥äº¤æ˜“è¨˜éŒ„
                let transactions = [];
                try {
                    transactions = await getAllFromStore('transactions');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥äº¤æ˜“è¨˜éŒ„:', e);
                }
                
                const memberTransactions = transactions.filter(t => t.member_id === memberId)
                    .sort((a, b) => {
                        const dateA = a.transaction_date || (a.created_at ? a.created_at.split('T')[0] : '');
                        const dateB = b.transaction_date || (b.created_at ? b.created_at.split('T')[0] : '');
                        return dateB.localeCompare(dateA);
                    });
                
                const dialog = document.getElementById('transaction-dialog');
                if (!dialog) return;
                
                const CATEGORIES = [
                    { value: 'balance', label: 'ğŸ’° å„²å€¼', unit: 'å…ƒ' },
                    { value: 'vip_voucher', label: 'ğŸ’ VIPç¥¨åˆ¸', unit: 'å…ƒ' },
                    { value: 'designated_lesson', label: 'ğŸ“š æŒ‡å®šèª²', unit: 'åˆ†' },
                    { value: 'boat_voucher_g23', label: 'ğŸš¤ G23èˆ¹åˆ¸', unit: 'åˆ†' },
                    { value: 'boat_voucher_g21_panther', label: 'â›µ G21/é»‘è±¹èˆ¹åˆ¸', unit: 'åˆ†' },
                    { value: 'gift_boat_hours', label: 'ğŸ è´ˆé€å¤§èˆ¹', unit: 'åˆ†' }
                ];
                
                dialog.innerHTML = `
                    <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 20px; font-weight: bold;">ğŸ’³ ${member.nickname || member.name}</h2>
                        <button onclick="closeTransactionDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                    </div>
                    <div style="padding: 20px;">
                        <!-- ç•¶å‰é¤˜é¡ -->
                        <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 20px;">
                            <div style="font-size: 13px; color: #666; margin-bottom: 12px; font-weight: 600;">ğŸ“Š ç•¶å‰é¤˜é¡</div>
                            <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; font-size: 13px;">
                                <div><div style="color: #999; margin-bottom: 4px;">ğŸ’° å„²å€¼</div><div style="font-weight: bold; color: #333;">$${(member.balance || 0).toLocaleString()}</div></div>
                                <div><div style="color: #999; margin-bottom: 4px;">ğŸ’ VIPç¥¨åˆ¸</div><div style="font-weight: bold; color: #333;">$${(member.vip_voucher_amount || 0).toLocaleString()}</div></div>
                                <div><div style="color: #999; margin-bottom: 4px;">ğŸ“š æŒ‡å®šèª²</div><div style="font-weight: bold; color: #333;">${(member.designated_lesson_minutes || 0).toLocaleString()}åˆ†</div></div>
                                <div><div style="color: #999; margin-bottom: 4px;">ğŸš¤ G23èˆ¹åˆ¸</div><div style="font-weight: bold; color: #333;">${(member.boat_voucher_g23_minutes || 0).toLocaleString()}åˆ†</div></div>
                                <div><div style="color: #999; margin-bottom: 4px;">â›µ G21/é»‘è±¹èˆ¹åˆ¸</div><div style="font-weight: bold; color: #333;">${(member.boat_voucher_g21_panther_minutes || 0).toLocaleString()}åˆ†</div></div>
                                <div><div style="color: #999; margin-bottom: 4px;">ğŸ è´ˆé€å¤§èˆ¹</div><div style="font-weight: bold; color: #333;">${(member.gift_boat_hours || 0).toLocaleString()}åˆ†</div></div>
                            </div>
                        </div>
                        
                        <!-- è¨˜å¸³è¡¨å–® -->
                        <form id="transaction-form" onsubmit="handleAddTransaction(event, '${memberId}')" style="margin-bottom: 30px;">
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">é …ç›® *</label>
                                <select id="tx-category" required style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                                    ${CATEGORIES.map(cat => `<option value="${cat.value}">${cat.label}</option>`).join('')}
                                </select>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">æ“ä½œ *</label>
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                                    <button type="button" id="tx-increase" onclick="setTransactionType('increase')" style="padding: 12px; border: 2px solid #1976d2; border-radius: 8px; background: #e3f2fd; color: #1976d2; font-size: 14px; font-weight: 600; cursor: pointer;">â• å¢åŠ </button>
                                    <button type="button" id="tx-decrease" onclick="setTransactionType('decrease')" style="padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; background: white; color: #666; font-size: 14px; cursor: pointer;">â– æ¸›å°‘</button>
                                </div>
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">æ•¸å€¼ *</label>
                                <input type="text" id="tx-value" inputmode="numeric" required placeholder="è«‹è¼¸å…¥æ•¸å€¼" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">äº¤æ˜“æ—¥æœŸ *</label>
                                <input type="date" id="tx-date" required value="${new Date().toISOString().split('T')[0]}" style="width: 100%; padding: 12px; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 16px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">èªªæ˜ *</label>
                                <input type="text" id="tx-description" required placeholder="ä¾‹å¦‚ï¼šå„²å€¼ã€è³¼è²·èª²ç¨‹ç­‰" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                            </div>
                            <div style="margin-bottom: 20px;">
                                <label style="display: block; margin-bottom: 8px; font-weight: 600; font-size: 14px;">å‚™è¨»</label>
                                <textarea id="tx-notes" placeholder="é¸å¡«ï¼šè¨˜éŒ„åŸå› æˆ–å…¶ä»–èªªæ˜" rows="3" style="width: 100%; padding: 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical; box-sizing: border-box; font-family: inherit;"></textarea>
                            </div>
                            <button type="submit" style="width: 100%; padding: 14px; background: #424242; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer;">ç¢ºèªè¨˜å¸³</button>
                        </form>
                        
                        <!-- äº¤æ˜“è¨˜éŒ„ -->
                        <div style="margin-top: 30px;">
                            <h3 style="margin: 0 0 16px 0; font-size: 16px; font-weight: 600;">ğŸ“Š äº¤æ˜“è¨˜éŒ„</h3>
                            ${memberTransactions.length === 0 ? `
                                <div style="text-align: center; padding: 40px; color: #999;">ç„¡äº¤æ˜“è¨˜éŒ„</div>
                            ` : `
                                <div style="display: flex; flex-direction: column; gap: 12px; max-height: 400px; overflow-y: auto;">
                                    ${memberTransactions.map(tx => {
                                        const categoryConfig = CATEGORIES.find(c => c.value === tx.category);
                                        const isIncrease = tx.adjust_type === 'increase';
                                        const value = tx.amount || tx.minutes || 0;
                                        return `
                                            <div style="background: #f8f9fa; padding: 14px; border-radius: 8px; border-left: 4px solid ${isIncrease ? '#4caf50' : '#f44336'};">
                                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                                                    <div style="flex: 1;">
                                                        <div style="font-size: 14px; font-weight: 600; margin-bottom: 4px;">${categoryConfig?.label || tx.category}</div>
                                                        <div style="font-size: 13px; color: #666; margin-bottom: 4px;">${tx.description}</div>
                                                        <div style="font-size: 12px; color: #999;">${tx.transaction_date || (tx.created_at ? tx.created_at.split('T')[0] : '-')}</div>
                                                    </div>
                                                    <div style="font-size: 18px; font-weight: bold; color: ${isIncrease ? '#1976d2' : '#757575'}; white-space: nowrap; margin-left: 12px;">
                                                        ${isIncrease ? '+' : '-'}${categoryConfig?.unit === 'å…ƒ' ? '$' : ''}${Math.abs(value).toLocaleString()}${categoryConfig?.unit === 'åˆ†' ? 'åˆ†' : ''}
                                                    </div>
                                                </div>
                                                ${tx.notes ? `<div style="font-size: 13px; color: #666; margin-top: 8px; padding: 8px; background: white; border-radius: 4px;">å‚™è¨»ï¼š${tx.notes}</div>` : ''}
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            `}
                        </div>
                    </div>
                `;
                
                dialog.classList.add('active');
                window.currentTransactionType = 'increase';
                updateTransactionButtons();
            } catch (error) {
                console.error('è¼‰å…¥äº¤æ˜“å°è©±æ¡†å¤±æ•—:', error);
                alert('è¼‰å…¥äº¤æ˜“å°è©±æ¡†å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // è¨­å®šäº¤æ˜“é¡å‹
        function setTransactionType(type) {
            window.currentTransactionType = type;
            updateTransactionButtons();
        }
        
        // æ›´æ–°äº¤æ˜“æŒ‰éˆ•æ¨£å¼
        function updateTransactionButtons() {
            const increaseBtn = document.getElementById('tx-increase');
            const decreaseBtn = document.getElementById('tx-decrease');
            const type = window.currentTransactionType || 'increase';
            
            if (increaseBtn && decreaseBtn) {
                if (type === 'increase') {
                    increaseBtn.style.border = '2px solid #1976d2';
                    increaseBtn.style.background = '#e3f2fd';
                    increaseBtn.style.color = '#1976d2';
                    increaseBtn.style.fontWeight = '600';
                    decreaseBtn.style.border = '2px solid #e0e0e0';
                    decreaseBtn.style.background = 'white';
                    decreaseBtn.style.color = '#666';
                    decreaseBtn.style.fontWeight = 'normal';
                } else {
                    decreaseBtn.style.border = '2px solid #757575';
                    decreaseBtn.style.background = '#f5f5f5';
                    decreaseBtn.style.color = '#757575';
                    decreaseBtn.style.fontWeight = '600';
                    increaseBtn.style.border = '2px solid #e0e0e0';
                    increaseBtn.style.background = 'white';
                    increaseBtn.style.color = '#666';
                    increaseBtn.style.fontWeight = 'normal';
                }
            }
        }
        
        // é—œé–‰äº¤æ˜“å°è©±æ¡†
        function closeTransactionDialog() {
            const dialog = document.getElementById('transaction-dialog');
            if (dialog) {
                dialog.classList.remove('active');
            }
        }
        
        // è™•ç†æ–°å¢äº¤æ˜“
        async function handleAddTransaction(event, memberId) {
            event.preventDefault();
            
            try {
                if (!db) await initDatabase();
                
                const category = document.getElementById('tx-category').value;
                const adjustType = window.currentTransactionType || 'increase';
                const value = parseFloat(document.getElementById('tx-value').value);
                const transactionDate = document.getElementById('tx-date').value;
                const description = document.getElementById('tx-description').value.trim();
                const notes = document.getElementById('tx-notes').value.trim();
                
                if (isNaN(value) || value < 0) {
                    alert('è«‹è¼¸å…¥æœ‰æ•ˆçš„æ•¸å€¼');
                    return;
                }
                
                if (!description) {
                    alert('è«‹è¼¸å…¥èªªæ˜');
                    return;
                }
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const member = members.find(m => m.id === memberId);
                
                if (!member) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡è³‡æ–™');
                    return;
                }
                
                // è¨ˆç®—æ–°å€¼
                const delta = adjustType === 'increase' ? value : -value;
                const CATEGORIES = {
                    'balance': { field: 'balance', type: 'amount' },
                    'vip_voucher': { field: 'vip_voucher_amount', type: 'amount' },
                    'designated_lesson': { field: 'designated_lesson_minutes', type: 'minutes' },
                    'boat_voucher_g23': { field: 'boat_voucher_g23_minutes', type: 'minutes' },
                    'boat_voucher_g21_panther': { field: 'boat_voucher_g21_panther_minutes', type: 'minutes' },
                    'gift_boat_hours': { field: 'gift_boat_hours', type: 'minutes' }
                };
                
                const categoryConfig = CATEGORIES[category];
                if (!categoryConfig) {
                    alert('ç„¡æ•ˆçš„é …ç›®');
                    return;
                }
                
                // æ›´æ–°æœƒå“¡é¤˜é¡
                const transaction = db.transaction(['members'], 'readwrite');
                const store = transaction.objectStore('members');
                const getRequest = store.get(memberId);
                
                await new Promise((resolve, reject) => {
                    getRequest.onsuccess = () => {
                        const member = getRequest.result;
                        if (!member) {
                            reject(new Error('æ‰¾ä¸åˆ°æœƒå“¡'));
                            return;
                        }
                        
                        member[categoryConfig.field] = (member[categoryConfig.field] || 0) + delta;
                        member.updated_at = new Date().toISOString();
                        
                        const updateRequest = store.put(member);
                        updateRequest.onsuccess = () => resolve();
                        updateRequest.onerror = () => reject(updateRequest.error);
                    };
                    getRequest.onerror = () => reject(getRequest.error);
                });
                
                // è¨˜éŒ„äº¤æ˜“
                await createTableIfNotExists('transactions', 'id', true);
                const txTransaction = db.transaction(['transactions'], 'readwrite');
                const txStore = txTransaction.objectStore('transactions');
                
                await new Promise((resolve, reject) => {
                    const request = txStore.add({
                        member_id: memberId,
                        transaction_type: 'adjust',
                        category: category,
                        adjust_type: adjustType,
                        amount: categoryConfig.type === 'amount' ? value : null,
                        minutes: categoryConfig.type === 'minutes' ? value : null,
                        description: description,
                        notes: notes || null,
                        transaction_date: transactionDate,
                        created_at: new Date().toISOString()
                    });
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                const unit = categoryConfig.type === 'amount' ? '$' : 'åˆ†';
                const changeText = adjustType === 'increase' ? `+${unit}${value.toLocaleString()}` : `-${unit}${value.toLocaleString()}`;
                alert(`è¨˜å¸³æˆåŠŸï¼${changeText}`);
                
                closeTransactionDialog();
                await loadAndDisplayMemberTransactions();
                if (window.currentMemberDetail) {
                    await showMemberDetailDialog(memberId);
                }
            } catch (error) {
                console.error('è¨˜å¸³å¤±æ•—:', error);
                alert('è¨˜å¸³å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é¡¯ç¤ºç½®æ¿æ ¼ä½å°è©±æ¡†
        async function showBoardSlotDialog(slotNumber) {
            try {
                if (!db) await initDatabase();
                
                // è¼‰å…¥ç½®æ¿è³‡æ–™
                let boardStorage = [];
                try {
                    boardStorage = await getAllFromStore('board_storage');
                } catch (e) {
                    console.warn('ç„¡æ³•è¼‰å…¥ç½®æ¿è³‡æ–™:', e);
                }
                
                const board = boardStorage.find(b => b.slot_number === slotNumber && b.status === 'active');
                
                // è¼‰å…¥æœƒå“¡è³‡æ–™
                const members = await getAllFromStore('members');
                const membersMap = {};
                members.forEach(m => {
                    membersMap[m.id] = m;
                });
                
                const dialog = document.getElementById('board-slot-dialog');
                if (!dialog) return;
                
                if (board) {
                    const member = membersMap[board.member_id];
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '';
                        return dateStr.split('T')[0];
                    };
                    
                    dialog.innerHTML = `
                        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">æ ¼ä½ ${slotNumber}</h2>
                            <button onclick="closeBoardSlotDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                        </div>
                        <div style="padding: 20px;">
                            <div style="margin-bottom: 20px; padding: 16px; background: #f8f9fa; border-radius: 8px;">
                                <div style="font-size: 14px; color: #666; margin-bottom: 8px;">æœƒå“¡</div>
                                <div style="font-size: 18px; font-weight: bold;">${member?.nickname || member?.name || 'æœªçŸ¥'}</div>
                            </div>
                            ${board.start_date ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">é–‹å§‹æ—¥æœŸ</div>
                                    <div style="font-size: 16px;">${formatDate(board.start_date)}</div>
                                </div>
                            ` : ''}
                            ${board.expires_at ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">åˆ°æœŸæ—¥æœŸ</div>
                                    <div style="font-size: 16px;">${formatDate(board.expires_at)}</div>
                                </div>
                            ` : ''}
                            ${board.notes ? `
                                <div style="margin-bottom: 16px;">
                                    <div style="font-size: 14px; color: #666; margin-bottom: 8px;">å‚™è¨»</div>
                                    <div style="font-size: 14px; font-style: italic; color: #999;">${board.notes}</div>
                                </div>
                            ` : ''}
                            <div style="display: flex; gap: 10px; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                                <button onclick="openEditBoardDialog('${board.id}', ${slotNumber})" style="flex: 1; padding: 10px 20px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">âœï¸ ç·¨è¼¯</button>
                                <button onclick="deleteBoard('${board.id}', ${slotNumber}, '${board.member_id}')" style="flex: 1; padding: 10px 20px; background: #f44336; color: white; border: none; border-radius: 6px; font-size: 14px; font-weight: bold; cursor: pointer;">ğŸ—‘ï¸ åˆªé™¤</button>
                            </div>
                        </div>
                    `;
                } else {
                    dialog.innerHTML = `
                        <div style="padding: 20px; border-bottom: 1px solid #e0e0e0; display: flex; justify-content: space-between; align-items: center;">
                            <h2 style="margin: 0; font-size: 20px; font-weight: bold;">æ ¼ä½ ${slotNumber}</h2>
                            <button onclick="closeBoardSlotDialog()" style="border: none; background: none; font-size: 24px; cursor: pointer; color: #666; padding: 0 8px;">Ã—</button>
                        </div>
                        <div style="padding: 40px 20px; text-align: center; color: #999;">
                            <div style="font-size: 48px; margin-bottom: 16px;">ğŸ„</div>
                            <div style="font-size: 16px; margin-bottom: 20px;">æ­¤æ ¼ä½å°šæœªä½¿ç”¨</div>
                            <button onclick="openAddBoardSlotDialog(${slotNumber})" style="padding: 12px 24px; background: linear-gradient(135deg, #4caf50 0%, #45a049 100%); color: white; border: none; border-radius: 8px; font-size: 15px; font-weight: bold; cursor: pointer;">æ–°å¢ç½®æ¿</button>
                        </div>
                    `;
                }
                
                dialog.classList.add('active');
            } catch (error) {
                console.error('è¼‰å…¥ç½®æ¿æ ¼ä½å°è©±æ¡†å¤±æ•—:', error);
                alert('è¼‰å…¥ç½®æ¿æ ¼ä½å°è©±æ¡†å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // é—œé–‰ç½®æ¿æ ¼ä½å°è©±æ¡†
        function closeBoardSlotDialog() {
            const dialog = document.getElementById('board-slot-dialog');
            if (dialog) {
                dialog.classList.remove('active');
            }
        }
        
        // é–‹å•Ÿæ–°å¢ç½®æ¿æ ¼ä½å°è©±æ¡†
        function openAddBoardSlotDialog(slotNumber) {
            const memberSearch = prompt('è«‹è¼¸å…¥æœƒå“¡å§“åæˆ–æš±ç¨±ï¼š');
            if (!memberSearch) return;
            
            // æœå°‹æœƒå“¡
            searchMemberForBoard(memberSearch, slotNumber);
        }
        
        // æœå°‹æœƒå“¡ä¸¦æ–°å¢ç½®æ¿
        async function searchMemberForBoard(searchTerm, slotNumber) {
            try {
                if (!db) await initDatabase();
                
                const members = await getAllFromStore('members');
                const activeMembers = members.filter(m => m.status === 'active');
                
                const matched = activeMembers.filter(m => {
                    const name = (m.name || '').toLowerCase();
                    const nickname = (m.nickname || '').toLowerCase();
                    return name.includes(searchTerm.toLowerCase()) || nickname.includes(searchTerm.toLowerCase());
                });
                
                if (matched.length === 0) {
                    alert('æ‰¾ä¸åˆ°æœƒå“¡');
                    return;
                }
                
                if (matched.length > 1) {
                    const memberList = matched.map((m, i) => `${i + 1}. ${m.nickname || m.name}`).join('\n');
                    const index = prompt(`æ‰¾åˆ°å¤šå€‹æœƒå“¡ï¼Œè«‹é¸æ“‡ï¼š\n${memberList}\n\nè«‹è¼¸å…¥ç·¨è™Ÿï¼š`);
                    if (!index) return;
                    const selectedIndex = parseInt(index) - 1;
                    if (selectedIndex < 0 || selectedIndex >= matched.length) {
                        alert('ç„¡æ•ˆçš„ç·¨è™Ÿ');
                        return;
                    }
                    const member = matched[selectedIndex];
                    const startDate = prompt('è«‹è¼¸å…¥é–‹å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
                    const expiresAt = prompt('è«‹è¼¸å…¥åˆ°æœŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
                    const notes = prompt('è«‹è¼¸å…¥å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š') || null;
                    await addBoard(member.id, slotNumber, startDate, expiresAt, notes);
                } else {
                    const member = matched[0];
                    const startDate = prompt('è«‹è¼¸å…¥é–‹å§‹æ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
                    const expiresAt = prompt('è«‹è¼¸å…¥åˆ°æœŸæ—¥æœŸï¼ˆYYYY-MM-DDï¼Œé¸å¡«ï¼‰ï¼š') || null;
                    const notes = prompt('è«‹è¼¸å…¥å‚™è¨»ï¼ˆé¸å¡«ï¼‰ï¼š') || null;
                    await addBoard(member.id, slotNumber, startDate, expiresAt, notes);
                }
                
                closeBoardSlotDialog();
                await loadAndDisplayBoards();
            } catch (error) {
                console.error('æœå°‹æœƒå“¡å¤±æ•—:', error);
                alert('æœå°‹æœƒå“¡å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // åˆªé™¤ç½®æ¿
        async function deleteBoard(boardId, slotNumber, memberId) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤æ ¼ä½ #${slotNumber} å—ï¼Ÿ`)) return;
            
            try {
                if (!db) await initDatabase();
                
                const transaction = db.transaction(['board_storage'], 'readwrite');
                const store = transaction.objectStore('board_storage');
                
                await new Promise((resolve, reject) => {
                    const request = store.delete(boardId);
                    request.onsuccess = () => resolve();
                    request.onerror = () => reject(request.error);
                });
                
                // æ–°å¢å‚™å¿˜éŒ„
                try {
                    await createTableIfNotExists('member_notes', 'id', true);
                    const notesTransaction = db.transaction(['member_notes'], 'readwrite');
                    const notesStore = notesTransaction.objectStore('member_notes');
                    await new Promise((resolve, reject) => {
                        const request = notesStore.add({
                            member_id: memberId,
                            event_date: new Date().toISOString().split('T')[0],
                            event_type: 'å‚™è¨»',
                            description: `ç§»é™¤ç½®æ¿ #${slotNumber}`
                        });
                        request.onsuccess = () => resolve();
                        request.onerror = () => reject(request.error);
                    });
                } catch (e) {
                    console.warn('ç„¡æ³•æ–°å¢å‚™å¿˜éŒ„:', e);
                }
                
                alert(`å·²åˆªé™¤æ ¼ä½ #${slotNumber}`);
                closeBoardSlotDialog();
                await loadAndDisplayBoards();
                if (window.currentMemberDetail) {
                    await showMemberDetailDialog(memberId);
                }
                await loadAndDisplayMembers();
            } catch (error) {
                console.error('åˆªé™¤ç½®æ¿å¤±æ•—:', error);
                alert('åˆªé™¤ç½®æ¿å¤±æ•—ï¼š' + error.message);
            }
        }
        
        // æª¢æŸ¥æ˜¯å¦æœ‰å·²è¼‰å…¥çš„è³‡æ–™åº«
        window.addEventListener('load', async () => {
            try {
                // è¨­ç½®æª”æ¡ˆè¼¸å…¥äº‹ä»¶ç›£è½å™¨
                setupFileInput();
                
                // å…ˆé¡¯ç¤ºé¦–é ï¼ˆåŒ…å«è¼‰å…¥è³‡æ–™åº«æŒ‰éˆ•ï¼‰
                document.getElementById('db-loader').classList.remove('active');
                document.getElementById('main-content').classList.remove('hidden');
                showHomePage();
                
                // å˜—è©¦åˆå§‹åŒ–è³‡æ–™åº«ï¼ˆä¸é˜»å¡é¦–é é¡¯ç¤ºï¼‰
                try {
                    await initDatabase();
                    // æª¢æŸ¥æ˜¯å¦æœ‰è³‡æ–™
                    if (db && db.objectStoreNames.contains('members')) {
                        const transaction = db.transaction(['members'], 'readonly');
                        const store = transaction.objectStore('members');
                        const countRequest = store.count();
                        
                        countRequest.onsuccess = () => {
                            if (countRequest.result > 0) {
                                console.log('âœ… è³‡æ–™åº«å·²æœ‰è³‡æ–™');
                            }
                        };
                    }
                } catch (dbError) {
                    console.warn('è³‡æ–™åº«åˆå§‹åŒ–è­¦å‘Šï¼ˆä¸å½±éŸ¿ä½¿ç”¨ï¼Œå¯ä»¥é»æ“Šè¼‰å…¥è³‡æ–™åº«æŒ‰éˆ•ï¼‰:', dbError.message || dbError);
                    // ä¸é¡¯ç¤ºéŒ¯èª¤ï¼Œè®“ç”¨æˆ¶å¯ä»¥é»æ“Šè¼‰å…¥è³‡æ–™åº«æŒ‰éˆ•
                }
            } catch (error) {
                console.error('åˆå§‹åŒ–å¤±æ•—:', error);
                // å³ä½¿å‡ºéŒ¯ä¹Ÿé¡¯ç¤ºé¦–é 
                document.getElementById('db-loader').classList.remove('active');
                document.getElementById('main-content').classList.remove('hidden');
                showHomePage();
            }
        });
    </script>
</body>
</html>

