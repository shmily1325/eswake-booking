# 指定課價格設定指南

> 更新日期：2025-11-25  
> 功能：為每位教練設定指定課價格，扣款時自動帶入

---

## 📋 功能說明

### 問題背景
之前指定課扣款時，需要手動輸入金額，且不同教練的收費標準不同，容易出錯。

### 解決方案
在人員管理中為每位教練設定「30分鐘指定課價格」作為基準，系統會自動按比例計算其他時長的價格。

---

## 🚀 使用步驟

### 1. 設定教練價格（管理員操作）

1. 登入管理後台
2. 進入「人員管理」
3. 切換到「💰 指定課價格」tab
4. 為每位教練設定 30 分鐘指定課價格（例如：1000元）

**範例**：
- Anita 教練：30分 = $1000
- 小明教練：30分 = $1200
- 小華教練：未設定（扣款時使用自訂輸入框）

### 2. 教練回報時選擇指定課

教練在回報預約時：
1. 新增參與者
2. 教學方式選擇「指定（需收費）」
3. 收費方式選擇（扣儲值/票券/現金等）
4. 提交回報

### 3. 扣款時自動帶入價格

當處理扣款時：
- 系統會自動新增兩筆扣款項目：
  1. 根據收費方式的扣款（如：扣儲值）
  2. 指定課扣款（標注【指定課】）

- 如果該教練有設定價格：
  - 顯示金額按鈕（20分、30分、40分、60分、90分）
  - 每個按鈕上方顯示對應分鐘數
  - 自動帶入對應時長的金額

- 如果該教練未設定價格：
  - 顯示自訂輸入框
  - 需要手動輸入金額

---

## 💰 價格換算規則

### 基準價格
以 30 分鐘為基準設定價格。

### 自動換算公式（無條件進位）
```
其他時長價格 = 無條件進位(30分鐘價格 × (實際分鐘數 ÷ 30))
```

### 範例
假設教練的 30 分鐘價格設定為 $1200：

| 時長 | 計算方式 | 價格 |
|------|---------|------|
| 20分 | ⌈1200 × (20 ÷ 30)⌉ | $800 |
| 30分 | ⌈1200 × (30 ÷ 30)⌉ | $1200 |
| 40分 | ⌈1200 × (40 ÷ 30)⌉ | $1600 |
| 60分 | ⌈1200 × (60 ÷ 30)⌉ | $2400 |
| 90分 | ⌈1200 × (90 ÷ 30)⌉ | $3600 |

*註：系統使用**無條件進位法**（`Math.ceil`），例如 $1000 / 30 × 25 = $833.33... → $834*

---

## 🔄 完整流程示範

### 情境：Anita 教練教了一堂 60 分鐘的 G23 指定課

#### 步驟 1：設定價格（首次設定）
```
人員管理 → 指定課價格 → 選擇 Anita → 設定 30分 = $1000
```

#### 步驟 2：教練回報
```
教練：Anita
參與者：林敏2號（會員）
教學方式：指定（需收費） ← 關鍵選擇
收費方式：扣儲值
時長：60分
```

#### 步驟 3：扣款處理
系統自動產生兩筆扣款：

**第 1 筆：扣儲值**
- 類別：💰 儲值
- 金額：$10800（G23 60分）
- 說明：G23 60分 Anit教練 (林敏2號)

**第 2 筆：指定課**
- 類別：🎓 指定課時數
- 金額：$2000（自動帶入，因為 60分 = 1000 × 2）
- 說明：【指定課】G23 60分 Anita教練 (林敏2號)

**餘額變化**：
```
儲值：$15000 → $4200（扣 $10800）
```

---

## ⚙️ 技術實現

### 資料庫變更

**Migration 文件**：`migrations/add_designated_lesson_price.sql`

```sql
-- 新增欄位
ALTER TABLE coaches 
ADD COLUMN IF NOT EXISTS designated_lesson_price_30min INTEGER;

-- 註解
COMMENT ON COLUMN coaches.designated_lesson_price_30min 
IS '指定課價格（30分鐘，單位：元）';
```

### 組件修改

**StaffManagement.tsx**
- 新增「指定課價格」tab
- 價格設定界面
- 顯示換算參考

**PendingDeductionItem.tsx**
- 載入教練價格資訊
- 自動計算指定課金額
- 顯示對應價格按鈕

---

## 📝 注意事項

### 1. 價格設定
- 價格必須是正整數（不支持小數）
- 建議以 30 分鐘為單位設定方便換算
- 可以隨時修改或清除價格設定

### 2. 扣款處理
- 如果教練未設定價格，仍可使用自訂輸入框
- 指定課可以扣金額，也可以扣時數（手動切換）
- 說明欄位會自動標注【指定課】

### 3. 相容性
- 舊的扣款記錄不受影響
- 未設定價格的教練不影響扣款流程
- 可以部分教練設定價格，其他教練不設定

---

## 🔍 常見問題

### Q1：為什麼選擇 30 分鐘作為基準？
A：30 分鐘是最常見的課程時長，且方便換算（20分、40分、60分、90分都是 30 的倍數或分數）。

### Q2：如果教練的價格改了，歷史記錄會變嗎？
A：不會。交易記錄在扣款時就已經固定，修改價格只影響未來的扣款。

### Q3：可以為不同船隻設定不同價格嗎？
A：目前版本不支持。所有船隻的指定課使用相同價格。如有需要，可手動調整。

### Q4：如果選錯了指定課怎麼辦？
A：在扣款界面可以：
- 刪除第二筆（指定課）扣款項目
- 或手動修改金額
- 或修改類別

### Q5：教練沒有設定價格怎麼辦？
A：扣款時會顯示自訂輸入框，可以手動輸入金額或時數。

---

## 🎯 最佳實踐

1. **統一定價**：建議為所有活躍教練設定價格，保持一致性
2. **定期檢查**：定期檢查價格設定是否符合當前收費標準
3. **及時更新**：如果調整收費標準，記得更新教練價格
4. **清晰溝通**：確保教練知道自己的指定課價格

---

## 📞 技術支援

如有問題或需要調整，請聯繫開發團隊。

**最後更新**：2025-11-25

