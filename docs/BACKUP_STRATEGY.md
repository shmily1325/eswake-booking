# 📦 ESWake 预约系统 - 备份与灾难恢复策略

## 🎯 备份目标

1. **数据安全**：防止数据丢失
2. **灾难恢复**：在网页和数据库挂掉时，能够：
   - 查询预约记录
   - 查询会员财务数据（余额、时数、交易记录）
   - 处理新的预约（手动记录）
   - 核对账目

## 📋 备份方案

### 方案一：完整数据库备份（SQL格式）⭐ 推荐

**用途**：完整恢复数据库

**特点**：
- ✅ 包含所有表和数据
- ✅ 可以直接导入 PostgreSQL/Supabase
- ✅ 适合完整恢复

**使用方法**：
1. 在备份页面点击「完整数据库备份」
2. 下载 `.sql` 文件
3. 保存到 WD MY BOOK 硬盘
4. 恢复时：在 Supabase SQL Editor 执行 SQL 文件

**API端点**：`/api/backup-full-database`

---

### 方案二：可查询备份（JSON格式）⭐ 推荐用于查询

**用途**：在系统故障时查询数据

**特点**：
- ✅ 轻量级，易于查询
- ✅ 可以用任何文本编辑器或 Excel 打开
- ✅ 包含关键表：会员、预约、交易、教练、船只
- ✅ 可以用简单的 JavaScript 工具查询

**使用方法**：
1. 在备份页面点击「可查询备份」
2. 下载 `.json` 文件
3. 保存到 WD MY BOOK 硬盘
4. 使用查询工具（见下方）查询数据

**API端点**：`/api/backup-queryable`

---

### 方案三：CSV 导出（现有功能）

**用途**：Excel 分析和查看

**特点**：
- ✅ 可以用 Excel 打开
- ✅ 方便筛选和排序
- ✅ 适合对账和报表

**使用方法**：
1. 在备份页面选择导出类型
2. 点击「导出 CSV 文件」
3. 保存到 WD MY BOOK 硬盘

---

### 方案四：Google Sheets 自动备份（现有功能）

**用途**：云端备份和查看

**特点**：
- ✅ 自动每日备份
- ✅ 云端存储，不占用本地空间
- ✅ 可以多人查看

**使用方法**：
- 系统自动每日备份（UTC 19:20）
- 也可以手动点击「备份到 Google Sheets」

---

## 🔄 备份频率建议

| 备份类型 | 频率 | 存储位置 | 保留时间 | 自动化 |
|---------|------|---------|---------|--------|
| 完整数据库备份 | 每周一次 | WD MY BOOK | 3个月 | ✅ 支持（见下方） |
| 可查询备份 | 每天一次 | WD MY BOOK | 1个月 | 手动 |
| CSV 导出 | 按需 | WD MY BOOK | 根据需要 | 手动 |
| Google Sheets | 每天自动 | Google Drive | 永久 | ✅ 自动 |

---

## 🤖 自动备份到 WD MY BOOK

### 快速设置（推荐）

1. **运行设置脚本**：
   ```powershell
   # 在 PowerShell 中运行（以管理员身份）
   .\scripts\setup-auto-backup.ps1
   ```

2. **按照向导配置**：
   - 输入 Vercel 部署地址
   - 选择 WD MY BOOK 硬盘盘符
   - 设置备份保留天数
   - 测试备份
   - 创建 Windows 任务计划程序任务

3. **完成！** 系统将每天自动备份到 WD MY BOOK

### 手动设置

详细步骤请参考：[自动备份设置指南](../scripts/README_AUTO_BACKUP.md)

---

## 📅 备份频率建议（更新）

---

## 🚨 灾难恢复流程

### 场景：网页和数据库都挂掉了

#### 步骤 1：确认备份文件

1. 打开 WD MY BOOK 硬盘
2. 找到最新的备份文件：
   - `eswake_backup_YYYY-MM-DDTHH-MM-SS.sql`（完整备份）
   - `eswake_queryable_backup_YYYY-MM-DDTHH-MM-SS.json`（可查询备份）

#### 步骤 2：使用可查询备份查询数据

**方法 A：使用在线查询工具**

1. 打开 `backup-query-tool.html`（见下方）
2. 选择备份 JSON 文件
3. 查询预约、会员、交易等数据

**方法 B：使用 Excel**

1. 用 Excel 打开 CSV 备份文件
2. 使用筛选和查找功能查询

**方法 C：使用文本编辑器**

1. 用文本编辑器打开 JSON 备份
2. 使用搜索功能查找（Ctrl+F）

#### 步骤 3：处理新预约（手动记录）

如果系统故障期间有新预约：

1. 在 Excel 或 Google Sheets 中手动记录：
   - 预约人姓名
   - 预约日期和时间
   - 船只
   - 教练
   - 备注

2. 系统恢复后，手动录入这些预约

#### 步骤 4：恢复数据库（如果可能）

1. 登录 Supabase Dashboard
2. 进入 SQL Editor
3. 执行最新的完整备份 SQL 文件
4. 验证数据完整性

---

## 🛠️ 查询工具

### 离线查询工具（HTML）

创建一个简单的 HTML 文件，可以在浏览器中打开，无需网络连接：

**文件位置**：`public/backup-query-tool.html`

**功能**：
- 上传 JSON 备份文件
- 查询预约记录
- 查询会员信息
- 查询交易记录
- 导出查询结果为 CSV

---

## 💾 NAS 推荐（可选升级）

如果 WD MY BOOK 不够用，可以考虑 NAS：

### 入门级 NAS（适合小型业务）

1. **Synology DS220+**（约 $300-400）
   - 2 盘位
   - 支持自动备份
   - 可以设置定时备份任务
   - 支持 RAID 1（数据镜像）

2. **QNAP TS-231P3**（约 $200-300）
   - 2 盘位
   - 性价比高
   - 支持多种备份方式

### 中端 NAS（适合成长型业务）

1. **Synology DS720+**（约 $500-600）
   - 2 盘位，可扩展
   - 性能更强
   - 支持 Docker（可以运行备份脚本）

2. **QNAP TS-453D**（约 $500-600）
   - 4 盘位
   - 支持更多存储

### NAS 优势

- ✅ 自动备份：可以设置定时任务自动备份
- ✅ 数据冗余：RAID 1 镜像，一块硬盘坏了数据还在
- ✅ 远程访问：可以在任何地方访问备份
- ✅ 版本控制：可以保留多个版本的备份
- ✅ 共享访问：多人可以访问备份文件

### NAS 设置建议

1. **RAID 配置**：使用 RAID 1（镜像），数据更安全
2. **备份计划**：
   - 每天自动备份到 NAS
   - 每周备份到云端（Google Drive）
3. **访问控制**：设置密码和权限
4. **监控**：设置邮件通知，硬盘故障时提醒

---

## 📝 备份检查清单

### 每周检查

- [ ] 确认完整数据库备份已执行
- [ ] 检查备份文件大小是否正常
- [ ] 验证备份文件可以打开
- [ ] 检查 WD MY BOOK 硬盘空间

### 每月检查

- [ ] 测试恢复流程（在测试环境）
- [ ] 清理旧备份文件（保留3个月）
- [ ] 检查 Google Sheets 备份是否正常
- [ ] 更新备份策略文档

---

## 🔐 安全建议

1. **加密备份**：敏感数据建议加密存储
2. **多地点备份**：本地 + 云端 + 异地
3. **定期测试恢复**：确保备份可以正常恢复
4. **访问控制**：备份文件设置密码保护
5. **版本管理**：保留多个版本的备份

---

## 📞 紧急联系

如果遇到备份或恢复问题：

1. 检查 Supabase Dashboard 状态
2. 查看 Vercel 函数日志
3. 联系技术支持

---

## 📚 相关文档

- [数据库设置指南](./DATABASE_SETUP_GUIDE.md)
- [Google Sheets 备份设置](./BACKUP_SETUP.md)

