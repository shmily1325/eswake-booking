# 扣款流程優化實現記錄

> 實現日期：2025-11-25

## 📋 優化項目總覽

本次優化實現了以下三個主要功能：

1. ✅ **多筆扣款的總覽卡片**
2. ✅ **資料驗證和錯誤提示**
3. ✅ **UI/UX 細節優化（價格未設定警告）**

---

## 🎯 功能詳細說明

### 1. 多筆扣款的總覽卡片

**位置**：`src/components/PendingDeductionItem.tsx`

**功能描述**：
- 當有多筆扣款項目時，在扣款明細列表下方顯示總覽卡片
- 自動計算所有扣款對各類別餘額的累積影響
- 清晰顯示：期初值 → 期末值

**顯示內容**：
```
📊 扣款總覽
━━━━━━━━━━━━━━━━━━━━━━━━━
💰 儲值      $10,000 → $7,333
⛵ G21/黑豹券  60分 → 0分
```

**實現細節**：
- 自動過濾「直接結清」項目
- 自動過濾「方案」項目（方案不扣款）
- 自動累積同類別的多筆扣款
- 動態計算期初值和期末值
- 負數餘額會以紅色顯示（但不會阻擋扣款）

**適用情況**：
- 船費 + 指定課（2筆扣款）
- 多筆自訂扣款
- 混合使用不同類別（如：儲值 + 船券）

---

### 2. 資料驗證和錯誤提示

**位置**：`src/components/PendingDeductionItem.tsx`

**功能描述**：
在點擊「✅ 確認扣款」時，系統會自動驗證所有扣款項目：

#### 驗證規則

| 項目 | 驗證條件 | 錯誤訊息 |
|------|----------|----------|
| 金額（儲值/VIP） | 必須 > 0 | 「請輸入有效的金額」 |
| 時數（船券/指定課等） | 必須 > 0 | 「請輸入有效的時數」 |
| 方案名稱 | 方案類別必須填寫 | 「方案類別必須填寫方案名稱」 |
| 說明 | 必須填寫 | 「請輸入說明」 |

#### 錯誤提示機制

1. **即時提示**：
   - 錯誤欄位會標紅（紅色邊框）
   - 欄位下方顯示紅色錯誤訊息
   - 錯誤訊息格式：`⚠️ [錯誤原因]`

2. **自動滾動**：
   - 驗證失敗時，自動滾動到第一個錯誤項目
   - 使用平滑滾動動畫
   - 確保錯誤項目位於視窗中央

3. **自動清除**：
   - 當用戶修正錯誤後，錯誤提示自動消失

#### 使用情境範例

**情境 A：方案忘記填寫名稱**
```
用戶操作：
1. 切換為「⭐ 方案」
2. 未填寫方案名稱
3. 點擊「確認扣款」

系統反應：
❌ 阻止提交
⚠️ 方案名稱欄位標紅
⚠️ 顯示：「方案類別必須填寫方案名稱」
🎯 自動滾動到該項目
```

**情境 B：自訂金額未填寫**
```
用戶操作：
1. 使用「✏️ 自訂」輸入框
2. 未填寫或填入 0
3. 點擊「確認扣款」

系統反應：
❌ 阻止提交
⚠️ 金額欄位下方顯示錯誤
⚠️ 顯示：「請輸入有效的金額」
```

---

### 3. 價格未設定的警告提示

**位置**：`src/components/PendingDeductionItem.tsx`

**功能描述**：
當選擇扣儲值/VIP票券/指定課時，如果相關價格未設定，會顯示明顯的警告提示。

#### 觸發條件

| 扣款類別 | 檢查項目 | 警告內容 |
|----------|----------|----------|
| 💰 儲值 | 船隻的 `balance_price_per_hour` | 「此船隻的儲值價格尚未設定」 |
| 💎 VIP票券 | 船隻的 `vip_price_per_hour` | 「此船隻的VIP票券價格尚未設定」 |
| 🎓 指定課 | 教練的 `designated_lesson_price_30min` | 「此教練的指定課價格尚未設定」 |

#### 警告樣式

```
⚠️ 價格尚未設定
━━━━━━━━━━━━━━━━━━━━━━━━━
此船隻的儲值價格尚未設定，請在船隻管理
頁面設定價格，或使用自訂輸入框。
```

**視覺特徵**：
- 黃色漸層背景（`#fff9e6` → `#fef3c7`）
- 金黃色邊框（`#fbbf24`）
- 大型警告圖示（⚠️）
- 清晰的文字說明和操作指引

#### 使用者體驗

1. **不阻擋操作**：
   - 警告是提示性質，不阻止用戶操作
   - 用戶仍可使用「✏️ 自訂」輸入框手動填入金額

2. **引導設定**：
   - 明確告知在哪裡設定價格（船隻管理/人員管理）
   - 提供替代方案（使用自訂輸入框）

3. **即時顯示**：
   - 切換扣款類別後立即顯示警告
   - 無需等到提交時才發現

---

## 🎨 視覺改進

### 總覽卡片設計

**配色**：
- 背景：淡藍色漸層（`#f0f9ff` → `#e0f2fe`）
- 邊框：天藍色（`#bae6fd`）
- 標題顏色：深藍色（`#0369a1`）
- 內容背景：白色卡片

**排版**：
- 清晰的標題區（📊 扣款總覽）
- 每個類別獨立卡片
- 左側：類別名稱（emoji + 文字）
- 右側：數值變化（期初 → 期末）
- 箭頭視覺引導（→）

### 錯誤提示設計

**配色**：
- 背景：淡紅色（`#fef2f2`）
- 邊框：紅色（`#fecaca`）
- 文字：深紅色（`#dc2626`）
- 錯誤欄位邊框：紅色（`2px solid #dc2626`）

**排版**：
- 警告圖示（⚠️）+ 錯誤訊息
- 緊貼在錯誤欄位下方（`marginTop: 8px`）
- 圓角設計（`borderRadius: 6px`）

### 價格警告設計

**配色**：
- 背景：淡黃色漸層（`#fff9e6` → `#fef3c7`）
- 邊框：金黃色（`2px solid #fbbf24`）
- 標題：深棕色（`#92400e`）
- 內容：棕色（`#b45309`）

**排版**：
- 大型警告圖示（18px）
- 兩行文字（標題 + 說明）
- 左側圖示 + 右側文字區塊

---

## 📊 效果對比

### 優化前

❌ 多筆扣款時，需要逐一查看每個項目的餘額變化
❌ 送出後才發現資料不完整，需要重新填寫
❌ 價格未設定時，沒有預設金額按鈕，容易困惑
❌ 沒有明確的錯誤提示位置

### 優化後

✅ 一個總覽卡片清楚顯示所有扣款的累積影響
✅ 送出前自動驗證，即時顯示錯誤位置
✅ 價格未設定時，顯示明顯警告和操作指引
✅ 錯誤提示緊貼在問題欄位下方，一目了然
✅ 自動滾動到第一個錯誤項目，快速定位問題

---

## 🔧 技術實現細節

### 1. 狀態管理

```typescript
// 新增驗證錯誤狀態
const [validationErrors, setValidationErrors] = useState<Record<string, string>>({})
```

### 2. 驗證邏輯

```typescript
const validateItems = (): boolean => {
  const errors: Record<string, string> = {}
  
  items.forEach((item, index) => {
    const itemKey = `item-${index}`
    
    // 檢查金額/時數
    if (item.category === 'balance' || item.category === 'vip_voucher') {
      if (!item.amount || item.amount <= 0) {
        errors[`${itemKey}-amount`] = '請輸入有效的金額'
      }
    }
    
    // 檢查方案名稱
    if (item.category === 'plan' && !item.planName?.trim()) {
      errors[`${itemKey}-planName`] = '方案類別必須填寫方案名稱'
    }
    
    // ... 其他驗證
  })
  
  setValidationErrors(errors)
  return Object.keys(errors).length === 0
}
```

### 3. 錯誤自動清除

```typescript
onUpdate={(updates) => {
  updateItem(item.id, updates)
  // 清除該項目的錯誤
  const newErrors = { ...validationErrors }
  Object.keys(newErrors).forEach(key => {
    if (key.startsWith(`item-${index}-`)) {
      delete newErrors[key]
    }
  })
  setValidationErrors(newErrors)
}}
```

### 4. 自動滾動

```typescript
// 滾動到第一個錯誤項目
const firstErrorKey = Object.keys(errors)[0]
const itemIndex = parseInt(firstErrorKey.split('-')[1])
const element = document.getElementById(`deduction-item-${itemIndex}`)
if (element) {
  element.scrollIntoView({ behavior: 'smooth', block: 'center' })
}
```

### 5. 價格檢查

```typescript
// 檢查價格設定
const isPriceNotSet = (isBalance || isVipVoucher) && (
  (isBalance && !boatData?.balance_price_per_hour) ||
  (isVipVoucher && !boatData?.vip_price_per_hour)
)
const isCoachPriceNotSet = (isDesignatedLesson || isDesignatedLessonFromBalance) && !coachPrice30min
```

---

## 📱 響應式設計

所有新增的 UI 組件都考慮了響應式設計：

- 使用彈性佈局（flexbox）
- 文字大小適中（13-14px）
- 間距合理（8-16px）
- 移動端友好（圓角、陰影、觸控區域）

---

## ⚠️ 注意事項

1. **不阻擋負數餘額**：
   - 總覽卡片會顯示負數（紅色），但不會阻止扣款
   - 系統允許負數餘額

2. **直接結清不驗證**：
   - 選擇「✅ 直接結清」時，不進行資料驗證
   - 直接標記為已處理

3. **方案類別特殊處理**：
   - 方案類別必須填寫方案名稱
   - 方案不會出現在總覽卡片中（因為不扣款）

4. **價格警告不阻止操作**：
   - 警告是提示性質，不阻止用戶使用自訂輸入框

---

## 🚀 未來擴展建議

1. **批量處理（已取消）**：
   - 用戶表示暫時不需要

2. **餘額不足預警（已取消）**：
   - 用戶表示不需要預警

3. **可撤銷機制**：
   - 扣款完成後 5 秒內可撤銷
   - 記錄操作日誌

4. **方案管理系統**：
   - 建立方案管理頁面
   - 追蹤方案使用次數
   - 自動檢查方案有效期

5. **交易說明模板**：
   - 常用說明快速選擇
   - 自訂模板儲存

---

## 📝 更新記錄

| 日期 | 版本 | 更新內容 |
|------|------|----------|
| 2025-11-25 | 1.0.0 | 初始版本：總覽卡片、驗證機制、價格警告 |

---

**文件維護者**：AI Assistant
**最後更新**：2025-11-25

