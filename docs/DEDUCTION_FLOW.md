# 扣款邏輯完整說明

> 最後更新：2025-11-25

## 📋 概述

當教練完成回報後，系統會根據**付款方式**、**船隻類型**、**是否為指定課**等條件，自動生成相應的扣款項目。報帳人員可以根據實際情況調整扣款內容，給予最大彈性。

---

## 🔍 核心設計原則

### 1. 動態定價
所有價格從資料庫配置讀取，不硬編碼：

| 項目 | 設定位置 | 欄位 | 計算方式 |
|------|----------|------|----------|
| 船隻儲值價格 | 船隻管理 | `balance_price_per_hour` | `Math.ceil(price * minutes / 60)` |
| 船隻 VIP 價格 | 船隻管理 | `vip_price_per_hour` | `Math.ceil(price * minutes / 60)` |
| 指定課價格 | 人員管理 | `designated_lesson_price_30min` | `Math.ceil(price * minutes / 30)` |

### 2. 教練回報 vs 報帳處理

**教練端**：
- 只回報實際發生的情況
- 選擇付款方式（voucher, balance, cash, transfer）
- 標記是否為指定課

**報帳端**：
- 根據教練回報生成預設扣款
- 可以完全調整扣款內容
- 最終決定如何處理金流

### 3. 完全彈性
- ✅ 可切換扣款類別
- ✅ 可自訂金額
- ✅ 可新增/刪除扣款項目（無限制）
- ✅ 可選擇直接結清（不扣款）

---

## 🎯 扣款邏輯流程

### 情境 A：現金/匯款結清

**條件：**
- `payment_method = 'cash'` 或 `'transfer'`

**行為：**
- ✅ 顯示「✓ 直接結清」按鈕（預設）
- ✅ 不生成扣款項目
- ✅ 點擊確認後標記為已處理

**說明：**
現金/匯款的金流不在系統內處理（未來可能擴充）

---

### 情境 B：一般船隻（非彈簧床）

**條件：**
- 船隻不是彈簧床
- `payment_method` 不是 cash/transfer

**扣款項目：**

#### 第 1 筆：船費（必定有）

根據 `payment_method` 決定預設類別：

| payment_method | 預設類別 | 金額/時數 | 來源 |
|----------------|----------|-----------|------|
| `voucher` | 船券（G23/G21/黑豹） | 時數（分鐘） | 根據船名判斷 |
| `balance` | 💰 儲值 | 金額（元） | 船隻的 `balance_price_per_hour` |
| 其他 | 根據船隻判斷 | - | - |

**儲值金額計算：**
```javascript
金額 = Math.ceil(balance_price_per_hour * 實際分鐘數 / 60)

例：balance_price_per_hour = 10800
    實際時長 = 60 分鐘
    金額 = Math.ceil(10800 * 60 / 60) = 10,800 元
```

**VIP 票券（用戶可選）：**
- 不在教練回報選項中
- 報帳時可以將第 1 筆切換為「💎 VIP票券」
- 從船隻的 `vip_price_per_hour` 計算金額
- 計算方式同儲值

#### 第 2 筆：指定課費用（如適用）

**條件：**
- `lesson_type = 'designated_paid'`（指定課需收費）

**扣款內容：**
- **類別**：💰 儲值（`balance`）
- **金額**：從教練的 `designated_lesson_price_30min` 計算
- **說明**：帶【指定課】標記

**指定課金額計算：**
```javascript
金額 = Math.ceil(designated_lesson_price_30min * 實際分鐘數 / 30)

例：designated_lesson_price_30min = 1000
    實際時長 = 60 分鐘
    金額 = Math.ceil(1000 * 60 / 30) = 2,000 元
```

---

### 情境 C：彈簧床

**特殊規則：彈簧床不是船，不收船費**

#### C1：免費指定課

**條件：**
- 船隻名稱包含「彈簧床」
- `lesson_type = 'designated_free'`

**行為：**
- ✅ 顯示「✓ 直接結清」按鈕（預設）
- ✅ 標記為「🎓 指定課不收費」

#### C2：需收費指定課

**條件：**
- 船隻名稱包含「彈簧床」
- `lesson_type = 'designated_paid'`
- `payment_method` 不是 cash/transfer

**扣款項目：**
- ✅ **只有 1 筆**：指定課費用（從儲值扣）
- ❌ **不扣**：船費

---

### 情境 D：使用方案

**什麼是方案？**
- 預付方案（如：9999暢滑方案）
- 已付費，不需要再扣船費
- 可能包含或不包含指定課

**教練端：**
- 不需要處理方案
- 正常選擇付款方式即可（通常選 `voucher` 或 `balance`）

**報帳端處理：**

1. **切換第 1 筆為「⭐ 方案」**
   - 類別：⭐ 方案
   - 方案名稱：自訂（例：9999暢滑方案）
   - 金額：$0（不扣款，僅記錄）

2. **處理指定課**
   - 方案包含指定課 → 刪除第 2 筆指定課扣款
   - 方案不包含 → 保留第 2 筆指定課扣款

**範例：**
```
教練回報：payment_method = 'voucher'

預設扣款：
├─ 第 1 筆：🚤 G21/黑豹券 60分
└─ 第 2 筆：💰 儲值 $2,000（指定課）

用戶調整（方案包含指定課）：
└─ 第 1 筆：⭐ 方案（9999暢滑方案）$0

或（方案不包含指定課）：
├─ 第 1 筆：⭐ 方案（9999暢滑方案）$0
└─ 第 2 筆：💰 儲值 $2,000（指定課）
```

---

## 🔄 扣款項目類別

| 類別 | 代碼 | 扣款對象 | 單位 | 說明 |
|------|------|----------|------|------|
| 儲值 | `balance` | 會員儲值金 | 元 | 從船隻或教練價格計算 |
| VIP票券 | `vip_voucher` | VIP票券金額 | 元 | 從船隻 VIP 價格計算 |
| G23船券 | `boat_voucher_g23` | G23船券時數 | 分鐘 | 扣時數 |
| G21/黑豹券 | `boat_voucher_g21_panther` | G21/黑豹船券時數 | 分鐘 | 扣時數 |
| 指定課時數 | `designated_lesson` | 指定課時數 | 分鐘 | 扣時數（較少用） |
| 方案 | `plan` | 無（記錄用） | - | 不扣款，記錄方案使用 |
| 贈送時數 | `gift_boat_hours` | 贈送大船時數 | 分鐘 | 扣時數 |
| 直接結清 | - | 無 | - | 不扣款，直接標記已處理 |

---

## 💰 價格配置與計算

### 船隻價格設定（船隻管理頁面）

```sql
boats 表欄位：
- balance_price_per_hour: INTEGER    -- 儲值價格（每小時，元）
- vip_price_per_hour: INTEGER        -- VIP票券價格（每小時，元）
```

**設定範例：**
| 船隻 | 儲值（元/小時） | VIP票券（元/小時） |
|------|----------------|-------------------|
| G23 | 10,800 | 8,500 |
| G21 黑豹 | 6,000 | 5,000 |
| 粉紅 200 | 3,600 | - |

### 指定課價格設定（人員管理頁面）

```sql
coaches 表欄位：
- designated_lesson_price_30min: INTEGER    -- 指定課價格（30分鐘，元）
```

**設定範例：**
| 教練 | 30分鐘價格 |
|------|-----------|
| 阿寶 | 1,000 |
| Jerry | 1,200 |

### 計算公式

#### 船隻費用（儲值/VIP）
```javascript
金額 = Math.ceil(每小時價格 * 實際分鐘數 / 60)
```

**範例：**
| 設定 | 時長 | 計算過程 | 結果 |
|------|------|----------|------|
| $10,800/小時 | 30分 | ceil(10800 * 30 / 60) | **$5,400** |
| $10,800/小時 | 40分 | ceil(10800 * 40 / 60) | **$7,200** |
| $10,800/小時 | 60分 | ceil(10800 * 60 / 60) | **$10,800** |
| $6,000/小時 | 20分 | ceil(6000 * 20 / 60) | **$2,000** |

#### 指定課費用
```javascript
金額 = Math.ceil(30分鐘價格 * 實際分鐘數 / 30)
```

**範例：**
| 設定 | 時長 | 計算過程 | 結果 |
|------|------|----------|------|
| $1,000/30分 | 20分 | ceil(1000 * 20 / 30) | **$667** |
| $1,000/30分 | 30分 | ceil(1000 * 30 / 30) | **$1,000** |
| $1,000/30分 | 60分 | ceil(1000 * 60 / 30) | **$2,000** |

### 未設定價格時
- ❌ 不顯示預設金額按鈕
- ✅ 只顯示「✏️ 自訂」輸入框

---

## 🚀 操作指南

### 管理員：設定船隻價格

1. 登入管理後台
2. 進入「船隻管理」頁面
3. 點擊「💰 價格設定」tab
4. 為每艘船設定：
   - **儲值價格（每小時）**：會員扣儲值時使用
   - **VIP票券價格（每小時）**：VIP票券扣款時使用
5. 查看即時預覽（20/30/40/60/90分的價格）
6. 點擊「💾 儲存價格」

**注意事項：**
- 彈簧床不收船費，可不設定
- 粉紅船通常沒有VIP價格
- 價格可隨時調整，即時生效

### 管理員：設定指定課價格

1. 登入管理後台
2. 進入「人員管理」頁面
3. 點擊「💰 指定課價格」tab
4. 為每位教練設定「30分鐘指定課價格」
   - 例如：阿寶 → 1000元/30分
5. 系統會自動按比例計算其他時長
6. 點擊「儲存」

**注意事項：**
- 只需設定30分鐘的價格，其他時長自動計算
- 未設定價格的教練會顯示自訂輸入框
- 每位教練可以有不同價格

### 教練：完成回報

教練只需要回報實際發生的情況：

1. 選擇參與者（會員或非會員）
2. 選擇教學方式：
   - **不指定**：一般教學
   - **指定（需收費）**：指定教練且需額外收費
   - **指定（不收費）**：指定教練但不收費（例如彈簧床）
3. 選擇付款方式：
   - **扣儲值** (balance)
   - **船券** (voucher)
   - **現金** (cash)
   - **匯款** (transfer)
4. 提交回報

**注意事項：**
- 不需要處理方案或VIP票券（這些由報帳人員處理）
- 現金/匯款會在報帳時直接結清
- 彈簧床免費指定課系統會自動識別

### 報帳人員：處理扣款

1. **查看待處理清單**
   - 進入「報帳處理」頁面
   - 查看所有待處理的回報

2. **檢查預設扣款**
   - 系統會根據教練回報自動生成預設扣款
   - 確認金額、類別、時數是否正確

3. **調整扣款（如需要）**
   - **切換類別**：點擊下拉選單選擇其他類別
   - **調整金額**：點擊金額按鈕或使用自訂輸入框
   - **新增項目**：點擊「➕ 新增扣款項目」
   - **刪除項目**：點擊「刪除」按鈕
   - **直接結清**：切換為「✅ 直接結清」

4. **處理方案**
   - 將第1筆切換為「⭐ 方案」
   - 填寫方案名稱（例如：9999暢滑方案）
   - 如果方案包含指定課，刪除指定課扣款項目

5. **確認扣款**
   - 檢查所有項目無誤
   - 點擊「✅ 確認扣款」
   - 系統會自動更新會員餘額並記錄交易

**常見情況處理：**

| 情況 | 處理方式 |
|------|----------|
| 用 VIP 票券付費 | 切換第1筆為「💎 VIP票券」 |
| 使用暢滑方案 | 切換第1筆為「⭐ 方案」，填寫方案名稱 |
| 現金結清 | 預設已是「✅ 直接結清」，直接確認 |
| 指定課免費 | 刪除指定課扣款項目或切換為直接結清 |
| 金額錯誤 | 使用「✏️ 自訂」輸入正確金額 |
- 💡 理論上都會設定好價格

---

## 📝 說明文字格式

### 基本格式
```
{【指定課】}{日期 時間} {船隻} {時長}分 {教練}教練 {(非會員：XXX)}
```

### 會員預約
```
2025-11-25 16:30 黑豹 60分 阿寶教練
```
> 💡 在會員帳戶下處理，不顯示會員名稱

### 指定課扣款
```
【指定課】2025-11-25 16:30 黑豹 60分 阿寶教練
```

### 非會員預約
```
2025-11-25 16:30 黑豹 60分 阿寶教練 (非會員：小王)
```
> 💡 只有非會員才顯示名稱，方便識別

---

## 🎛️ 用戶彈性操作

### 可調整項目

1. **切換扣款類別**
   - 從下拉選單選擇不同類別
   - 例：從船券切換為儲值、VIP、方案等

2. **自訂金額/時數**
   - 點擊「✏️ 自訂」按鈕
   - 手動輸入金額或時數

3. **新增扣款項目**
   - 點擊「➕ 新增項目」
   - 可無限新增，無限制

4. **刪除扣款項目**
   - 點擊刪除按鈕
   - 至少保留 1 筆（或可全部刪除選擇直接結清）

5. **直接結清**
   - 適用於所有情況（待實現 UI）
   - 不扣任何款項，直接標記已處理

6. **編輯說明文字**
   - 可修改交易說明
   - 例：加註「使用優惠券」、「特殊折扣」等

7. **編輯註解**
   - 可加入內部備註
   - 不會顯示在會員交易記錄中

---

## 📊 完整範例

### 範例 1：G21 黑豹，60分鐘，扣船券（會員：Ming）

**教練回報：**
- payment_method = 'voucher'
- lesson_type = 'undesignated'

**預設扣款：**
- 第 1 筆：🚤 G21/黑豹券 60 分鐘

**說明：**
```
2025-11-25 16:30 黑豹 60分 阿寶教練
```

---

### 範例 2：G23，60分鐘，扣儲值，指定課需收費（會員：Ming）

**教練回報：**
- payment_method = 'balance'
- lesson_type = 'designated_paid'

**預設扣款：**
- 第 1 筆：💰 儲值 $10,800（船費）
- 第 2 筆：💰 儲值 $2,000（指定課，假設教練價格 $1000/30分）

**說明：**
```
2025-11-25 16:30 G23 60分 阿寶教練
【指定課】2025-11-25 16:30 G23 60分 阿寶教練
```

---

### 範例 3：彈簧床，20分鐘，指定課需收費（會員：林敏2號）

**教練回報：**
- payment_method = 'balance'
- lesson_type = 'designated_paid'

**預設扣款：**
- 第 1 筆：💰 儲值 $667（只扣指定課，不扣船費）

**說明：**
```
【指定課】2025-11-25 03:15 彈簧床 20分 阿寶教練
```

---

### 範例 4：G21 黑豹，60分鐘，使用方案（會員：Ming）

**教練回報：**
- payment_method = 'voucher'
- lesson_type = 'designated_paid'

**預設扣款：**
- 第 1 筆：🚤 G21/黑豹券 60 分鐘
- 第 2 筆：💰 儲值 $2,000（指定課）

**用戶調整（方案包含指定課）：**
- 第 1 筆：⭐ 方案（9999暢滑方案）$0

**說明：**
```
2025-11-25 16:30 黑豹 60分 阿寶教練
```

**用戶調整（方案不包含指定課）：**
- 第 1 筆：⭐ 方案（9999暢滑方案）$0
- 第 2 筆：💰 儲值 $2,000（指定課）

**說明：**
```
2025-11-25 16:30 黑豹 60分 阿寶教練
【指定課】2025-11-25 16:30 黑豹 60分 阿寶教練
```

---

### 範例 5：G23，40分鐘，VIP票券（會員：Ming）

**教練回報：**
- payment_method = 'balance'
- lesson_type = 'undesignated'

**預設扣款：**
- 第 1 筆：💰 儲值 $7,200（船費）

**用戶調整為 VIP：**
- 第 1 筆：💎 VIP票券 $5,667（從船隻 vip_price_per_hour 計算）

**說明：**
```
2025-11-25 10:00 G23 40分 阿寶教練
```

---

## 🔄 完整流程圖（新版）

```
教練完成回報
  │
  ├─ 系統自動生成預設扣款介面
  │   │
  │   ├─ payment_method = cash/transfer
  │   │   → 預設：顯示「✅ 直接結清」（可切換為扣款）
  │   │
  │   ├─ 彈簧床 + lesson_type = designated_free
  │   │   → 預設：顯示「✅ 直接結清」（指定課不收費）
  │   │
  │   ├─ 彈簧床 + lesson_type = designated_paid
  │   │   → 預設：1 筆指定課扣款（從儲值，可調整/結清）
  │   │
  │   ├─ lesson_type = designated_paid（非彈簧床）
  │   │   → 預設：2 筆扣款
  │   │      1. 船費（根據 payment_method，從船隻表動態計算）
  │   │      2. 指定課費用（從儲值，根據教練價格計算）
  │   │
  │   └─ 一般預約
  │       → 預設：1 筆船費扣款（從船隻表動態計算）
  │
  └─ 用戶操作階段（所有情況統一）
      ├─ 可切換扣款類別（儲值/船券/VIP/方案/直接結清 等）
      ├─ 可調整金額/時數
      ├─ 可新增/刪除扣款項目
      ├─ 可編輯說明文字
      ├─ 可選擇「✅ 直接結清」（所有情況都可以）⭐
      │
      └─ 點擊「確認扣款」
          ├─ 有扣款項目 → 執行扣款 → 標記已處理 → 完成
          └─ 選擇直接結清 → 標記已處理 → 完成
```

### 💡 關鍵改進

1. **統一彈性**：所有情況都經過同一個用戶操作階段
2. **動態價格**：船費從資料庫 `boats` 表讀取，自動計算
3. **直接結清**：任何情況都可以選擇直接結清
4. **智能預設**：系統根據教練回報自動判斷合理的預設值

---

## 🛠️ 技術實現

### 資料庫欄位

**boats 表（船隻管理）：**
```sql
ALTER TABLE boats ADD COLUMN balance_price_per_hour INTEGER;
ALTER TABLE boats ADD COLUMN vip_price_per_hour INTEGER;

COMMENT ON COLUMN boats.balance_price_per_hour IS '儲值價格（每小時，元）';
COMMENT ON COLUMN boats.vip_price_per_hour IS 'VIP票券價格（每小時，元）';
```

**coaches 表（已存在）：**
```sql
-- 已有欄位
designated_lesson_price_30min INTEGER  -- 指定課價格（30分鐘，元）
```

### 金額計算函數

```typescript
// 船隻費用計算
function calculateBoatPrice(pricePerHour: number, minutes: number): number {
  return Math.ceil(pricePerHour * minutes / 60)
}

// 指定課費用計算
function calculateDesignatedLessonPrice(price30min: number, minutes: number): number {
  return Math.ceil(price30min * minutes / 30)
}
```

### 判斷是否為指定課扣款

```typescript
const isDesignatedLessonDeduction = 
  item.description?.includes('【指定課】')
```

---

## ⚠️ 注意事項

### 1. 價格設定
- 理論上所有船隻和教練都會設定好價格
- 未設定時只顯示自訂輸入框

### 2. 船券類型判斷
- 目前根據船名判斷（'G23', 'G21', '黑豹'）
- 未來可考慮在 boats 表加 `boat_voucher_type` 欄位

### 3. 方案管理
- 目前為人工管理（彈性最大）
- 不自動檢查方案狀態
- 未來可考慮建立方案管理系統

### 4. 扣款無限制
- 可新增任意筆數的扣款項目
- 可組合不同類別
- 給予最大彈性

### 5. 直接結清
- 所有情況都可選擇直接結清
- UI 設計待討論

---

## 🚀 待實現功能

### 1. 直接結清 UI
- [ ] 設計簡潔的「直接結清」選項
- [ ] 適用於所有扣款情況
- [ ] 不影響現有 UI 複雜度

### 2. 船隻管理價格設定
- [ ] 在船隻管理頁面新增價格欄位
- [ ] balance_price_per_hour
- [ ] vip_price_per_hour

### 3. 動態金額計算
- [ ] 從船隻表讀取價格
- [ ] 實時計算並顯示金額選項
- [ ] 替換現有硬編碼價格

### 4. 彈簧床指定課金額顯示
- [ ] 修復彈簧床指定課不顯示金額選項的問題
- [ ] 正確識別指定課扣款類型

---

最後更新：2025-11-25
